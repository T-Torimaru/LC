<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>CALIB: AngleTrackFinder.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_5116c8f7e4b5645f509e1533a2a6cce8.html">calice_calib</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_fea92f6f86d4acd59ef65c817f65f9e0.html">calib</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_7ade78cf69156e1229352c5e42492e10.html">src</a>
  </div>
</div>
<div class="contents">
<h1>AngleTrackFinder.cc</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &quot;AngleTrackFinder.hh&quot;</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;limits&gt;</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#include &quot;marlin/Exceptions.h&quot;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &quot;UTIL/CellIDDecoder.h&quot;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;MappingProcessor.hh&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;CellDescriptionProcessor.hh&quot;</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;AhcAmplitude.hh&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;ClusterOrdering.hh&quot;</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="keyword">using</span> std::cout;
<a name="l00016"></a>00016 <span class="keyword">using</span> std::endl;
<a name="l00017"></a>00017 <span class="keyword">using namespace </span>lcio;
<a name="l00018"></a>00018 <span class="keyword">using namespace </span>marlin;
<a name="l00019"></a>00019 <span class="keyword">using namespace </span>UTIL;
<a name="l00020"></a>00020 <span class="keyword">using namespace </span>EVENT;
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="keyword">namespace </span>CALICE 
<a name="l00023"></a>00023 {
<a name="l00024"></a>00024   
<a name="l00025"></a>00025   <a class="code" href="classCALICE_1_1AngleTrackFinder.html" title="Processor to extract MIP calibrations from muon beam runs.">AngleTrackFinder</a> <a class="code" href="classCALICE_1_1AngleTrackFinder.html" title="Processor to extract MIP calibrations from muon beam runs.">AngleTrackFinder</a>;
<a name="l00026"></a>00026   
<a name="l00027"></a>00027   <span class="comment">/******************************************************************************/</span>
<a name="l00028"></a>00028   <span class="comment">/*                                                                            */</span>
<a name="l00029"></a>00029   <span class="comment">/*                                                                            */</span>
<a name="l00030"></a>00030   <span class="comment">/*                                                                            */</span>
<a name="l00031"></a>00031   <span class="comment">/******************************************************************************/</span>
<a name="l00032"></a><a class="code" href="classCALICE_1_1AngleTrackFinder.html#a74cdcf69ca7ef1072ccdd5ea7d9ae551">00032</a>   <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a74cdcf69ca7ef1072ccdd5ea7d9ae551" title="Default constructor.">AngleTrackFinder::AngleTrackFinder</a>() : Processor(<span class="stringliteral">&quot;AngleTrackFinder&quot;</span>) 
<a name="l00033"></a>00033   {
<a name="l00034"></a>00034     _description = <span class="stringliteral">&quot;Processor to find track from a MIP&quot;</span>;
<a name="l00035"></a>00035     
<a name="l00036"></a>00036     registerProcessorParameter(<span class="stringliteral">&quot;MappingProcessorName&quot;</span>,
<a name="l00037"></a>00037                                <span class="stringliteral">&quot;Name of the MappingProcessor instance that provides&quot;</span>
<a name="l00038"></a>00038                                <span class="stringliteral">&quot; the geometry of the detector.&quot;</span>, <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a8ed332f4a4fac3a16df92f32cec1ca23" title="name of the processor which provides the mapping">_mappingProcessorName</a>,
<a name="l00039"></a>00039                                std::string(<span class="stringliteral">&quot;MyMappingProcessor&quot;</span>));
<a name="l00040"></a>00040     
<a name="l00041"></a>00041     registerProcessorParameter(<span class="stringliteral">&quot;CellDescriptionProcessorName&quot;</span>,
<a name="l00042"></a>00042                                <span class="stringliteral">&quot;name of CellDescriptionProcessor which takes care of the cell description generation&quot;</span>,
<a name="l00043"></a>00043                                <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a9094f5b2aa449c3bd3180fe4fc7094d2" title="name of the processor which provides the cells description">_cellDescriptionProcessorName</a>, std::string(<span class="stringliteral">&quot;MyCellDescriptionProcessor&quot;</span>));
<a name="l00044"></a>00044     
<a name="l00045"></a>00045     registerProcessorParameter(<span class="stringliteral">&quot;AHCALInputCollectionName&quot;</span>,
<a name="l00046"></a>00046                                <span class="stringliteral">&quot;Name of the collection of the AHCAL hits&quot;</span>, _ahcalInputColName,
<a name="l00047"></a>00047                                std::string(<span class="stringliteral">&quot;AhcCalorimeter_Hits&quot;</span>));
<a name="l00048"></a>00048     
<a name="l00049"></a>00049     registerProcessorParameter(<span class="stringliteral">&quot;AmplitudeHCALInputCollectionName&quot;</span>,
<a name="l00050"></a>00050                                <span class="stringliteral">&quot;Name of the AHCAL Amplitude Collection&quot;</span>, _ahcalAmpInputColName,
<a name="l00051"></a>00051                                std::string(<span class="stringliteral">&quot;AhcHitAmplitudeRelation&quot;</span>));
<a name="l00052"></a>00052     
<a name="l00053"></a>00053     registerProcessorParameter(<span class="stringliteral">&quot;AHCALMuonOutputCollectionName&quot;</span>,
<a name="l00054"></a>00054                                <span class="stringliteral">&quot;Name of the collection of the tracks found &quot;</span>
<a name="l00055"></a>00055                                <span class="stringliteral">&quot;in the AHCAL&quot;</span>, _ahcalOutputTrackColName, std::string(<span class="stringliteral">&quot;AhcMuonHits&quot;</span>));
<a name="l00056"></a>00056 
<a name="l00057"></a>00057     registerProcessorParameter(<span class="stringliteral">&quot;TCMTMuonOutputCollectionName&quot;</span>,
<a name="l00058"></a>00058                                <span class="stringliteral">&quot;Name of the collection of the tracks found &quot;</span>
<a name="l00059"></a>00059                                <span class="stringliteral">&quot;in the TCMT&quot;</span>, _tcmtOutputTrackColName, std::string(<span class="stringliteral">&quot;TcmtMuonHits&quot;</span>));
<a name="l00060"></a>00060     
<a name="l00061"></a>00061     registerProcessorParameter(<span class="stringliteral">&quot;UseTCMT&quot;</span>, <span class="stringliteral">&quot;Use TCMT input hits&quot;</span>, _useTCMT,
<a name="l00062"></a>00062                                <span class="keywordtype">bool</span>(<span class="keyword">false</span>));
<a name="l00063"></a>00063     
<a name="l00064"></a>00064     registerProcessorParameter(<span class="stringliteral">&quot;UseECAL&quot;</span>, <span class="stringliteral">&quot;Use ECAL input hits&quot;</span>, _useECAL,
<a name="l00065"></a>00065                                <span class="keywordtype">bool</span>(<span class="keyword">false</span>));
<a name="l00066"></a>00066     
<a name="l00067"></a>00067     registerProcessorParameter(<span class="stringliteral">&quot;TcmtStartVertical&quot;</span>,
<a name="l00068"></a>00068                                <span class="stringliteral">&quot;Orientation of first TCMT layer&quot;</span>, _tcmtStartVertical, <span class="keywordtype">bool</span>(<span class="keyword">true</span>));
<a name="l00069"></a>00069     
<a name="l00070"></a>00070     registerProcessorParameter(<span class="stringliteral">&quot;TcmtStripWidth&quot;</span>, <span class="stringliteral">&quot;Width of a TCMT strip&quot;</span>,
<a name="l00071"></a>00071                                _tcmtStripWidth, <span class="keywordtype">float</span>(50.0));
<a name="l00072"></a>00072     
<a name="l00073"></a>00073     registerProcessorParameter(<span class="stringliteral">&quot;TCMInputCollectionName&quot;</span>,
<a name="l00074"></a>00074                                <span class="stringliteral">&quot;Name of the TCMT input collection&quot;</span>, _tcmtInputColName,
<a name="l00075"></a>00075                                std::string(<span class="stringliteral">&quot;TcmtCalorimeter_Hits&quot;</span>));
<a name="l00076"></a>00076     
<a name="l00077"></a>00077     registerProcessorParameter(<span class="stringliteral">&quot;TcmtMinActiveParallelStrips&quot;</span>, <span class="stringliteral">&quot;Minimum number of active parallel strips in TCMT&quot;</span>,
<a name="l00078"></a>00078                                _minActiveTCMTParallelStrips, <span class="keywordtype">int</span>(6));
<a name="l00079"></a>00079     
<a name="l00080"></a>00080     registerProcessorParameter(<span class="stringliteral">&quot;ECALInputCollectionName&quot;</span>,
<a name="l00081"></a>00081                                <span class="stringliteral">&quot;Name of the ECAL input collection&quot;</span>, _ecalInputColName,
<a name="l00082"></a>00082                                std::string(<span class="stringliteral">&quot;EmcCalorimeter_Hits&quot;</span>));
<a name="l00083"></a>00083     
<a name="l00084"></a>00084     registerProcessorParameter(<span class="stringliteral">&quot;IsNonMuonRun&quot;</span>, <span class="stringliteral">&quot;Is this a non-muon run?&quot;</span>,
<a name="l00085"></a>00085                                <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a599998d50ef67e2bc2e9a07b0864dd3d" title="flag for non-muon run">_isNonMuonRun</a>, <span class="keywordtype">bool</span>(<span class="keyword">false</span>));
<a name="l00086"></a>00086     
<a name="l00087"></a>00087     registerProcessorParameter(<span class="stringliteral">&quot;MaxAHCALNoHits&quot;</span>,
<a name="l00088"></a>00088                                <span class="stringliteral">&quot;Maximum number of hits in the AHCAL, used for a non-muon run&quot;</span>,
<a name="l00089"></a>00089                                <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a94a071cd5fbe48451c8aace1168f9697" title="maximum number of hits in the AHCAL">_ahcalMaxNoHits</a>, <span class="keywordtype">int</span>(100));
<a name="l00090"></a>00090     
<a name="l00091"></a>00091     registerProcessorParameter(<span class="stringliteral">&quot;MinECALNoHits&quot;</span>,
<a name="l00092"></a>00092                                <span class="stringliteral">&quot;Minimum number of hits in the ECAL&quot;</span>, <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a5db8580f90e8193fad643ca4415260ab" title="minimum number of hits in the ECAL">_ecalMinNoHits</a>, <span class="keywordtype">int</span>(30));
<a name="l00093"></a>00093     
<a name="l00094"></a>00094     registerProcessorParameter(<span class="stringliteral">&quot;MaxECALNoHits&quot;</span>,
<a name="l00095"></a>00095                                <span class="stringliteral">&quot;Maximum number of hits in the ECAL&quot;</span>, <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a305795d0103cb33c9cf579d83d050968" title="maximum number of hits in the ECAL">_ecalMaxNoHits</a>, <span class="keywordtype">int</span>(34));
<a name="l00096"></a>00096     
<a name="l00097"></a>00097     registerProcessorParameter(<span class="stringliteral">&quot;MinTCMTEnergySum&quot;</span>,
<a name="l00098"></a>00098                                <span class="stringliteral">&quot;Minimum energy sum in the TCMT&quot;</span>, <a class="code" href="classCALICE_1_1AngleTrackFinder.html#ab5ac7f274d7c9936f4d19ed1ac463715" title="minimum energy sum in the TCMT">_tcmtMinEnergySum</a>, <span class="keywordtype">float</span>(10));
<a name="l00099"></a>00099     
<a name="l00100"></a>00100     registerProcessorParameter(<span class="stringliteral">&quot;useCoarseSection&quot;</span>, <span class="stringliteral">&quot;use or not coarse section&quot;</span>,
<a name="l00101"></a>00101                                _useCoarseSection, <span class="keywordtype">int</span>(0));
<a name="l00102"></a>00102     
<a name="l00103"></a>00103     registerProcessorParameter(<span class="stringliteral">&quot;MipCutValue&quot;</span>, <span class="stringliteral">&quot;Minimum energy in MIPs&quot;</span>,
<a name="l00104"></a>00104                                <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a09632c19bf97a231d9ab2c1e6e32cc78" title="MIP cut value (0.5 MIPs).">_mipCutValue</a>, <span class="keywordtype">float</span>(0.5));
<a name="l00105"></a>00105     
<a name="l00106"></a>00106     registerProcessorParameter(<span class="stringliteral">&quot;MipCutVariable&quot;</span>,
<a name="l00107"></a>00107                                <span class="stringliteral">&quot;use (0) pure raw/MIP or (1) raw/MIP after whole calibration chain&quot;</span>,
<a name="l00108"></a>00108                                _mipCutVariable, <span class="keywordtype">int</span>(1));
<a name="l00109"></a>00109     IntVec badAhcalModulesVec;
<a name="l00110"></a>00110     registerProcessorParameter(<span class="stringliteral">&quot;AHCALBadModules&quot;</span>,
<a name="l00111"></a>00111                                <span class="stringliteral">&quot;List of bad AHCAL modules which need to be excluded&quot;</span>,
<a name="l00112"></a>00112                                <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a6d4442136ce5b168d27f32f3f753164c" title="vector of bad AHCAL modules numbers">_badAhcalModulesVec</a>, badAhcalModulesVec);
<a name="l00113"></a>00113     
<a name="l00114"></a>00114     IntVec firstAhcalModulesVec;
<a name="l00115"></a>00115     registerProcessorParameter(<span class="stringliteral">&quot;AHCALFirstModules&quot;</span>,
<a name="l00116"></a>00116                                <span class="stringliteral">&quot;List of beginning AHCAL modules which are used&quot;</span>
<a name="l00117"></a>00117                                <span class="stringliteral">&quot; for perpendicular track finding&quot;</span>,
<a name="l00118"></a>00118                                <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a53176eb4d890fcf6f41291a7aa7f7ecd" title="vector of numbers of the beginning AHCAL modules which are used for perpendicular...">_firstAhcalModulesVec</a>,
<a name="l00119"></a>00119                                firstAhcalModulesVec);
<a name="l00120"></a>00120     
<a name="l00121"></a>00121     IntVec lastAhcalModulesVec;
<a name="l00122"></a>00122     registerProcessorParameter(<span class="stringliteral">&quot;AHCALLastModules&quot;</span>,
<a name="l00123"></a>00123                                <span class="stringliteral">&quot;List of ending AHCAL modules which are used&quot;</span>
<a name="l00124"></a>00124                                <span class="stringliteral">&quot; for perpendicular track finding&quot;</span>, 
<a name="l00125"></a>00125                                <a class="code" href="classCALICE_1_1AngleTrackFinder.html#afe5e51f2a91a84dabaed6f6ad9cd60e9" title="vector of numbers of the ending AHCAL modules which are used for perpendicular track...">_lastAhcalModulesVec</a>,
<a name="l00126"></a>00126                                lastAhcalModulesVec);
<a name="l00127"></a>00127     
<a name="l00128"></a>00128     registerProcessorParameter(<span class="stringliteral">&quot;TrackSelectionMode&quot;</span>, <span class="stringliteral">&quot;Track selection mode: &quot;</span>
<a name="l00129"></a>00129                                <span class="stringliteral">&quot;NHITS = based on the number of hits; &quot;</span>
<a name="l00130"></a>00130                                <span class="stringliteral">&quot;PERPENDICULAR = select only perpendicular tracks&quot;</span>,
<a name="l00131"></a>00131                                <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a9e65faf8074db90de8771bc2dccf072c" title="track selection mode: NHITs = based on the number of hits; PERPENDICULAR = select...">_trackSelectionMode</a>, std::string(<span class="stringliteral">&quot;NHITS&quot;</span>));
<a name="l00132"></a>00132     
<a name="l00133"></a>00133     registerProcessorParameter(<span class="stringliteral">&quot;TrackNoHitsThreshold&quot;</span>,
<a name="l00134"></a>00134                                <span class="stringliteral">&quot;Threshold on the number of hits a track &quot;</span>
<a name="l00135"></a>00135                                <span class="stringliteral">&quot;is considered to be a muon track (used only with TrackSelectionMode=NHITS)&quot;</span>,
<a name="l00136"></a>00136                                <a class="code" href="classCALICE_1_1AngleTrackFinder.html#af196bbbed608a60877075df58d8d7916" title="choose amplitude to be used to perform the mip cut">_trackNoHitsThreshold</a>, <span class="keywordtype">int</span>(20));
<a name="l00137"></a>00137   }
<a name="l00138"></a>00138   
<a name="l00139"></a>00139   <span class="comment">/******************************************************************************/</span>
<a name="l00140"></a>00140   <span class="comment">/*                                                                            */</span>
<a name="l00141"></a>00141   <span class="comment">/*                                                                            */</span>
<a name="l00142"></a>00142   <span class="comment">/*                                                                            */</span>
<a name="l00143"></a>00143   <span class="comment">/******************************************************************************/</span>
<a name="l00144"></a><a class="code" href="classCALICE_1_1AngleTrackFinder.html#acf657623bf1eff4c45b4af704f519ca3">00144</a>   <a class="code" href="classCALICE_1_1AngleTrackFinder.html#acf657623bf1eff4c45b4af704f519ca3" title="Destructor.">AngleTrackFinder::~AngleTrackFinder</a>() 
<a name="l00145"></a>00145   {
<a name="l00146"></a>00146   }
<a name="l00147"></a>00147   
<a name="l00148"></a>00148   <span class="comment">/******************************************************************************/</span>
<a name="l00149"></a>00149   <span class="comment">/*                                                                            */</span>
<a name="l00150"></a>00150   <span class="comment">/*                                                                            */</span>
<a name="l00151"></a>00151   <span class="comment">/*                                                                            */</span>
<a name="l00152"></a>00152   <span class="comment">/******************************************************************************/</span>
<a name="l00153"></a><a class="code" href="classCALICE_1_1AngleTrackFinder.html#a994a129403fc067c93e4a37545c79499">00153</a>   <span class="keywordtype">void</span> <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a994a129403fc067c93e4a37545c79499" title="Initialise useful variables.">AngleTrackFinder::init</a>() 
<a name="l00154"></a>00154   {
<a name="l00155"></a>00155     printParameters();
<a name="l00156"></a>00156     
<a name="l00157"></a>00157     _navigator = NULL;
<a name="l00158"></a>00158     
<a name="l00159"></a>00159     std::stringstream message;
<a name="l00160"></a>00160     <span class="keywordtype">bool</span> error = <span class="keyword">false</span>;
<a name="l00161"></a>00161     
<a name="l00162"></a>00162     <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a1e8ade0f953c3f0e73665cf8bb6fc58f" title="the mapper">_mapper</a> = <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span>Mapper*<span class="keyword">&gt;</span> (MappingProcessor::getMapper(<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a8ed332f4a4fac3a16df92f32cec1ca23" title="name of the processor which provides the mapping">_mappingProcessorName</a>));
<a name="l00163"></a>00163     <span class="keywordflow">if</span> (!<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a1e8ade0f953c3f0e73665cf8bb6fc58f" title="the mapper">_mapper</a>) 
<a name="l00164"></a>00164       {
<a name="l00165"></a>00165         message &lt;&lt; <span class="stringliteral">&quot;MappingProcessor::getMapper(&quot;</span> &lt;&lt; <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a8ed332f4a4fac3a16df92f32cec1ca23" title="name of the processor which provides the mapping">_mappingProcessorName</a>
<a name="l00166"></a>00166                 &lt;&lt; <span class="stringliteral">&quot;) did not return a valid mapper.&quot;</span> &lt;&lt; std::endl;
<a name="l00167"></a>00167         error = <span class="keyword">true</span>;
<a name="l00168"></a>00168       }
<a name="l00169"></a>00169     
<a name="l00170"></a>00170     _cellDescriptions = CALICE::CellDescriptionProcessor::getCellDescriptions(<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a9094f5b2aa449c3bd3180fe4fc7094d2" title="name of the processor which provides the cells description">_cellDescriptionProcessorName</a>);
<a name="l00171"></a>00171     <span class="keywordflow">if</span> (!_cellDescriptions) 
<a name="l00172"></a>00172       {
<a name="l00173"></a>00173         streamlog_out(ERROR) &lt;&lt; <span class="stringliteral">&quot;Cannot obtain cell descriptions from CellDescriptionsProcessor &quot;</span>
<a name="l00174"></a>00174                      &lt;&lt; <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a9094f5b2aa449c3bd3180fe4fc7094d2" title="name of the processor which provides the cells description">_cellDescriptionProcessorName</a>
<a name="l00175"></a>00175                      &lt;&lt; <span class="stringliteral">&quot;. Maybe, processor is not present&quot;</span> &lt;&lt; std::endl;
<a name="l00176"></a>00176         error = <span class="keyword">true</span>;
<a name="l00177"></a>00177       }
<a name="l00178"></a>00178     
<a name="l00179"></a>00179     <span class="keywordflow">if</span> (error) 
<a name="l00180"></a>00180       {
<a name="l00181"></a>00181         streamlog_out(ERROR) &lt;&lt; message.str();
<a name="l00182"></a>00182         <span class="keywordflow">throw</span> marlin::StopProcessingException(<span class="keyword">this</span>);
<a name="l00183"></a>00183       }
<a name="l00184"></a>00184     
<a name="l00185"></a>00185   }
<a name="l00186"></a>00186   
<a name="l00187"></a>00187   <span class="comment">/******************************************************************************/</span>
<a name="l00188"></a>00188   <span class="comment">/*                                                                            */</span>
<a name="l00189"></a>00189   <span class="comment">/*                                                                            */</span>
<a name="l00190"></a>00190   <span class="comment">/*                                                                            */</span>
<a name="l00191"></a>00191   <span class="comment">/******************************************************************************/</span>
<a name="l00192"></a><a class="code" href="classCALICE_1_1AngleTrackFinder.html#a212ba3e4cfe268d1941c294df5aba7b1">00192</a>   <span class="keywordtype">void</span> <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a212ba3e4cfe268d1941c294df5aba7b1" title="Process event (the working horse).">AngleTrackFinder::processEvent</a>(LCEvent* evt) 
<a name="l00193"></a>00193   {
<a name="l00194"></a>00194     streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;\n\n============================= Processing event &quot;</span>
<a name="l00195"></a>00195                   &lt;&lt; evt-&gt;getEventNumber() &lt;&lt; endl;
<a name="l00196"></a>00196             
<a name="l00197"></a>00197     <span class="comment">/* Get the incoming collections*/</span>
<a name="l00198"></a>00198     <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a684d9afc2a36e32a3fa037f8befcc23f" title="Open the input collections.">openInputCollections</a>(evt);
<a name="l00199"></a>00199     
<a name="l00200"></a>00200     <span class="comment">/* Start the track finding*/</span>
<a name="l00201"></a>00201     <a class="code" href="classCALICE_1_1AngleTrackFinder.html#aac50b453e10cdfbb6612eeefcb5ca25c" title="Find the track.">findTrack</a>(evt);
<a name="l00202"></a>00202     
<a name="l00203"></a>00203     <span class="comment">/* Clear vectors*/</span>
<a name="l00204"></a>00204     <a class="code" href="classCALICE_1_1AngleTrackFinder.html#aef20f858c612a3181537606fdc4be0f1" title="vector containing all AHCAL hits from the event">_allAhcalHitsInEventVec</a>.clear();
<a name="l00205"></a>00205     
<a name="l00206"></a>00206     
<a name="l00207"></a>00207     <span class="comment">/*Delete the navigator, otherwise there is a memory leak.*/</span>
<a name="l00208"></a>00208     <span class="keyword">delete</span> _navigator; 
<a name="l00209"></a>00209     
<a name="l00210"></a>00210   }
<a name="l00211"></a>00211   
<a name="l00212"></a>00212   <span class="comment">/******************************************************************************/</span>
<a name="l00213"></a>00213   <span class="comment">/*                                                                            */</span>
<a name="l00214"></a>00214   <span class="comment">/*                                                                            */</span>
<a name="l00215"></a>00215   <span class="comment">/*                                                                            */</span>
<a name="l00216"></a>00216   <span class="comment">/******************************************************************************/</span>
<a name="l00217"></a><a class="code" href="classCALICE_1_1AngleTrackFinder.html#a684d9afc2a36e32a3fa037f8befcc23f">00217</a>   <span class="keywordtype">void</span> <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a684d9afc2a36e32a3fa037f8befcc23f" title="Open the input collections.">AngleTrackFinder::openInputCollections</a>(LCEvent* evt) 
<a name="l00218"></a>00218   {
<a name="l00219"></a>00219     <span class="keywordflow">try</span> {
<a name="l00220"></a>00220       <span class="keywordflow">if</span> (_useECAL == <span class="keyword">true</span>) 
<a name="l00221"></a>00221         {
<a name="l00222"></a>00222           streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;Opening ECAL collection &quot;</span> &lt;&lt; _ecalInputColName
<a name="l00223"></a>00223                         &lt;&lt; endl;
<a name="l00224"></a>00224           <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a6c55f00b24dedf933046c374d57567a2" title="ECAL input collection.">_ecalInputCol</a> = evt-&gt;getCollection(_ecalInputColName);
<a name="l00225"></a>00225         }
<a name="l00226"></a>00226       
<a name="l00227"></a>00227       <span class="keywordflow">if</span> (_useTCMT == <span class="keyword">true</span>) 
<a name="l00228"></a>00228         {
<a name="l00229"></a>00229           streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;Opening TCMT collection &quot;</span> &lt;&lt; _tcmtInputColName
<a name="l00230"></a>00230                        &lt;&lt; endl;
<a name="l00231"></a>00231           <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a961a3ce5cad59157ae7cc350da27017b" title="TCMT input collection.">_tcmtInputCol</a> = evt-&gt;getCollection(_tcmtInputColName);
<a name="l00232"></a>00232         }
<a name="l00233"></a>00233       
<a name="l00234"></a>00234       <span class="comment">/* HCAL collection*/</span>
<a name="l00235"></a>00235       <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a6294fed90962d5ecaf2d63f4f119c808" title="AHCAL input collection.">_ahcalInputCol</a> = evt-&gt;getCollection(_ahcalInputColName);
<a name="l00236"></a>00236       _encodingString = <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a6294fed90962d5ecaf2d63f4f119c808" title="AHCAL input collection.">_ahcalInputCol</a>-&gt;getParameters().getStringVal(<span class="stringliteral">&quot;CellIDEncoding&quot;</span>);
<a name="l00237"></a>00237       <span class="comment">/*HCAL amplitude relation*/</span>
<a name="l00238"></a>00238       <span class="keywordflow">if</span> (_mipCutVariable == 0) 
<a name="l00239"></a>00239         {
<a name="l00240"></a>00240           <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a63d915b7e5159274be1cec89db2c0390" title="AHCAL Amplitude input collection.">_ahcalAmpInputCol</a> = evt-&gt;getCollection(_ahcalAmpInputColName);
<a name="l00241"></a>00241           _navigator = <span class="keyword">new</span> UTIL::LCRelationNavigator(<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a63d915b7e5159274be1cec89db2c0390" title="AHCAL Amplitude input collection.">_ahcalAmpInputCol</a>);
<a name="l00242"></a>00242         } 
<a name="l00243"></a>00243       <span class="keywordflow">else</span> 
<a name="l00244"></a>00244         {
<a name="l00245"></a>00245           <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a63d915b7e5159274be1cec89db2c0390" title="AHCAL Amplitude input collection.">_ahcalAmpInputCol</a> = NULL;
<a name="l00246"></a>00246           _navigator = NULL;
<a name="l00247"></a>00247         }
<a name="l00248"></a>00248       
<a name="l00249"></a>00249       streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;Opening AHCAL collection &quot;</span> &lt;&lt; _ahcalInputColName
<a name="l00250"></a>00250                     &lt;&lt; <span class="stringliteral">&quot; with &quot;</span> &lt;&lt; <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a6294fed90962d5ecaf2d63f4f119c808" title="AHCAL input collection.">_ahcalInputCol</a>-&gt;getNumberOfElements() &lt;&lt; <span class="stringliteral">&quot; hits&quot;</span>
<a name="l00251"></a>00251                     &lt;&lt; endl;
<a name="l00252"></a>00252       
<a name="l00253"></a>00253     } 
<a name="l00254"></a>00254     <span class="keywordflow">catch</span> (DataNotAvailableException &amp;e) 
<a name="l00255"></a>00255       {
<a name="l00256"></a>00256         streamlog_out(WARNING) &lt;&lt; <span class="stringliteral">&quot;At least one required collection is missing:\n &quot;</span>
<a name="l00257"></a>00257                        &lt;&lt; _ahcalInputColName &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; _ecalInputColName &lt;&lt; <span class="stringliteral">&quot; or &quot;</span>
<a name="l00258"></a>00258                        &lt;&lt; _tcmtInputColName &lt;&lt; <span class="stringliteral">&quot; in the event &quot;</span>
<a name="l00259"></a>00259                        &lt;&lt; evt-&gt;getEventNumber() &lt;&lt; endl;
<a name="l00260"></a>00260         
<a name="l00261"></a>00261         <span class="keywordflow">throw</span> marlin::SkipEventException(<span class="keyword">this</span>);
<a name="l00262"></a>00262       }
<a name="l00263"></a>00263     
<a name="l00264"></a>00264   }
<a name="l00265"></a>00265   
<a name="l00266"></a>00266   <span class="comment">/******************************************************************************/</span>
<a name="l00267"></a>00267   <span class="comment">/*                                                                            */</span>
<a name="l00268"></a>00268   <span class="comment">/*                                                                            */</span>
<a name="l00269"></a>00269   <span class="comment">/*                                                                            */</span>
<a name="l00270"></a>00270   <span class="comment">/******************************************************************************/</span>
<a name="l00271"></a><a class="code" href="classCALICE_1_1AngleTrackFinder.html#aac50b453e10cdfbb6612eeefcb5ca25c">00271</a>   <span class="keywordtype">void</span> <a class="code" href="classCALICE_1_1AngleTrackFinder.html#aac50b453e10cdfbb6612eeefcb5ca25c" title="Find the track.">AngleTrackFinder::findTrack</a>(LCEvent* evt) 
<a name="l00272"></a>00272   {
<a name="l00273"></a>00273     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a118f2d1e9c47337831da14c8c356e555" title="Check if cuts are fullfilled, and if analysis is to be continued.">doFurtherAnalysis</a>() == <span class="keyword">false</span>) <span class="keywordflow">return</span>; 
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;\n\n ============ Start to find track in event &quot;</span>
<a name="l00276"></a>00276                   &lt;&lt; evt-&gt;getEventNumber() &lt;&lt; endl;
<a name="l00277"></a>00277     
<a name="l00278"></a>00278     
<a name="l00279"></a>00279     <span class="comment">/* All hits above 0.5 MIP are filled into the vector hits.*/</span>
<a name="l00280"></a>00280     std::vector&lt;CalorimeterHit*&gt; hcalHitsVec = this-&gt;<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a86fc7e637d10c7ee1ab9851b1fc54e1b" title="Extract AHCAL information.">extractAHCALInformation</a>();
<a name="l00281"></a>00281     
<a name="l00282"></a>00282     <span class="keywordflow">if</span> (hcalHitsVec.size() &gt; (unsigned) <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a94a071cd5fbe48451c8aace1168f9697" title="maximum number of hits in the AHCAL">_ahcalMaxNoHits</a>) 
<a name="l00283"></a>00283       {
<a name="l00284"></a>00284         streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;Number of hits above mip cut: &quot;</span>
<a name="l00285"></a>00285                      &lt;&lt; hcalHitsVec.size() &lt;&lt; <span class="stringliteral">&quot;, skipping event.&quot;</span> &lt;&lt; endl;
<a name="l00286"></a>00286         <span class="keywordflow">return</span>;
<a name="l00287"></a>00287       }
<a name="l00288"></a>00288     
<a name="l00289"></a>00289     <span class="comment">/*------------------------------------------------------------------- </span>
<a name="l00290"></a>00290 <span class="comment">       All hits above 0.5 MIP which are recognized as a track are</span>
<a name="l00291"></a>00291 <span class="comment">       in this vector of ClusterVec -fine section-*/</span>
<a name="l00292"></a>00292     
<a name="l00293"></a>00293     EVENT::ClusterVec trackClusterVec;
<a name="l00294"></a>00294     this-&gt;<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a24fd651c00cb89fa736943ee252ff5fc" title="Find clusters of MIP tracks.">findTrackClusters</a>(hcalHitsVec, trackClusterVec);
<a name="l00295"></a>00295     
<a name="l00296"></a>00296     <span class="comment">/*------------------------------------------------------------------- </span>
<a name="l00297"></a>00297 <span class="comment">       All hits above 0.5 MIP which are recognized as a track are</span>
<a name="l00298"></a>00298 <span class="comment">       in this vector of ClusterVec -coarse section-*/</span>
<a name="l00299"></a>00299     EVENT::ClusterVec trackClusterVecCoarse;
<a name="l00300"></a>00300     
<a name="l00301"></a>00301     <span class="keywordflow">if</span> (_useCoarseSection == 1) 
<a name="l00302"></a>00302       {
<a name="l00303"></a>00303         <span class="comment">/*</span>
<a name="l00304"></a>00304 <span class="comment">          Angela Lucaci: Ugly, I know. But the hcalHitsVec is emptied in the this-&gt;findTrackClusters()...</span>
<a name="l00305"></a>00305 <span class="comment">        */</span>
<a name="l00306"></a>00306         hcalHitsVec = this-&gt;<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a86fc7e637d10c7ee1ab9851b1fc54e1b" title="Extract AHCAL information.">extractAHCALInformation</a>();
<a name="l00307"></a>00307         this-&gt;findTrackClustersCoarse(hcalHitsVec, trackClusterVecCoarse);
<a name="l00308"></a>00308       }
<a name="l00309"></a>00309  
<a name="l00310"></a>00310     <span class="comment">/* This vector holds the selected tracks */</span>
<a name="l00311"></a>00311     this-&gt;<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a48012b9d15a3a0e4e8ea6231bbf93dac" title="Select good tracks.">selectTrackClusters</a>(trackClusterVec, <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a9e65faf8074db90de8771bc2dccf072c" title="track selection mode: NHITs = based on the number of hits; PERPENDICULAR = select...">_trackSelectionMode</a>, _goodTrackClusters);
<a name="l00312"></a>00312         
<a name="l00313"></a>00313     EVENT::ClusterVec selectedFineCoarseVec;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <span class="keywordflow">if</span> (_useCoarseSection == 1) 
<a name="l00316"></a>00316       {
<a name="l00317"></a>00317         this-&gt;mergeCoarseClusters(_goodTrackClusters, 
<a name="l00318"></a>00318                                   trackClusterVecCoarse,
<a name="l00319"></a>00319                                   selectedFineCoarseVec,
<a name="l00320"></a>00320                                   <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a9e65faf8074db90de8771bc2dccf072c" title="track selection mode: NHITs = based on the number of hits; PERPENDICULAR = select...">_trackSelectionMode</a>);
<a name="l00321"></a>00321       }
<a name="l00322"></a>00322     
<a name="l00323"></a>00323     EVENT::ClusterVec outputTrackSegments;
<a name="l00324"></a>00324     <span class="keywordflow">if</span> (_useCoarseSection == 1) 
<a name="l00325"></a>00325       {
<a name="l00326"></a>00326         outputTrackSegments = this-&gt;getRemainingHitsOfTrackSegment(selectedFineCoarseVec);
<a name="l00327"></a>00327       } 
<a name="l00328"></a>00328     <span class="keywordflow">else</span> 
<a name="l00329"></a>00329       {
<a name="l00330"></a>00330         outputTrackSegments = this-&gt;getRemainingHitsOfTrackSegment(_goodTrackClusters);
<a name="l00331"></a>00331       }
<a name="l00332"></a>00332         
<a name="l00333"></a>00333     streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;Preparing the output &quot;</span> &lt;&lt; endl;
<a name="l00334"></a>00334     
<a name="l00335"></a>00335     EVENT::ClusterVec outputTrackClusterVec = this-&gt;getFinalCluster(outputTrackSegments);
<a name="l00336"></a>00336     
<a name="l00337"></a>00337     streamlog_out(DEBUG) &lt;&lt; outputTrackClusterVec.size() &lt;&lt; <span class="stringliteral">&quot; found tracks&quot;</span>
<a name="l00338"></a>00338                  &lt;&lt; endl;
<a name="l00339"></a>00339     streamlog_out(DEBUG) &lt;&lt;<span class="stringliteral">&quot;\n UseTCMT: &quot;</span>&lt;&lt;_useTCMT&lt;&lt;endl;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341     <span class="keywordflow">if</span> (_useTCMT) 
<a name="l00342"></a>00342       {
<a name="l00343"></a>00343         LCTypedVector&lt;CalorimeterHit&gt; tcmtHits(<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a961a3ce5cad59157ae7cc350da27017b" title="TCMT input collection.">_tcmtInputCol</a>);
<a name="l00344"></a>00344         this-&gt;extendTracksToTcmt(tcmtHits, outputTrackClusterVec);
<a name="l00345"></a>00345       }
<a name="l00346"></a>00346     
<a name="l00347"></a>00347     <span class="comment">/* Attach the final tracks to the event.*/</span>
<a name="l00348"></a>00348     streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;Create the collection &quot;</span> &lt;&lt; endl;
<a name="l00349"></a>00349     <a class="code" href="classCALICE_1_1AngleTrackFinder.html#ae2aa960da701d5e62b15e21c1df40691" title="Create output collection of track clusters.">createOutputCollection</a>(evt, outputTrackClusterVec);
<a name="l00350"></a>00350     
<a name="l00351"></a>00351     streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;Quite in the end!&quot;</span> &lt;&lt; endl;
<a name="l00352"></a>00352       
<a name="l00353"></a>00353     
<a name="l00354"></a>00354     <span class="comment">/*----------------------------------------------------------------------------------------*/</span>
<a name="l00355"></a>00355     <span class="comment">/*Don&apos;t forget to clear the contents of the used vectors, otherwise you get a memory leak*/</span>
<a name="l00356"></a>00356     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; trackClusterVec.size(); ++i)
<a name="l00357"></a>00357       <span class="keyword">delete</span> trackClusterVec[i];
<a name="l00358"></a>00358     trackClusterVec.clear();
<a name="l00359"></a>00359     
<a name="l00360"></a>00360     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; trackClusterVecCoarse.size(); ++i)
<a name="l00361"></a>00361       <span class="keyword">delete</span> trackClusterVecCoarse[i];
<a name="l00362"></a>00362     trackClusterVecCoarse.clear();
<a name="l00363"></a>00363     
<a name="l00364"></a>00364     <span class="comment">//  selectedFineCoarseVec.clear();</span>
<a name="l00365"></a>00365     
<a name="l00366"></a>00366     hcalHitsVec.clear();
<a name="l00367"></a>00367     
<a name="l00368"></a>00368     
<a name="l00369"></a>00369   }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371   <span class="comment">/******************************************************************************/</span>
<a name="l00372"></a>00372   <span class="comment">/*                                                                            */</span>
<a name="l00373"></a>00373   <span class="comment">/*                                                                            */</span>
<a name="l00374"></a>00374   <span class="comment">/*                                                                            */</span>
<a name="l00375"></a>00375   <span class="comment">/******************************************************************************/</span>
<a name="l00376"></a><a class="code" href="classCALICE_1_1AngleTrackFinder.html#a118f2d1e9c47337831da14c8c356e555">00376</a>   <span class="keywordtype">bool</span> <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a118f2d1e9c47337831da14c8c356e555" title="Check if cuts are fullfilled, and if analysis is to be continued.">AngleTrackFinder::doFurtherAnalysis</a>() 
<a name="l00377"></a>00377   {
<a name="l00378"></a>00378     <span class="comment">/* here apply criteria to use the number of hits in HCAL to  apply the muon*/</span>
<a name="l00379"></a>00379     <span class="keywordtype">bool</span> analyse = <span class="keyword">false</span>;
<a name="l00380"></a>00380     
<a name="l00381"></a>00381     <span class="keywordflow">if</span> (_useECAL == <span class="keyword">true</span>) 
<a name="l00382"></a>00382       {
<a name="l00383"></a>00383         streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;Using ECAL and TCMT information&quot;</span> &lt;&lt; endl;
<a name="l00384"></a>00384         
<a name="l00385"></a>00385         <span class="comment">/* ECAL information*/</span>
<a name="l00386"></a>00386         std::pair&lt;int, float&gt; nhits_and_esum(<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a1799da6da5db2cbf5de0e458ccbe3566" title="Extract number of hits and the energy sum from the input collection.">extractNumberOfHitsAndEnergySum</a>(<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a6c55f00b24dedf933046c374d57567a2" title="ECAL input collection.">_ecalInputCol</a>));
<a name="l00387"></a>00387         <span class="keywordtype">int</span> ecalNumberOfHits = nhits_and_esum.first;
<a name="l00388"></a>00388         
<a name="l00389"></a>00389         <span class="keywordflow">if</span> ((ecalNumberOfHits &gt; <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a5db8580f90e8193fad643ca4415260ab" title="minimum number of hits in the ECAL">_ecalMinNoHits</a>) &amp;&amp; (ecalNumberOfHits &lt; <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a305795d0103cb33c9cf579d83d050968" title="maximum number of hits in the ECAL">_ecalMaxNoHits</a>)) 
<a name="l00390"></a>00390           {
<a name="l00391"></a>00391             analyse = <span class="keyword">true</span>;
<a name="l00392"></a>00392             streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;ECAL criteria reached. &quot;</span>
<a name="l00393"></a>00393                                   &lt;&lt; <span class="stringliteral">&quot;Going to do further processing.&quot;</span> &lt;&lt; endl;
<a name="l00394"></a>00394           } 
<a name="l00395"></a>00395         <span class="keywordflow">else</span> 
<a name="l00396"></a>00396           {
<a name="l00397"></a>00397             analyse = <span class="keyword">false</span>;
<a name="l00398"></a>00398             streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;ECAL criteria *not* reached. &quot;</span>
<a name="l00399"></a>00399                                   &lt;&lt; <span class="stringliteral">&quot;Event will be skipped.&quot;</span> &lt;&lt; endl;
<a name="l00400"></a>00400           }
<a name="l00401"></a>00401       }
<a name="l00402"></a>00402     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_useTCMT == <span class="keyword">true</span>)
<a name="l00403"></a>00403       {
<a name="l00404"></a>00404         <span class="comment">// TCMT information</span>
<a name="l00405"></a>00405         std::pair&lt;int, float&gt; nhits_and_esum = <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a1799da6da5db2cbf5de0e458ccbe3566" title="Extract number of hits and the energy sum from the input collection.">extractNumberOfHitsAndEnergySum</a>(<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a961a3ce5cad59157ae7cc350da27017b" title="TCMT input collection.">_tcmtInputCol</a>);
<a name="l00406"></a>00406         <span class="keywordtype">float</span> tcmtEnergySum = nhits_and_esum.second;
<a name="l00407"></a>00407         
<a name="l00408"></a>00408         <span class="keywordflow">if</span>((tcmtEnergySum &gt; <a class="code" href="classCALICE_1_1AngleTrackFinder.html#ab5ac7f274d7c9936f4d19ed1ac463715" title="minimum energy sum in the TCMT">_tcmtMinEnergySum</a>))
<a name="l00409"></a>00409           {
<a name="l00410"></a>00410             analyse = <span class="keyword">true</span>;
<a name="l00411"></a>00411             streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;TCMT criteria reached. &quot;</span>
<a name="l00412"></a>00412                                   &lt;&lt; <span class="stringliteral">&quot;Going to do further processing.&quot;</span> &lt;&lt; endl;
<a name="l00413"></a>00413           }
<a name="l00414"></a>00414         <span class="keywordflow">else</span>
<a name="l00415"></a>00415           {
<a name="l00416"></a>00416             analyse = <span class="keyword">false</span>;
<a name="l00417"></a>00417             streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;TCMT criteria *not* reached. &quot;</span>
<a name="l00418"></a>00418                                   &lt;&lt; <span class="stringliteral">&quot;Event will be skipped.&quot;</span> &lt;&lt; endl;
<a name="l00419"></a>00419           }
<a name="l00420"></a>00420       }
<a name="l00421"></a>00421     <span class="keywordflow">else</span> 
<a name="l00422"></a>00422       {
<a name="l00423"></a>00423         <span class="keywordflow">if</span> (<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a599998d50ef67e2bc2e9a07b0864dd3d" title="flag for non-muon run">_isNonMuonRun</a> == <span class="keyword">true</span>) 
<a name="l00424"></a>00424           {
<a name="l00425"></a>00425             <span class="comment">/* this is just for non-muon runs case!*/</span>
<a name="l00426"></a>00426             std::pair&lt;int, float&gt; nhits_and_esum(<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a1799da6da5db2cbf5de0e458ccbe3566" title="Extract number of hits and the energy sum from the input collection.">extractNumberOfHitsAndEnergySum</a>(<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a6294fed90962d5ecaf2d63f4f119c808" title="AHCAL input collection.">_ahcalInputCol</a>));
<a name="l00427"></a>00427             <span class="keywordtype">int</span> nhits_hcal = nhits_and_esum.first;
<a name="l00428"></a>00428             streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;hcal hits &quot;</span> &lt;&lt; nhits_hcal &lt;&lt; endl;
<a name="l00429"></a>00429             
<a name="l00430"></a>00430             <span class="comment">// FIXME this check makes no sense here since there are always hits in every cell</span>
<a name="l00431"></a>00431             <span class="comment">// check is done in findTrack instead</span>
<a name="l00432"></a>00432             <span class="keywordflow">if</span> (nhits_hcal &lt; <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a94a071cd5fbe48451c8aace1168f9697" title="maximum number of hits in the AHCAL">_ahcalMaxNoHits</a>) 
<a name="l00433"></a>00433               {
<a name="l00434"></a>00434                 analyse = <span class="keyword">true</span>;
<a name="l00435"></a>00435               } 
<a name="l00436"></a>00436             <span class="keywordflow">else</span> 
<a name="l00437"></a>00437               {
<a name="l00438"></a>00438                 analyse = <span class="keyword">true</span>;
<a name="l00439"></a>00439               }
<a name="l00440"></a>00440           } 
<a name="l00441"></a>00441         <span class="keywordflow">else</span> 
<a name="l00442"></a>00442           {
<a name="l00443"></a>00443             analyse = <span class="keyword">true</span>;
<a name="l00444"></a>00444           }
<a name="l00445"></a>00445         streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;  -&gt;AHCAL only analysis will start.&quot;</span> &lt;&lt; endl;
<a name="l00446"></a>00446       }
<a name="l00447"></a>00447     
<a name="l00448"></a>00448     <span class="keywordflow">return</span> analyse;
<a name="l00449"></a>00449   }
<a name="l00450"></a>00450   
<a name="l00451"></a>00451   <span class="comment">/******************************************************************************/</span>
<a name="l00452"></a>00452   <span class="comment">/*                                                                            */</span>
<a name="l00453"></a>00453   <span class="comment">/*                                                                            */</span>
<a name="l00454"></a>00454   <span class="comment">/*                                                                            */</span>
<a name="l00455"></a>00455   <span class="comment">/******************************************************************************/</span>
<a name="l00456"></a><a class="code" href="classCALICE_1_1AngleTrackFinder.html#a1799da6da5db2cbf5de0e458ccbe3566">00456</a>   std::pair&lt;int, float&gt; <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a1799da6da5db2cbf5de0e458ccbe3566" title="Extract number of hits and the energy sum from the input collection.">AngleTrackFinder::extractNumberOfHitsAndEnergySum</a>(LCCollection *inputCol) 
<a name="l00457"></a>00457   {
<a name="l00458"></a>00458     <span class="keywordtype">float</span> energySum = 0;
<a name="l00459"></a>00459     <span class="keyword">const</span> <span class="keywordtype">int</span> numberOfHits = inputCol-&gt;getNumberOfElements();
<a name="l00460"></a>00460     
<a name="l00461"></a>00461     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numberOfHits; ++i) 
<a name="l00462"></a>00462       {
<a name="l00463"></a>00463         CalorimeterHit *hit = <span class="keyword">dynamic_cast&lt;</span>CalorimeterHit*<span class="keyword">&gt;</span> (inputCol-&gt;getElementAt(i));
<a name="l00464"></a>00464         energySum += hit-&gt;getEnergy();
<a name="l00465"></a>00465       }<span class="comment">/*end loop over input collection*/</span>
<a name="l00466"></a>00466     
<a name="l00467"></a>00467     <span class="keywordflow">return</span> std::pair&lt;int, float&gt;(numberOfHits, energySum);
<a name="l00468"></a>00468   }
<a name="l00469"></a>00469   
<a name="l00470"></a>00470   <span class="comment">/******************************************************************************/</span>
<a name="l00471"></a>00471   <span class="comment">/*                                                                            */</span>
<a name="l00472"></a>00472   <span class="comment">/*                                                                            */</span>
<a name="l00473"></a>00473   <span class="comment">/*                                                                            */</span>
<a name="l00474"></a>00474   <span class="comment">/******************************************************************************/</span>
<a name="l00475"></a><a class="code" href="classCALICE_1_1AngleTrackFinder.html#a86fc7e637d10c7ee1ab9851b1fc54e1b">00475</a>   std::vector&lt;CalorimeterHit*&gt; <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a86fc7e637d10c7ee1ab9851b1fc54e1b" title="Extract AHCAL information.">AngleTrackFinder::extractAHCALInformation</a>() 
<a name="l00476"></a>00476   {
<a name="l00477"></a>00477     streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;\n extractAHCALInformation:&quot;</span> &lt;&lt; endl;
<a name="l00478"></a>00478     <span class="comment">/*check if there is a list of bad modules*/</span>
<a name="l00479"></a>00479     <span class="keywordtype">bool</span> haveListOfBadModules = parameterSet(<span class="stringliteral">&quot;AHCALBadModules&quot;</span>);
<a name="l00480"></a>00480     
<a name="l00481"></a>00481     streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;  haveListOfBadModules: &quot;</span> &lt;&lt; haveListOfBadModules &lt;&lt; endl;
<a name="l00482"></a>00482     
<a name="l00483"></a>00483     LCTypedVector&lt;CalorimeterHit&gt; hcalVec(<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a6294fed90962d5ecaf2d63f4f119c808" title="AHCAL input collection.">_ahcalInputCol</a>);
<a name="l00484"></a>00484     <a class="code" href="classCALICE_1_1AngleTrackFinder.html#aef20f858c612a3181537606fdc4be0f1" title="vector containing all AHCAL hits from the event">_allAhcalHitsInEventVec</a> = hcalVec;
<a name="l00485"></a>00485     std::vector&lt;CalorimeterHit*&gt; selectedHcalHitsVec;
<a name="l00486"></a>00486     
<a name="l00487"></a>00487     <span class="comment">/*counter for debug purposes*/</span>
<a name="l00488"></a>00488     <span class="keywordtype">int</span> counter = 0;
<a name="l00489"></a>00489         
<a name="l00490"></a>00490     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iHits = 0; iHits &lt; hcalVec.size(); ++iHits) 
<a name="l00491"></a>00491       {
<a name="l00492"></a>00492         <span class="keyword">const</span> <span class="keywordtype">int</span> cellID = hcalVec[iHits]-&gt;getCellID0();
<a name="l00493"></a>00493         <span class="keyword">const</span> <span class="keywordtype">int</span> module = <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a1e8ade0f953c3f0e73665cf8bb6fc58f" title="the mapper">_mapper</a>-&gt;getModuleFromCellID(cellID);
<a name="l00494"></a>00494         
<a name="l00495"></a>00495         <span class="keywordtype">bool</span> hitIsInBadModule = <span class="keyword">false</span>;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497         <span class="keywordflow">if</span> (haveListOfBadModules == <span class="keyword">true</span>) 
<a name="l00498"></a>00498           {
<a name="l00499"></a>00499             <span class="keywordflow">if</span> (std::find(<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a6d4442136ce5b168d27f32f3f753164c" title="vector of bad AHCAL modules numbers">_badAhcalModulesVec</a>.begin(), <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a6d4442136ce5b168d27f32f3f753164c" title="vector of bad AHCAL modules numbers">_badAhcalModulesVec</a>.end(), module) != <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a6d4442136ce5b168d27f32f3f753164c" title="vector of bad AHCAL modules numbers">_badAhcalModulesVec</a>.end())
<a name="l00500"></a>00500               hitIsInBadModule = <span class="keyword">true</span>;
<a name="l00501"></a>00501             
<a name="l00502"></a>00502             <span class="keywordflow">if</span> (hitIsInBadModule) 
<a name="l00503"></a>00503               {
<a name="l00504"></a>00504                 streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot; -&gt; &quot;</span> &lt;&lt; counter &lt;&lt; <span class="stringliteral">&quot; hit in module &quot;</span>
<a name="l00505"></a>00505                               &lt;&lt; module &lt;&lt; <span class="stringliteral">&quot;-&gt; on list of bad modules&quot;</span> &lt;&lt; endl;
<a name="l00506"></a>00506               } 
<a name="l00507"></a>00507             <span class="keywordflow">else</span> 
<a name="l00508"></a>00508               {
<a name="l00509"></a>00509                 streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot; -&gt; &quot;</span> &lt;&lt; counter &lt;&lt; <span class="stringliteral">&quot; hit in module &quot;</span>
<a name="l00510"></a>00510                               &lt;&lt; module &lt;&lt; <span class="stringliteral">&quot;-&gt; NOT on list of bad modules&quot;</span> &lt;&lt; endl;
<a name="l00511"></a>00511               }
<a name="l00512"></a>00512           }
<a name="l00513"></a>00513 
<a name="l00514"></a>00514         <span class="comment">// get the amplitude without temperature correction</span>
<a name="l00515"></a>00515         <span class="keywordtype">float</span> ampMipNoTempNoSat = 0.;
<a name="l00516"></a>00516         
<a name="l00517"></a>00517         <span class="keywordflow">if</span> (_mipCutVariable == 0) 
<a name="l00518"></a>00518           {
<a name="l00519"></a>00519             <span class="keyword">const</span> LCObjectVec &amp;amplVec = _navigator-&gt;getRelatedToObjects(hcalVec[iHits]);
<a name="l00520"></a>00520             
<a name="l00521"></a>00521             <span class="keywordflow">if</span> (amplVec.size() &gt; 0) 
<a name="l00522"></a>00522               {
<a name="l00523"></a>00523                 LCGenericObject *obj = <span class="keyword">dynamic_cast&lt;</span>LCGenericObject*<span class="keyword">&gt;</span> (amplVec[0]);
<a name="l00524"></a>00524                 AhcAmplitude *ahcAmpl = <span class="keyword">new</span> AhcAmplitude(obj);
<a name="l00525"></a>00525                 ampMipNoTempNoSat = ahcAmpl-&gt;getAmplNOTTemperatureCorrMIP();
<a name="l00526"></a>00526                 <span class="keyword">delete</span> ahcAmpl;
<a name="l00527"></a>00527               }
<a name="l00528"></a>00528           }
<a name="l00529"></a>00529         
<a name="l00530"></a>00530         <span class="comment">/* get the amplitude after temperature correction &amp; saturated corrected*/</span>      
<a name="l00531"></a>00531         <span class="keywordtype">float</span> ampMipFinal = hcalVec[iHits]-&gt;getEnergy();
<a name="l00532"></a>00532         
<a name="l00533"></a>00533         <span class="comment">/* choose amplitude to be used*/</span>      
<a name="l00534"></a>00534         <span class="keywordtype">float</span> mipCut = 0;
<a name="l00535"></a>00535         <span class="keywordflow">if</span> (_mipCutVariable == 1)
<a name="l00536"></a>00536           {
<a name="l00537"></a>00537             mipCut = ampMipFinal;
<a name="l00538"></a>00538           } 
<a name="l00539"></a>00539         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_mipCutVariable == 0) 
<a name="l00540"></a>00540           {
<a name="l00541"></a>00541             mipCut = ampMipNoTempNoSat;
<a name="l00542"></a>00542           }
<a name="l00543"></a>00543         
<a name="l00544"></a>00544         <span class="comment">// Now do the selection(!)</span>
<a name="l00545"></a>00545         <span class="keywordtype">bool</span> isBadHit = ((haveListOfBadModules == <span class="keyword">true</span> &amp;&amp; hitIsInBadModule == <span class="keyword">true</span>) || (mipCut &lt; <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a09632c19bf97a231d9ab2c1e6e32cc78" title="MIP cut value (0.5 MIPs).">_mipCutValue</a>));
<a name="l00546"></a>00546         <span class="keywordflow">if</span> (isBadHit == <span class="keyword">false</span>) selectedHcalHitsVec.push_back(hcalVec[iHits]);
<a name="l00547"></a>00547       }
<a name="l00548"></a>00548     
<a name="l00549"></a>00549     streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot; -&gt; &quot;</span> &lt;&lt; counter
<a name="l00550"></a>00550                   &lt;&lt; <span class="stringliteral">&quot; hits do not fullfill MIP cut and/or are in bad modules&quot;</span>
<a name="l00551"></a>00551                   &lt;&lt; endl;
<a name="l00552"></a>00552     streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot; -&gt; selected AHCAL hits: &quot;</span> &lt;&lt; hcalVec.size() &lt;&lt; endl;
<a name="l00553"></a>00553     
<a name="l00554"></a>00554     
<a name="l00555"></a>00555     
<a name="l00556"></a>00556     <span class="keywordflow">return</span> selectedHcalHitsVec;
<a name="l00557"></a>00557   }
<a name="l00558"></a>00558   <span class="comment">/******************************************************************************/</span>
<a name="l00559"></a>00559   <span class="comment">/*                                                                            */</span>
<a name="l00560"></a>00560   <span class="comment">/*                                                                            */</span>
<a name="l00561"></a>00561   <span class="comment">/*                                                                            */</span>
<a name="l00562"></a>00562   <span class="comment">/******************************************************************************/</span>
<a name="l00563"></a><a class="code" href="classCALICE_1_1AngleTrackFinder.html#a24fd651c00cb89fa736943ee252ff5fc">00563</a>   <span class="keywordtype">void</span> <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a24fd651c00cb89fa736943ee252ff5fc" title="Find clusters of MIP tracks.">AngleTrackFinder::findTrackClusters</a>(std::vector&lt;CalorimeterHit*&gt; &amp;hcalVec, EVENT::ClusterVec &amp;clusterVec) 
<a name="l00564"></a>00564   {
<a name="l00565"></a>00565     streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;\n--------------- Start to find track clusters&quot;</span> &lt;&lt; endl;
<a name="l00566"></a>00566     
<a name="l00567"></a>00567     clusterVec.clear();
<a name="l00568"></a>00568 
<a name="l00569"></a>00569     LCTypedVector&lt;CalorimeterHit&gt;::iterator seedIter = hcalVec.begin();
<a name="l00570"></a>00570     <span class="keywordflow">while</span> (seedIter != hcalVec.end()) 
<a name="l00571"></a>00571       {
<a name="l00572"></a>00572         CalorimeterHit *seedHit = (*seedIter);
<a name="l00573"></a>00573         <span class="keyword">const</span> <span class="keywordtype">int</span> cellID = (*seedIter)-&gt;getCellID0();
<a name="l00574"></a>00574         <span class="comment">/*erase seed hit*/</span>
<a name="l00575"></a>00575         hcalVec.erase(seedIter);
<a name="l00576"></a>00576         
<a name="l00577"></a>00577         <span class="comment">/*use only hits in fine modules to find tracks*/</span>
<a name="l00578"></a>00578         <span class="keyword">const</span> <span class="keywordtype">int</span> K = <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a1e8ade0f953c3f0e73665cf8bb6fc58f" title="the mapper">_mapper</a>-&gt;getDecoder()-&gt;getKFromCellID(cellID);
<a name="l00579"></a>00579         
<a name="l00580"></a>00580         <span class="keywordflow">if</span> (K &lt;= 30) 
<a name="l00581"></a>00581           {
<a name="l00582"></a>00582             ClusterImpl *cluster = <span class="keyword">new</span> ClusterImpl;
<a name="l00583"></a>00583             <span class="comment">/*first member of the cluster is the seed hit*/</span>
<a name="l00584"></a>00584             cluster-&gt;addHit(seedHit, 1.);
<a name="l00585"></a>00585             
<a name="l00586"></a>00586             LCTypedVector&lt;CalorimeterHit&gt;::iterator potentialTrackHitIter = hcalVec.begin();
<a name="l00587"></a>00587             <span class="keywordflow">while</span> (potentialTrackHitIter != hcalVec.end()) 
<a name="l00588"></a>00588               {
<a name="l00589"></a>00589                 <span class="keywordtype">float</span> differenceInX = fabs((*potentialTrackHitIter)-&gt;getPosition()[0] - seedHit-&gt;getPosition()[0]);
<a name="l00590"></a>00590                 <span class="keywordtype">float</span> differenceInY = fabs((*potentialTrackHitIter)-&gt;getPosition()[1] - seedHit-&gt;getPosition()[1]);
<a name="l00591"></a>00591                 
<a name="l00592"></a>00592                 CellDescription* seedHitCellDescription = _cellDescriptions-&gt;getByCellID(cellID);
<a name="l00593"></a>00593                 <span class="keyword">const</span> <span class="keywordtype">float</span> seedHitTileSize             = seedHitCellDescription-&gt;getSizeX();
<a name="l00594"></a>00594                 <span class="keyword">const</span> <span class="keywordtype">float</span> potentialTrackHitTileSize   = _cellDescriptions-&gt;getByCellID((*potentialTrackHitIter)-&gt;getCellID0())-&gt;getSizeX();
<a name="l00595"></a>00595                 
<a name="l00596"></a>00596                 <span class="keywordtype">float</span> meanCellSize = 0.5 * (potentialTrackHitTileSize + seedHitTileSize);
<a name="l00597"></a>00597                 
<a name="l00598"></a>00598                 <span class="keywordflow">if</span> (differenceInX &lt; meanCellSize &amp;&amp; differenceInY &lt; meanCellSize) 
<a name="l00599"></a>00599                   {
<a name="l00600"></a>00600                     streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot; New track hit found &quot;</span> &lt;&lt; endl;
<a name="l00601"></a>00601                     
<a name="l00602"></a>00602                     <span class="comment">/*add hit to the track cluster*/</span>
<a name="l00603"></a>00603                     cluster-&gt;addHit((*potentialTrackHitIter), 1.);
<a name="l00604"></a>00604                     
<a name="l00605"></a>00605                     <span class="comment">/*erase track hit from the HCAL seeds vector*/</span>
<a name="l00606"></a>00606                     potentialTrackHitIter = hcalVec.erase(potentialTrackHitIter);
<a name="l00607"></a>00607                   } 
<a name="l00608"></a>00608                 <span class="keywordflow">else</span> 
<a name="l00609"></a>00609                   {
<a name="l00610"></a>00610                     ++potentialTrackHitIter;
<a name="l00611"></a>00611                   }
<a name="l00612"></a>00612               }<span class="comment">/*------------- end loop over potential track hits -------------------*/</span>
<a name="l00613"></a>00613             
<a name="l00614"></a>00614             clusterVec.push_back(cluster);
<a name="l00615"></a>00615             
<a name="l00616"></a>00616           }<span class="comment">/*----------------- end loop over fine layers ----------------------------*/</span>
<a name="l00617"></a>00617         
<a name="l00618"></a>00618         seedIter = hcalVec.begin();
<a name="l00619"></a>00619       }<span class="comment">/*--------------------- end loop over AHCAL seed hits ------------------------*/</span>
<a name="l00620"></a>00620     
<a name="l00621"></a>00621 
<a name="l00622"></a>00622     streamlog_out(DEBUG)&lt;&lt;<span class="stringliteral">&quot;\n findTrackClusters: found &quot;</span>&lt;&lt;clusterVec.size()&lt;&lt;<span class="stringliteral">&quot; track clusters&quot;</span>&lt;&lt;endl;
<a name="l00623"></a>00623   }
<a name="l00624"></a>00624   
<a name="l00625"></a>00625   
<a name="l00626"></a>00626   <span class="comment">/******************************************************************************/</span>
<a name="l00627"></a>00627   <span class="comment">/*                                                                            */</span>
<a name="l00628"></a>00628   <span class="comment">/*                                                                            */</span>
<a name="l00629"></a>00629   <span class="comment">/*                                                                            */</span>
<a name="l00630"></a>00630   <span class="comment">/******************************************************************************/</span>
<a name="l00631"></a>00631   <span class="keywordtype">void</span> AngleTrackFinder::findTrackClustersCoarse(std::vector&lt;CalorimeterHit*&gt; &amp;hcalVec, EVENT::ClusterVec &amp;clusterCoarseVec) 
<a name="l00632"></a>00632   {
<a name="l00633"></a>00633     streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot;\n--------------- Start to find track clusters&quot;</span> &lt;&lt; endl;
<a name="l00634"></a>00634     
<a name="l00635"></a>00635     clusterCoarseVec.clear();
<a name="l00636"></a>00636  
<a name="l00637"></a>00637     LCTypedVector&lt;CalorimeterHit&gt;::iterator seedIter = hcalVec.begin();
<a name="l00638"></a>00638     <span class="keywordflow">while</span> (seedIter != hcalVec.end()) 
<a name="l00639"></a>00639       {
<a name="l00640"></a>00640         CalorimeterHit *seedHit = (*seedIter);
<a name="l00641"></a>00641         <span class="keyword">const</span> <span class="keywordtype">int</span> cellID = seedHit-&gt;getCellID0();
<a name="l00642"></a>00642         <span class="comment">/*erase seed hit*/</span>
<a name="l00643"></a>00643         hcalVec.erase(seedIter);
<a name="l00644"></a>00644         
<a name="l00645"></a>00645         <span class="comment">/*use only hits in the coarse modules to find the last track segment of the track*/</span>
<a name="l00646"></a>00646         <span class="keyword">const</span> <span class="keywordtype">int</span> K = <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a1e8ade0f953c3f0e73665cf8bb6fc58f" title="the mapper">_mapper</a>-&gt;getDecoder()-&gt;getKFromCellID(cellID);
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 
<a name="l00649"></a>00649         <span class="keywordflow">if</span> (K &gt; 30) 
<a name="l00650"></a>00650           {
<a name="l00651"></a>00651             ClusterImpl *cluster = <span class="keyword">new</span> ClusterImpl;
<a name="l00652"></a>00652             <span class="comment">/*first member of the cluster is the seed hit*/</span>
<a name="l00653"></a>00653             cluster-&gt;addHit(seedHit, 1.);
<a name="l00654"></a>00654             
<a name="l00655"></a>00655             LCTypedVector&lt;CalorimeterHit&gt;::iterator potentialTrackHitIter = hcalVec.begin();
<a name="l00656"></a>00656             
<a name="l00657"></a>00657             <span class="keywordflow">while</span> (potentialTrackHitIter != hcalVec.end()) 
<a name="l00658"></a>00658               {
<a name="l00659"></a>00659                 <span class="keywordtype">float</span> differenceInX = fabs((*potentialTrackHitIter)-&gt;getPosition()[0]
<a name="l00660"></a>00660                                            - seedHit-&gt;getPosition()[0]);
<a name="l00661"></a>00661                 <span class="keywordtype">float</span> differenceInY = fabs((*potentialTrackHitIter)-&gt;getPosition()[1]
<a name="l00662"></a>00662                                            - seedHit-&gt;getPosition()[1]);
<a name="l00663"></a>00663                 
<a name="l00664"></a>00664                 CellDescription* seedHitCellDescription =_cellDescriptions-&gt;getByCellID(cellID);
<a name="l00665"></a>00665                 <span class="keyword">const</span> <span class="keywordtype">float</span> seedHitTileSize = seedHitCellDescription-&gt;getSizeX();
<a name="l00666"></a>00666                 <span class="keyword">const</span> <span class="keywordtype">float</span> potentialTrackHitTileSize = _cellDescriptions-&gt;getByCellID((*potentialTrackHitIter)-&gt;getCellID0())-&gt;getSizeX();
<a name="l00667"></a>00667                 
<a name="l00668"></a>00668                 <span class="keywordtype">float</span> meanCellSize = 0.5 * (potentialTrackHitTileSize + seedHitTileSize);
<a name="l00669"></a>00669                 
<a name="l00670"></a>00670                 <span class="comment">/* do not take again the layers in fine section*/</span>
<a name="l00671"></a>00671                 <span class="keyword">const</span> <span class="keywordtype">int</span> cellIDP = (*potentialTrackHitIter)-&gt;getCellID0();
<a name="l00672"></a>00672                 HcalCellIndex geomIndexP(cellIDP);
<a name="l00673"></a>00673                 <span class="keywordtype">int</span> layernum = geomIndexP.getLayerIndex();
<a name="l00674"></a>00674                 
<a name="l00675"></a>00675                 <span class="keywordflow">if</span> (differenceInX &lt; meanCellSize &amp;&amp; differenceInY &lt; meanCellSize &amp;&amp; layernum &gt; 30) 
<a name="l00676"></a>00676                   {
<a name="l00677"></a>00677                     streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot; New track hit found &quot;</span> &lt;&lt; endl;
<a name="l00678"></a>00678                     
<a name="l00679"></a>00679                     <span class="comment">/*add hit to the track cluster*/</span>
<a name="l00680"></a>00680                     cluster-&gt;addHit((*potentialTrackHitIter), 1.);
<a name="l00681"></a>00681                     <span class="comment">/*erase track hit from the HCAL seeds vector*/</span>
<a name="l00682"></a>00682                     potentialTrackHitIter = hcalVec.erase(potentialTrackHitIter);
<a name="l00683"></a>00683                   }
<a name="l00684"></a>00684                 <span class="keywordflow">else</span> 
<a name="l00685"></a>00685                   {
<a name="l00686"></a>00686                     ++potentialTrackHitIter;
<a name="l00687"></a>00687                   }
<a name="l00688"></a>00688               }<span class="comment">/*------------- end loop over potential track hits -------------------*/</span>
<a name="l00689"></a>00689             
<a name="l00690"></a>00690             clusterCoarseVec.push_back(cluster);
<a name="l00691"></a>00691           }<span class="comment">/*----------------- end loop over fine layers ----------------------------*/</span>
<a name="l00692"></a>00692         
<a name="l00693"></a>00693         seedIter = hcalVec.begin();
<a name="l00694"></a>00694       }<span class="comment">/*--------------------- end loop over AHCAL seed hits ------------------------*/</span>
<a name="l00695"></a>00695     
<a name="l00696"></a>00696 
<a name="l00697"></a>00697     streamlog_out(DEBUG)&lt;&lt; <span class="stringliteral">&quot;\n findTrackClustersCoarse: Number of tracks in coarse section: &quot;</span> &lt;&lt; clusterCoarseVec.size() &lt;&lt; endl;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699   }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701   <span class="comment">/******************************************************************************/</span>
<a name="l00702"></a>00702   <span class="comment">/*                                                                            */</span>
<a name="l00703"></a>00703   <span class="comment">/*                                                                            */</span>
<a name="l00704"></a>00704   <span class="comment">/*                                                                            */</span>
<a name="l00705"></a>00705   <span class="comment">/******************************************************************************/</span>
<a name="l00706"></a>00706   EVENT::ClusterVec AngleTrackFinder::extendTracksToTcmt(LCTypedVector&lt;CalorimeterHit&gt; tcmtHits, EVENT::ClusterVec trackClusters) 
<a name="l00707"></a>00707   {
<a name="l00708"></a>00708     streamlog_out(DEBUG0) &lt;&lt; <span class="stringliteral">&quot;Tail catcher hits: &quot;</span> &lt;&lt; tcmtHits.size() &lt;&lt; endl;
<a name="l00709"></a>00709     streamlog_out(DEBUG0) &lt;&lt; <span class="stringliteral">&quot;Track candidates to extend: &quot;</span> &lt;&lt; trackClusters.size()
<a name="l00710"></a>00710                   &lt;&lt; endl;
<a name="l00711"></a>00711     
<a name="l00712"></a>00712     <span class="comment">/* get the cellID decoder for the TCMT hits*/</span>
<a name="l00713"></a>00713     FastDecoder * decoder_k = FastDecoder::generateDecoder(<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a961a3ce5cad59157ae7cc350da27017b" title="TCMT input collection.">_tcmtInputCol</a>-&gt;getParameters().getStringVal(<span class="stringliteral">&quot;CellIDEncoding&quot;</span>), <span class="stringliteral">&quot;K&quot;</span>);
<a name="l00714"></a>00714     
<a name="l00715"></a>00715     <span class="keywordflow">for</span> (ClusterVec::iterator iTrack = trackClusters.begin(); iTrack != trackClusters.end(); ++iTrack) 
<a name="l00716"></a>00716       {
<a name="l00717"></a>00717         <span class="comment">/* make the track modifyable*/</span>
<a name="l00718"></a>00718         ClusterImpl* track = (ClusterImpl*) (*iTrack);
<a name="l00719"></a>00719         CalorimeterHitVec trackHits = track-&gt;getCalorimeterHits();
<a name="l00720"></a>00720 
<a name="l00721"></a>00721         streamlog_out(DEBUG0) &lt;&lt; <span class="stringliteral">&quot;Track size before: &quot;</span> &lt;&lt; trackHits.size() &lt;&lt; endl;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723         <span class="keywordflow">if</span> (trackHits.size() == 0) 
<a name="l00724"></a>00724           {
<a name="l00725"></a>00725             streamlog_out(DEBUG0) &lt;&lt; <span class="stringliteral">&quot;No hits in track. Continue with next track.&quot;</span>
<a name="l00726"></a>00726                           &lt;&lt; endl;
<a name="l00727"></a>00727             <span class="keywordflow">continue</span>;
<a name="l00728"></a>00728           }
<a name="l00729"></a>00729         
<a name="l00730"></a>00730         <span class="comment">/* find the first and last hit in the track candidate*/</span>
<a name="l00731"></a>00731         CalorimeterHit* firstHit = 0;
<a name="l00732"></a>00732         CalorimeterHit* lastHit = 0;
<a name="l00733"></a>00733         <span class="keywordtype">float</span> zMin = numeric_limits&lt;float&gt;::max();
<a name="l00734"></a>00734         <span class="keywordtype">float</span> zMax = -numeric_limits&lt;float&gt;::max();
<a name="l00735"></a>00735 
<a name="l00736"></a>00736         <span class="keywordflow">for</span> (CalorimeterHitVec::iterator iHit = trackHits.begin(); iHit != trackHits.end(); ++iHit) 
<a name="l00737"></a>00737           {
<a name="l00738"></a>00738             <span class="keywordflow">if</span> ((*iHit)-&gt;getPosition()[2] &lt; zMin) 
<a name="l00739"></a>00739               {
<a name="l00740"></a>00740                 firstHit = *iHit;
<a name="l00741"></a>00741                 zMin = firstHit-&gt;getPosition()[2];
<a name="l00742"></a>00742               }
<a name="l00743"></a>00743             <span class="keywordflow">if</span> ((*iHit)-&gt;getPosition()[2] &gt; zMax) 
<a name="l00744"></a>00744               {
<a name="l00745"></a>00745                 lastHit = *iHit;
<a name="l00746"></a>00746                 zMax = lastHit-&gt;getPosition()[2];
<a name="l00747"></a>00747               }
<a name="l00748"></a>00748           }
<a name="l00749"></a>00749         
<a name="l00750"></a>00750         streamlog_out(DEBUG0) &lt;&lt; <span class="stringliteral">&quot;Last track hit: &quot;</span> &lt;&lt; lastHit-&gt;getCellID0() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
<a name="l00751"></a>00751                       &lt;&lt; lastHit-&gt;getCellID1() &lt;&lt; endl;
<a name="l00752"></a>00752         
<a name="l00753"></a>00753         <span class="comment">/* get x-y position of last hit and cell size*/</span>
<a name="l00754"></a>00754         <span class="keyword">const</span> <span class="keywordtype">float</span> xPos = lastHit-&gt;getPosition()[0];
<a name="l00755"></a>00755         <span class="keyword">const</span> <span class="keywordtype">float</span> yPos = lastHit-&gt;getPosition()[1];
<a name="l00756"></a>00756         
<a name="l00757"></a>00757         <span class="comment">/* calculate the slope along the track*/</span>
<a name="l00758"></a>00758         <span class="keyword">const</span> <span class="keywordtype">float</span> xSlope = (xPos - firstHit-&gt;getPosition()[0]) / (zMax - zMin);
<a name="l00759"></a>00759         <span class="keyword">const</span> <span class="keywordtype">float</span> ySlope = (yPos - firstHit-&gt;getPosition()[1]) / (zMax - zMin);
<a name="l00760"></a>00760 
<a name="l00761"></a>00761         streamlog_out(DEBUG0) &lt;&lt; <span class="stringliteral">&quot;Track: x &quot;</span> &lt;&lt; xPos &lt;&lt; <span class="stringliteral">&quot;, y &quot;</span> &lt;&lt; yPos &lt;&lt; <span class="stringliteral">&quot;, z &quot;</span>
<a name="l00762"></a>00762                       &lt;&lt; zMax &lt;&lt; <span class="stringliteral">&quot;, x-slope &quot;</span> &lt;&lt; xSlope &lt;&lt; <span class="stringliteral">&quot;, y-slope &quot;</span> &lt;&lt; ySlope
<a name="l00763"></a>00763                       &lt;&lt; endl;
<a name="l00764"></a>00764         
<a name="l00765"></a>00765         <span class="keywordflow">for</span> (CalorimeterHitVec::iterator iHit = tcmtHits.begin(); iHit != tcmtHits.end(); ++iHit) 
<a name="l00766"></a>00766           {
<a name="l00767"></a>00767             CalorimeterHitImpl* tcmtHit = (CalorimeterHitImpl*) *iHit;
<a name="l00768"></a>00768             <span class="keyword">const</span> <span class="keywordtype">float</span> x = tcmtHit-&gt;getPosition()[0];
<a name="l00769"></a>00769             <span class="keyword">const</span> <span class="keywordtype">float</span> y = tcmtHit-&gt;getPosition()[1];
<a name="l00770"></a>00770             <span class="keyword">const</span> <span class="keywordtype">float</span> z = tcmtHit-&gt;getPosition()[2];
<a name="l00771"></a>00771             
<a name="l00772"></a>00772             <span class="comment">/* FIXME should be obtained from the mapping instead*/</span>
<a name="l00773"></a>00773             <span class="keyword">const</span> <span class="keywordtype">float</span> stripWidth = _tcmtStripWidth;
<a name="l00774"></a>00774             
<a name="l00775"></a>00775             <span class="comment">/* obtain strip orientation from k position of layer*/</span>
<a name="l00776"></a>00776             <span class="comment">/* FIXME should be obtained in a direct way instead of having to know the orientation of the first layer*/</span>
<a name="l00777"></a>00777             <span class="keywordtype">bool</span> horizontalStrip = <span class="keyword">false</span>;
<a name="l00778"></a>00778             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k_pos = decoder_k-&gt;decodeU(tcmtHit-&gt;getCellID0());
<a name="l00779"></a>00779             <span class="keywordflow">if</span> (_tcmtStartVertical)
<a name="l00780"></a>00780               horizontalStrip = (k_pos % 2 ? <span class="keyword">true</span> : <span class="keyword">false</span>);
<a name="l00781"></a>00781             <span class="keywordflow">else</span>
<a name="l00782"></a>00782               horizontalStrip = (k_pos % 2 ? <span class="keyword">false</span> : <span class="keyword">true</span>);
<a name="l00783"></a>00783             
<a name="l00784"></a>00784             <span class="comment">/* extrapolate track to tcmt hit*/</span>
<a name="l00785"></a>00785             <span class="keyword">const</span> <span class="keywordtype">float</span> xExt = (z - zMax) * xSlope + xPos;
<a name="l00786"></a>00786             <span class="keyword">const</span> <span class="keywordtype">float</span> yExt = (z - zMax) * ySlope + yPos;
<a name="l00787"></a>00787             
<a name="l00788"></a>00788             streamlog_out(DEBUG0) &lt;&lt; <span class="stringliteral">&quot;TailCatcherHit: x &quot;</span> &lt;&lt; x &lt;&lt; <span class="stringliteral">&quot;, y &quot;</span> &lt;&lt; y &lt;&lt; <span class="stringliteral">&quot;, z &quot;</span>
<a name="l00789"></a>00789                           &lt;&lt; z &lt;&lt; <span class="stringliteral">&quot; horizontalStrip = &quot;</span>&lt;&lt;horizontalStrip&lt;&lt;<span class="stringliteral">&quot; energy=&quot;</span>&lt;&lt;tcmtHit-&gt;getEnergy()&lt;&lt;endl;
<a name="l00790"></a>00790             streamlog_out(DEBUG0) &lt;&lt; <span class="stringliteral">&quot;TcmtHitExtrapolation: x&apos; &quot;</span> &lt;&lt; xExt &lt;&lt; <span class="stringliteral">&quot;, y&apos; &quot;</span>
<a name="l00791"></a>00791                           &lt;&lt; yExt &lt;&lt; <span class="stringliteral">&quot;, z&apos; &quot;</span> &lt;&lt; z &lt;&lt; endl;
<a name="l00792"></a>00792             
<a name="l00793"></a>00793 
<a name="l00794"></a>00794             <span class="comment">/* Check if hit is compatible with track extrapolation, allow distance of strip width*/</span>
<a name="l00795"></a>00795             <span class="keywordtype">bool</span> match = <span class="keyword">false</span>;
<a name="l00796"></a>00796             
<a name="l00797"></a>00797             <span class="keywordflow">if</span> (horizontalStrip) 
<a name="l00798"></a>00798               {
<a name="l00799"></a>00799                 <span class="keywordflow">if</span> (fabs(y - yExt) &lt; 1.5*stripWidth) match = <span class="keyword">true</span>;
<a name="l00800"></a>00800               } 
<a name="l00801"></a>00801             <span class="keywordflow">else</span> 
<a name="l00802"></a>00802               {
<a name="l00803"></a>00803                 <span class="keywordflow">if</span> (fabs(x - xExt) &lt; stripWidth) match = <span class="keyword">true</span>;
<a name="l00804"></a>00804               }
<a name="l00805"></a>00805             
<a name="l00806"></a>00806             <span class="keywordflow">if</span> (match) 
<a name="l00807"></a>00807               {
<a name="l00808"></a>00808 
<a name="l00809"></a>00809                 streamlog_out(DEBUG0) &lt;&lt; <span class="stringliteral">&quot; ---&gt;Found matching hit! Energy: &quot;</span>
<a name="l00810"></a>00810                               &lt;&lt; tcmtHit-&gt;getEnergy() &lt;&lt; <span class="stringliteral">&quot; CellId &quot;</span>
<a name="l00811"></a>00811                               &lt;&lt; tcmtHit-&gt;getCellID0() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
<a name="l00812"></a>00812                               &lt;&lt; tcmtHit-&gt;getCellID1() &lt;&lt; endl;
<a name="l00813"></a>00813                 <span class="comment">/* change the second cell ID to 1 in order to indicate a tcmt hit*/</span>
<a name="l00814"></a>00814                 tcmtHit-&gt;setCellID1(1);
<a name="l00815"></a>00815                 <span class="comment">/* add the hit to the track*/</span>
<a name="l00816"></a>00816                 track-&gt;addHit(tcmtHit, 1.0);
<a name="l00817"></a>00817                 <span class="comment">/* and remove it from the list of hits*/</span>
<a name="l00818"></a>00818                 tcmtHits.erase(iHit);
<a name="l00819"></a>00819                 <span class="comment">/* move iterator back, we just deleted the entry*/</span>
<a name="l00820"></a>00820                 --iHit;
<a name="l00821"></a>00821               }
<a name="l00822"></a>00822           }
<a name="l00823"></a>00823         streamlog_out(DEBUG0) &lt;&lt; <span class="stringliteral">&quot;Tcmt hits left: &quot;</span> &lt;&lt; tcmtHits.size() &lt;&lt; endl;
<a name="l00824"></a>00824         streamlog_out(DEBUG0) &lt;&lt; <span class="stringliteral">&quot;Track size after: &quot;</span>
<a name="l00825"></a>00825                       &lt;&lt; track-&gt;getCalorimeterHits().size() &lt;&lt; endl;
<a name="l00826"></a>00826       }
<a name="l00827"></a>00827     
<a name="l00828"></a>00828     <span class="keyword">delete</span> decoder_k;
<a name="l00829"></a>00829     
<a name="l00830"></a>00830     <span class="keywordflow">return</span> trackClusters;
<a name="l00831"></a>00831   }
<a name="l00832"></a>00832   
<a name="l00833"></a>00833   <span class="comment">/******************************************************************************/</span>
<a name="l00834"></a>00834   <span class="comment">/*                                                                            */</span>
<a name="l00835"></a>00835   <span class="comment">/*                                                                            */</span>
<a name="l00836"></a>00836   <span class="comment">/*                                                                            */</span>
<a name="l00837"></a>00837   <span class="comment">/******************************************************************************/</span>
<a name="l00838"></a><a class="code" href="classCALICE_1_1AngleTrackFinder.html#a48012b9d15a3a0e4e8ea6231bbf93dac">00838</a>   <span class="keywordtype">void</span> <a class="code" href="classCALICE_1_1AngleTrackFinder.html#a48012b9d15a3a0e4e8ea6231bbf93dac" title="Select good tracks.">AngleTrackFinder::selectTrackClusters</a>(EVENT::ClusterVec clusterVec, 
<a name="l00839"></a>00839                                              <span class="keyword">const</span> std::string trackSelectionMode,
<a name="l00840"></a>00840                                              EVENT::ClusterVec &amp;_goodTrackClusters) 
<a name="l00841"></a>00841   {
<a name="l00842"></a>00842     <span class="keywordflow">if</span> (trackSelectionMode != <span class="stringliteral">&quot;ANGLE&quot;</span>) 
<a name="l00843"></a>00843       {
<a name="l00844"></a>00844         streamlog_out(ERROR) &lt;&lt; <span class="stringliteral">&quot;No TrackSelectionMode chosen, aborting...&quot;</span> &lt;&lt; endl;
<a name="l00845"></a>00845         exit(1);
<a name="l00846"></a>00846       }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     _goodTrackClusters.clear();
<a name="l00849"></a>00849 
<a name="l00850"></a>00850     <span class="comment">/*order the track segments by size in decreasing order*/</span>
<a name="l00851"></a>00851     std::sort(clusterVec.begin(), clusterVec.end(), ClusterOrdering::compareVectBySize);    
<a name="l00852"></a>00852     
<a name="l00853"></a>00853     <span class="keywordflow">if</span> (clusterVec.size() == 0)
<a name="l00854"></a>00854       {
<a name="l00855"></a>00855         streamlog_out(DEBUG)&lt;&lt;<span class="stringliteral">&quot;selectTrackClusters: clusterVec.size()=0&quot;</span>&lt;&lt;endl;
<a name="l00856"></a>00856         <span class="keywordflow">return</span>;
<a name="l00857"></a>00857       }
<a name="l00858"></a>00858 
<a name="l00859"></a>00859     streamlog_out(DEBUG)&lt;&lt;<span class="stringliteral">&quot;\n-----------------------&gt; Start to selectTrackClusters, size=&quot;</span>&lt;&lt;clusterVec.size()&lt;&lt;endl;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861     <span class="comment">/* here will store the good track segments*/</span>
<a name="l00862"></a>00862     CalorimeterHitVec firsthitVec = clusterVec[0]-&gt;getCalorimeterHits();<span class="comment">/* check the first track segment*/</span>
<a name="l00863"></a>00863     
<a name="l00864"></a>00864     streamlog_out(DEBUG)&lt;&lt;<span class="stringliteral">&quot; firsthitVec.size()=&quot;</span>&lt;&lt;firsthitVec.size()&lt;&lt;<span class="stringliteral">&quot;, threshold: &quot;</span>&lt;&lt;<a class="code" href="classCALICE_1_1AngleTrackFinder.html#af196bbbed608a60877075df58d8d7916" title="choose amplitude to be used to perform the mip cut">_trackNoHitsThreshold</a>&lt;&lt;endl;
<a name="l00865"></a>00865     
<a name="l00866"></a>00866     <span class="comment">/* use track segments with a minimum number of Hits*/</span>
<a name="l00867"></a>00867     <span class="keywordflow">if</span> (firsthitVec.size() &gt; (<span class="keywordtype">unsigned</span> int) <a class="code" href="classCALICE_1_1AngleTrackFinder.html#af196bbbed608a60877075df58d8d7916" title="choose amplitude to be used to perform the mip cut">_trackNoHitsThreshold</a>) 
<a name="l00868"></a>00868       {   
<a name="l00869"></a>00869         EVENT::ClusterVec subCluster = this-&gt;obtainSubClusters(clusterVec[0]);
<a name="l00870"></a>00870         streamlog_out(DEBUG)&lt;&lt;<span class="stringliteral">&quot; initial subcluster size: &quot;</span>&lt;&lt;subCluster.size()&lt;&lt;endl;
<a name="l00871"></a>00871         
<a name="l00872"></a>00872         <span class="comment">/*But remove first isolated hits*/</span>
<a name="l00873"></a>00873         EVENT::ClusterVec subClusterClean = this-&gt;removeIsolatedHits(subCluster);
<a name="l00874"></a>00874         streamlog_out(DEBUG)&lt;&lt;<span class="stringliteral">&quot; after removing isolated hits: &quot;</span>&lt;&lt;subClusterClean.size()&lt;&lt;endl;
<a name="l00875"></a>00875         
<a name="l00876"></a>00876         <span class="comment">/* Add*/</span>
<a name="l00877"></a>00877         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> isubCl = 0; isubCl &lt; subClusterClean.size(); isubCl++) 
<a name="l00878"></a>00878           {
<a name="l00879"></a>00879             _goodTrackClusters.push_back(subClusterClean[isubCl]);
<a name="l00880"></a>00880           }
<a name="l00881"></a>00881         
<a name="l00882"></a>00882         streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;Go now to the next towers &quot;</span> &lt;&lt; endl;
<a name="l00883"></a>00883             
<a name="l00884"></a>00884         <span class="comment">/* Now check if the next Clusters are close to the seed track segment*/</span>
<a name="l00885"></a>00885         <span class="keywordtype">unsigned</span> iSearch = 1;
<a name="l00886"></a>00886                 
<a name="l00887"></a>00887         <span class="keywordflow">while</span> (iSearch &lt; clusterVec.size()) 
<a name="l00888"></a>00888           {
<a name="l00889"></a>00889             CalorimeterHitVec hitVec = clusterVec[iSearch]-&gt;getCalorimeterHits();
<a name="l00890"></a>00890                     
<a name="l00891"></a>00891             <span class="comment">/* and at least they contain 3 hits!*/</span>
<a name="l00892"></a>00892             <span class="keywordflow">if</span> (hitVec.size() &gt; 2) 
<a name="l00893"></a>00893               {
<a name="l00894"></a>00894                 <span class="comment">/* order by layer*/</span>
<a name="l00895"></a>00895                 <span class="keywordtype">bool</span> tobeMerged = ClusterOrdering::checkXYAdyacentClusters(clusterVec[0], clusterVec[iSearch], 3);
<a name="l00896"></a>00896                                 
<a name="l00897"></a>00897                 <span class="keywordflow">if</span> (tobeMerged) 
<a name="l00898"></a>00898                   {
<a name="l00899"></a>00899                     EVENT::ClusterVec nextsubCluster = this-&gt;obtainSubClusters(clusterVec[iSearch]);
<a name="l00900"></a>00900                                     
<a name="l00901"></a>00901                     EVENT::ClusterVec nextsubClusterClean = this-&gt;removeIsolatedHits(nextsubCluster);
<a name="l00902"></a>00902                                     
<a name="l00903"></a>00903                     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> isubCl = 0; isubCl &lt; nextsubClusterClean.size(); isubCl++) 
<a name="l00904"></a>00904                       {
<a name="l00905"></a>00905                         _goodTrackClusters.push_back(nextsubClusterClean[isubCl]);
<a name="l00906"></a>00906                       }
<a name="l00907"></a>00907                   }
<a name="l00908"></a>00908               }
<a name="l00909"></a>00909             iSearch++;
<a name="l00910"></a>00910           }
<a name="l00911"></a>00911       }
<a name="l00912"></a>00912     
<a name="l00913"></a>00913     streamlog_out(DEBUG)&lt;&lt;<span class="stringliteral">&quot;selectTrackClusters: found &quot;</span>&lt;&lt;_goodTrackClusters.size()&lt;&lt;<span class="stringliteral">&quot; good track clusters&quot;</span>&lt;&lt;endl;
<a name="l00914"></a>00914     
<a name="l00915"></a>00915 
<a name="l00916"></a>00916   }
<a name="l00917"></a>00917 
<a name="l00918"></a>00918   <span class="comment">/******************************************************************************/</span>
<a name="l00919"></a>00919   <span class="comment">/*                                                                            */</span>
<a name="l00920"></a>00920   <span class="comment">/*                                                                            */</span>
<a name="l00921"></a>00921   <span class="comment">/*                                                                            */</span>
<a name="l00922"></a>00922   <span class="comment">/******************************************************************************/</span>
<a name="l00923"></a>00923   <span class="keywordtype">void</span> AngleTrackFinder::mergeCoarseClusters(EVENT::ClusterVec goodClusterVec, 
<a name="l00924"></a>00924                                              EVENT::ClusterVec clusterCoarseVec,
<a name="l00925"></a>00925                                              EVENT::ClusterVec &amp;mergeFineCoarseClusters,
<a name="l00926"></a>00926                                              <span class="keyword">const</span> std::string trackSelectionMode) 
<a name="l00927"></a>00927   {
<a name="l00928"></a>00928     <span class="keywordflow">if</span> (trackSelectionMode == <span class="stringliteral">&quot;ANGLE&quot;</span>) 
<a name="l00929"></a>00929       {
<a name="l00930"></a>00930         <span class="keywordflow">if</span> (goodClusterVec.size() &gt; 0) 
<a name="l00931"></a>00931           {       
<a name="l00932"></a>00932             streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;Number of clusters in the fine Section &quot;</span> &lt;&lt; goodClusterVec.size() &lt;&lt; endl;
<a name="l00933"></a>00933             <span class="comment">/* get X,Y of the last cluster in the fine section*/</span>
<a name="l00934"></a>00934             <span class="keywordtype">float</span> xlastFine = 0;
<a name="l00935"></a>00935             <span class="keywordtype">float</span> ylastFine = 0;
<a name="l00936"></a>00936             <span class="keywordtype">float</span> zlastFine = 0;
<a name="l00937"></a>00937           
<a name="l00938"></a>00938             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> iloop = 0; iloop &lt; goodClusterVec.size(); iloop++) 
<a name="l00939"></a>00939               {
<a name="l00940"></a>00940                 mergeFineCoarseClusters.push_back(goodClusterVec[iloop]);
<a name="l00941"></a>00941                 CalorimeterHitVec finehitVec = goodClusterVec[iloop]-&gt;getCalorimeterHits();
<a name="l00942"></a>00942                 <span class="comment">/* the cluster are arranged in decreasing order*/</span>
<a name="l00943"></a>00943                 <span class="keywordflow">if</span> (iloop == 0) 
<a name="l00944"></a>00944                   {
<a name="l00945"></a>00945                     xlastFine = finehitVec[0]-&gt;getPosition()[0];
<a name="l00946"></a>00946                     ylastFine = finehitVec[0]-&gt;getPosition()[1];
<a name="l00947"></a>00947                     zlastFine = finehitVec[0]-&gt;getPosition()[2];
<a name="l00948"></a>00948                   }
<a name="l00949"></a>00949             }
<a name="l00950"></a>00950             
<a name="l00951"></a>00951             streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;Before Number of SubClusters: &quot;</span> &lt;&lt; mergeFineCoarseClusters.size() &lt;&lt; endl;
<a name="l00952"></a>00952             
<a name="l00953"></a>00953             <span class="comment">/* display some coarse quantities*/</span>
<a name="l00954"></a>00954             
<a name="l00955"></a>00955             std::sort(clusterCoarseVec.begin(), clusterCoarseVec.end(), ClusterOrdering::compareVectBySize);
<a name="l00956"></a>00956             
<a name="l00957"></a>00957             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> iloop = 0; iloop &lt; clusterCoarseVec.size(); iloop++) 
<a name="l00958"></a>00958               {
<a name="l00959"></a>00959                 CalorimeterHitVec coarsehitVec = clusterCoarseVec[iloop]-&gt;getCalorimeterHits();
<a name="l00960"></a>00960                 <span class="comment">/* order it by layer*/</span>
<a name="l00961"></a>00961                 std::sort(coarsehitVec.begin(), coarsehitVec.end(), ClusterOrdering::compareHitByLayer);
<a name="l00962"></a>00962                 
<a name="l00963"></a>00963                 <span class="comment">/*check the towers which at least have 3 hits in the coarse section*/</span>
<a name="l00964"></a>00964                 <span class="keywordflow">if</span> (coarsehitVec.size() &gt;= 3) 
<a name="l00965"></a>00965                   {
<a name="l00966"></a>00966                     <span class="comment">/* check all the coarse subclusters since x-y is the same,</span>
<a name="l00967"></a>00967 <span class="comment">                       only use the first hit */</span>
<a name="l00968"></a>00968                     <span class="keywordtype">float</span> dXfine_coarse = fabs(coarsehitVec[0]-&gt;getPosition()[0] - xlastFine);
<a name="l00969"></a>00969                     <span class="keywordtype">float</span> dYfine_coarse = fabs(coarsehitVec[0]-&gt;getPosition()[1] - ylastFine);
<a name="l00970"></a>00970                     
<a name="l00971"></a>00971                     <span class="keywordflow">if</span> (dXfine_coarse &lt; 61 &amp;&amp; dYfine_coarse &lt; 61) 
<a name="l00972"></a>00972                       {
<a name="l00973"></a>00973                         <span class="comment">/* order by layer*/</span>                     
<a name="l00974"></a>00974                         mergeFineCoarseClusters.push_back(clusterCoarseVec[iloop]);
<a name="l00975"></a>00975                       }
<a name="l00976"></a>00976                   }
<a name="l00977"></a>00977               }
<a name="l00978"></a>00978             streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;After Number of SubClusters: &quot;</span> &lt;&lt; mergeFineCoarseClusters.size() &lt;&lt; endl;
<a name="l00979"></a>00979           } 
<a name="l00980"></a>00980         <span class="keywordflow">else</span> 
<a name="l00981"></a>00981           {
<a name="l00982"></a>00982             streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;no track found&quot;</span> &lt;&lt; endl;
<a name="l00983"></a>00983           }
<a name="l00984"></a>00984         
<a name="l00985"></a>00985         <span class="comment">/* print out*/</span>
<a name="l00986"></a>00986         <span class="comment">/*</span>
<a name="l00987"></a>00987 <span class="comment">          for (unsigned icl=0;icl&lt;mergeFineCoarseClusters.size();icl++){</span>
<a name="l00988"></a>00988 <span class="comment">          cout &lt;&lt; &quot;at the end of fine-coarse section ---- &quot; &lt;&lt; icl &lt;&lt; endl;</span>
<a name="l00989"></a>00989 <span class="comment">          CalorimeterHitVec hitVecCl =mergeFineCoarseClusters[icl] -&gt;getCalorimeterHits();</span>
<a name="l00990"></a>00990 <span class="comment">          for (int il=0;il&lt;hitVecCl.size();il++){</span>
<a name="l00991"></a>00991 <span class="comment">          const int cellIDA = hitVecCl[il]-&gt;getCellID0();</span>
<a name="l00992"></a>00992 <span class="comment">          HcalCellIndex geomIndex(cellIDA);</span>
<a name="l00993"></a>00993 <span class="comment">          int iLayer = geomIndex.getLayerIndex();</span>
<a name="l00994"></a>00994 <span class="comment">          cout &lt;&lt; &quot;xxxx having layers: &quot; &lt;&lt; iLayer &lt;&lt; &quot; x/y &quot; &lt;&lt; hitVecCl[il]-&gt;getPosition()[0] </span>
<a name="l00995"></a>00995 <span class="comment">          &lt;&lt; &quot; / &quot; &lt;&lt; hitVecCl[il]-&gt;getPosition()[1] &lt;&lt; &quot; il: &quot; &lt;&lt; il &lt;&lt; &quot; energy &quot; &lt;&lt; hitVecCl[il]-&gt;getEnergy() &lt;&lt; endl;</span>
<a name="l00996"></a>00996 <span class="comment">          }</span>
<a name="l00997"></a>00997 <span class="comment">          }</span>
<a name="l00998"></a>00998 <span class="comment">        */</span>
<a name="l00999"></a>00999       } 
<a name="l01000"></a>01000     <span class="keywordflow">else</span> 
<a name="l01001"></a>01001       {
<a name="l01002"></a>01002         streamlog_out(ERROR) &lt;&lt; <span class="stringliteral">&quot;No TrackSelectionMode chosen, aborting...&quot;</span> &lt;&lt; endl;
<a name="l01003"></a>01003         exit(1);
<a name="l01004"></a>01004       }
<a name="l01005"></a>01005   }
<a name="l01006"></a>01006   <span class="comment">/******************************************************************************/</span>
<a name="l01007"></a>01007   <span class="comment">/*                                                                            */</span>
<a name="l01008"></a>01008   <span class="comment">/*                                                                            */</span>
<a name="l01009"></a>01009   <span class="comment">/*                                                                            */</span>
<a name="l01010"></a>01010   <span class="comment">/******************************************************************************/</span>
<a name="l01011"></a><a class="code" href="classCALICE_1_1AngleTrackFinder.html#aa5e29dedb8b2b70a44e965bbc7de8a48">01011</a>   ClusterImpl* <a class="code" href="classCALICE_1_1AngleTrackFinder.html#aa5e29dedb8b2b70a44e965bbc7de8a48" title="Get the whole track (i.e.">AngleTrackFinder::getWholeTrack</a>(Cluster *trackCluster) 
<a name="l01012"></a>01012   {
<a name="l01013"></a>01013     <span class="keywordtype">float</span> meanXOfTrack = 0;
<a name="l01014"></a>01014     <span class="keywordtype">float</span> meanYOfTrack = 0;
<a name="l01015"></a>01015     
<a name="l01016"></a>01016     CalorimeterHitVec hitVec = trackCluster-&gt;getCalorimeterHits();
<a name="l01017"></a>01017     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iHits = 0; iHits &lt; hitVec.size(); ++iHits) 
<a name="l01018"></a>01018       {
<a name="l01019"></a>01019         meanXOfTrack += hitVec[iHits]-&gt;getPosition()[0];
<a name="l01020"></a>01020         meanYOfTrack += hitVec[iHits]-&gt;getPosition()[1];
<a name="l01021"></a>01021       }<span class="comment">/*------------ end loop over track clusters -----------------*/</span>
<a name="l01022"></a>01022     
<a name="l01023"></a>01023     meanXOfTrack /= hitVec.size();
<a name="l01024"></a>01024     meanYOfTrack /= hitVec.size();
<a name="l01025"></a>01025     
<a name="l01026"></a>01026     streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot; Mean X: &quot;</span> &lt;&lt; meanXOfTrack &lt;&lt; <span class="stringliteral">&quot; mean Y: &quot;</span> &lt;&lt; meanYOfTrack
<a name="l01027"></a>01027                   &lt;&lt; endl;
<a name="l01028"></a>01028     
<a name="l01029"></a>01029     ClusterImpl *wholeTrack = <span class="keyword">new</span> ClusterImpl();
<a name="l01030"></a>01030     
<a name="l01031"></a>01031     EVENT::CalorimeterHitVec::iterator iter;
<a name="l01032"></a>01032     <span class="keywordflow">for</span> (iter = <a class="code" href="classCALICE_1_1AngleTrackFinder.html#aef20f858c612a3181537606fdc4be0f1" title="vector containing all AHCAL hits from the event">_allAhcalHitsInEventVec</a>.begin(); iter != <a class="code" href="classCALICE_1_1AngleTrackFinder.html#aef20f858c612a3181537606fdc4be0f1" title="vector containing all AHCAL hits from the event">_allAhcalHitsInEventVec</a>.end(); ++iter) 
<a name="l01033"></a>01033       {
<a name="l01034"></a>01034         <span class="keywordtype">float</span> differenceInX = fabs((*iter)-&gt;getPosition()[0] - meanXOfTrack);
<a name="l01035"></a>01035         <span class="keywordtype">float</span> differenceInY = fabs((*iter)-&gt;getPosition()[1] - meanYOfTrack);
<a name="l01036"></a>01036         
<a name="l01037"></a>01037 <span class="comment">//      streamlog_out(DEBUG4) &lt;&lt; &quot; differenceInX: &quot; &lt;&lt; differenceInX</span>
<a name="l01038"></a>01038 <span class="comment">//                    &lt;&lt; &quot; differenceInY: &quot; &lt;&lt; differenceInY &lt;&lt; endl;</span>
<a name="l01039"></a>01039         
<a name="l01040"></a>01040         <span class="comment">/*be aware of the misalignment information in the future*/</span>
<a name="l01041"></a>01041         <span class="keywordflow">if</span> (differenceInX &lt; 16 &amp;&amp; differenceInY &lt; 16) 
<a name="l01042"></a>01042           {
<a name="l01043"></a>01043 <span class="comment">//          streamlog_out(DEBUG0) &lt;&lt; &quot; Added hit to the track&quot; &lt;&lt; endl;</span>
<a name="l01044"></a>01044             wholeTrack-&gt;addHit((*iter), 1.);
<a name="l01045"></a>01045           }
<a name="l01046"></a>01046       }<span class="comment">/*----------------- end loop over all AHCAL hits in the event*/</span>
<a name="l01047"></a>01047     
<a name="l01048"></a>01048     <span class="keywordflow">return</span> wholeTrack;
<a name="l01049"></a>01049   }
<a name="l01050"></a>01050 
<a name="l01051"></a>01051   <span class="comment">/******************************************************************************/</span>
<a name="l01052"></a>01052   <span class="comment">/*                                                                            */</span>
<a name="l01053"></a>01053   <span class="comment">/*                                                                            */</span>
<a name="l01054"></a>01054   <span class="comment">/*                                                                            */</span>
<a name="l01055"></a>01055   <span class="comment">/******************************************************************************/</span>
<a name="l01056"></a>01056   ClusterImpl* AngleTrackFinder::copyACluster(Cluster *trackCluster) 
<a name="l01057"></a>01057   {
<a name="l01058"></a>01058     ClusterImpl *wholeTrack = <span class="keyword">new</span> ClusterImpl();
<a name="l01059"></a>01059     CalorimeterHitVec hitVec = trackCluster-&gt;getCalorimeterHits();
<a name="l01060"></a>01060     
<a name="l01061"></a>01061     streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;Elements:: &quot;</span> &lt;&lt; hitVec.size() &lt;&lt; endl;
<a name="l01062"></a>01062     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iHits = 0; iHits &lt; hitVec.size(); ++iHits) 
<a name="l01063"></a>01063       {
<a name="l01064"></a>01064         wholeTrack-&gt;addHit(hitVec[iHits], 1.);
<a name="l01065"></a>01065       }
<a name="l01066"></a>01066     <span class="keywordflow">return</span> wholeTrack;
<a name="l01067"></a>01067   }
<a name="l01068"></a>01068 
<a name="l01069"></a>01069   <span class="comment">/******************************************************************************/</span>
<a name="l01070"></a>01070   <span class="comment">/*                                                                            */</span>
<a name="l01071"></a>01071   <span class="comment">/*                                                                            */</span>
<a name="l01072"></a>01072   <span class="comment">/*                                                                            */</span>
<a name="l01073"></a>01073   <span class="comment">/******************************************************************************/</span>
<a name="l01074"></a><a class="code" href="classCALICE_1_1AngleTrackFinder.html#ae0fd37e5b74a53bb65d845fec3e3528d">01074</a>   EVENT::ClusterVec <a class="code" href="classCALICE_1_1AngleTrackFinder.html#ae0fd37e5b74a53bb65d845fec3e3528d" title="Get the vector of track clusters containing all the remaining hits.">AngleTrackFinder::getRemainingHits</a>(EVENT::ClusterVec selectedTrackClusters) 
<a name="l01075"></a>01075   {
<a name="l01076"></a>01076     EVENT::ClusterVec outputClusterVec;
<a name="l01077"></a>01077     
<a name="l01078"></a>01078     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iCluster = 0; iCluster &lt; selectedTrackClusters.size(); ++iCluster) 
<a name="l01079"></a>01079       {
<a name="l01080"></a>01080         outputClusterVec.push_back(this-&gt;<a class="code" href="classCALICE_1_1AngleTrackFinder.html#aa5e29dedb8b2b70a44e965bbc7de8a48" title="Get the whole track (i.e.">getWholeTrack</a>(selectedTrackClusters[iCluster]));
<a name="l01081"></a>01081       }<span class="comment">/*--------------------- end loop over track clusters -----------------*/</span>
<a name="l01082"></a>01082     
<a name="l01083"></a>01083     <span class="keywordflow">return</span> outputClusterVec;
<a name="l01084"></a>01084   }
<a name="l01085"></a>01085   
<a name="l01086"></a>01086   <span class="comment">/******************************************************************************/</span>
<a name="l01087"></a>01087   <span class="comment">/*                                                                            */</span>
<a name="l01088"></a>01088   <span class="comment">/*                                                                            */</span>
<a name="l01089"></a>01089   <span class="comment">/*                                                                            */</span>
<a name="l01090"></a>01090   <span class="comment">/******************************************************************************/</span>
<a name="l01091"></a>01091   EVENT::ClusterVec AngleTrackFinder::getRemainingHitsOfTrackSegment(EVENT::ClusterVec aselectedTrackClusters) 
<a name="l01092"></a>01092   {
<a name="l01093"></a>01093     EVENT::ClusterVec outputClusterVec;
<a name="l01094"></a>01094     
<a name="l01095"></a>01095     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iCluster = 0; iCluster &lt; aselectedTrackClusters.size(); ++iCluster) 
<a name="l01096"></a>01096       {
<a name="l01097"></a>01097         streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;getRemainingHitsOfTrackSegment iCluster: &quot;</span> &lt;&lt; iCluster &lt;&lt; endl;
<a name="l01098"></a>01098         outputClusterVec.push_back(this-&gt;getWholeTrackSegment(aselectedTrackClusters[iCluster]));
<a name="l01099"></a>01099       }<span class="comment">/*--------------------- end loop over track clusters -----------------*/</span>
<a name="l01100"></a>01100     
<a name="l01101"></a>01101     streamlog_out(DEBUG)&lt;&lt;<span class="stringliteral">&quot;\n getRemainingHitsOfTrackSegment: size=&quot;</span>&lt;&lt;outputClusterVec.size()&lt;&lt;endl;
<a name="l01102"></a>01102 
<a name="l01103"></a>01103     <span class="keywordflow">return</span> outputClusterVec;
<a name="l01104"></a>01104   }
<a name="l01105"></a>01105   
<a name="l01106"></a>01106   <span class="comment">/******************************************************************************/</span>
<a name="l01107"></a>01107   <span class="comment">/*                                                                            */</span>
<a name="l01108"></a>01108   <span class="comment">/*                                                                            */</span>
<a name="l01109"></a>01109   <span class="comment">/*                                                                            */</span>
<a name="l01110"></a>01110   <span class="comment">/******************************************************************************/</span>
<a name="l01111"></a>01111   ClusterImpl* AngleTrackFinder::getWholeTrackSegment(Cluster *trackCluster) 
<a name="l01112"></a>01112   {
<a name="l01113"></a>01113     <span class="keywordtype">float</span> meanXOfTrack = 0;
<a name="l01114"></a>01114     <span class="keywordtype">float</span> meanYOfTrack = 0;
<a name="l01115"></a>01115     
<a name="l01116"></a>01116     <span class="keywordtype">int</span> iniLayerSegment;
<a name="l01117"></a>01117     <span class="keywordtype">int</span> endLayerSegment;
<a name="l01118"></a>01118     
<a name="l01119"></a>01119     CalorimeterHitVec hitVec = trackCluster-&gt;getCalorimeterHits();
<a name="l01120"></a>01120     <span class="comment">/* order by Layer!*/</span>
<a name="l01121"></a>01121     std::sort(hitVec.begin(), hitVec.end(), ClusterOrdering::compareHitByLayer);
<a name="l01122"></a>01122 
<a name="l01123"></a>01123     <span class="comment">/* find initial and end;*/</span>
<a name="l01124"></a>01124     
<a name="l01125"></a>01125     <span class="keyword">const</span> <span class="keywordtype">int</span> cellIDAini = hitVec[0]-&gt;getCellID0();
<a name="l01126"></a>01126     HcalCellIndex geomIndexIni(cellIDAini);
<a name="l01127"></a>01127     iniLayerSegment = geomIndexIni.getLayerIndex();
<a name="l01128"></a>01128     
<a name="l01129"></a>01129     <span class="keyword">const</span> <span class="keywordtype">int</span> cellIDAend = hitVec[hitVec.size() - 1]-&gt;getCellID0();
<a name="l01130"></a>01130     HcalCellIndex geomIndexEnd(cellIDAend);
<a name="l01131"></a>01131     endLayerSegment = geomIndexEnd.getLayerIndex();
<a name="l01132"></a>01132     
<a name="l01133"></a>01133     <span class="comment">/*cout &lt;&lt; &quot;getWholeTrackSegment ======= &quot; &lt;&lt; iniLayerSegment &lt;&lt; &quot;/t&quot; &lt;&lt; endLayerSegment &lt;&lt; endl;*/</span>
<a name="l01134"></a>01134     
<a name="l01135"></a>01135     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iHits = 0; iHits &lt; hitVec.size(); ++iHits) 
<a name="l01136"></a>01136       {
<a name="l01137"></a>01137         meanXOfTrack += hitVec[iHits]-&gt;getPosition()[0];
<a name="l01138"></a>01138         meanYOfTrack += hitVec[iHits]-&gt;getPosition()[1];
<a name="l01139"></a>01139       }<span class="comment">/*------------ end loop over track clusters -----------------*/</span>
<a name="l01140"></a>01140     
<a name="l01141"></a>01141     meanXOfTrack /= hitVec.size();
<a name="l01142"></a>01142     meanYOfTrack /= hitVec.size();
<a name="l01143"></a>01143     
<a name="l01144"></a>01144     streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot; Mean X: &quot;</span> &lt;&lt; meanXOfTrack &lt;&lt; <span class="stringliteral">&quot; mean Y: &quot;</span> &lt;&lt; meanYOfTrack
<a name="l01145"></a>01145                   &lt;&lt; endl;
<a name="l01146"></a>01146     
<a name="l01147"></a>01147     ClusterImpl *wholeTrack = <span class="keyword">new</span> ClusterImpl();
<a name="l01148"></a>01148     
<a name="l01149"></a>01149     EVENT::CalorimeterHitVec::iterator iter;
<a name="l01150"></a>01150     <span class="keywordflow">for</span> (iter = <a class="code" href="classCALICE_1_1AngleTrackFinder.html#aef20f858c612a3181537606fdc4be0f1" title="vector containing all AHCAL hits from the event">_allAhcalHitsInEventVec</a>.begin(); iter != <a class="code" href="classCALICE_1_1AngleTrackFinder.html#aef20f858c612a3181537606fdc4be0f1" title="vector containing all AHCAL hits from the event">_allAhcalHitsInEventVec</a>.end(); ++iter) 
<a name="l01151"></a>01151       {
<a name="l01152"></a>01152         <span class="keywordtype">float</span> differenceInX = fabs((*iter)-&gt;getPosition()[0] - meanXOfTrack);
<a name="l01153"></a>01153         <span class="keywordtype">float</span> differenceInY = fabs((*iter)-&gt;getPosition()[1] - meanYOfTrack);
<a name="l01154"></a>01154         streamlog_out(DEBUG4) &lt;&lt; <span class="stringliteral">&quot; differenceInX: &quot;</span> &lt;&lt; differenceInX
<a name="l01155"></a>01155                       &lt;&lt; <span class="stringliteral">&quot; differenceInY: &quot;</span> &lt;&lt; differenceInY &lt;&lt; endl;
<a name="l01156"></a>01156         
<a name="l01157"></a>01157         <span class="comment">/*be aware of the misalignment information in the future*/</span>
<a name="l01158"></a>01158         
<a name="l01159"></a>01159         <span class="keywordflow">if</span> (differenceInX &lt; 16 &amp;&amp; differenceInY &lt; 16) 
<a name="l01160"></a>01160           {
<a name="l01161"></a>01161             <span class="keyword">const</span> <span class="keywordtype">int</span> cellIDA = (*iter)-&gt;getCellID0();
<a name="l01162"></a>01162             HcalCellIndex geomIndex(cellIDA);
<a name="l01163"></a>01163             <span class="keywordtype">int</span> iLayer = geomIndex.getLayerIndex();
<a name="l01164"></a>01164 
<a name="l01165"></a>01165             <span class="keywordflow">if</span> (iLayer &gt;= iniLayerSegment &amp;&amp; iLayer &lt;= endLayerSegment) 
<a name="l01166"></a>01166               {
<a name="l01167"></a>01167                 streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;coarse difference: &quot;</span> &lt;&lt; differenceInX &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span> 
<a name="l01168"></a>01168                              &lt;&lt; differenceInY &lt;&lt; <span class="stringliteral">&quot; layer &quot;</span> &lt;&lt;iLayer &lt;&lt; <span class="stringliteral">&quot; energy &quot;</span> &lt;&lt; (*iter)-&gt;getEnergy() &lt;&lt; endl;
<a name="l01169"></a>01169                 streamlog_out(DEBUG0) &lt;&lt; <span class="stringliteral">&quot; Added hit to the track&quot;</span> &lt;&lt; endl;
<a name="l01170"></a>01170                 wholeTrack-&gt;addHit((*iter), 1.);
<a name="l01171"></a>01171               }
<a name="l01172"></a>01172           }
<a name="l01173"></a>01173         
<a name="l01174"></a>01174       }<span class="comment">/*----------------- end loop over all AHCAL hits in the event*/</span>
<a name="l01175"></a>01175     
<a name="l01176"></a>01176     <span class="keywordflow">return</span> wholeTrack;
<a name="l01177"></a>01177   }
<a name="l01178"></a>01178   
<a name="l01179"></a>01179   <span class="comment">/******************************************************************************/</span>
<a name="l01180"></a>01180   <span class="comment">/*                                                                            */</span>
<a name="l01181"></a>01181   <span class="comment">/*                                                                            */</span>
<a name="l01182"></a>01182   <span class="comment">/*                                                                            */</span>
<a name="l01183"></a>01183   <span class="comment">/******************************************************************************/</span>
<a name="l01184"></a>01184   EVENT::ClusterVec AngleTrackFinder::getFinalCluster(EVENT::ClusterVec selectedTrackClusters) 
<a name="l01185"></a>01185   {
<a name="l01186"></a>01186     EVENT::ClusterVec outputClusterVec;
<a name="l01187"></a>01187     
<a name="l01188"></a>01188     streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;Number of subcluster: &quot;</span> &lt;&lt; selectedTrackClusters.size() &lt;&lt; endl;
<a name="l01189"></a>01189     
<a name="l01190"></a>01190     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iCluster = 0; iCluster &lt; selectedTrackClusters.size(); ++iCluster) 
<a name="l01191"></a>01191       {
<a name="l01192"></a>01192         outputClusterVec.push_back(this-&gt;copyACluster(selectedTrackClusters[iCluster]));
<a name="l01193"></a>01193       }<span class="comment">/*--------------------- end loop over track clusters -----------------*/</span>
<a name="l01194"></a>01194     
<a name="l01195"></a>01195     <span class="keywordflow">return</span> outputClusterVec;
<a name="l01196"></a>01196   }
<a name="l01197"></a>01197   
<a name="l01198"></a>01198   <span class="comment">/******************************************************************************/</span>
<a name="l01199"></a>01199   <span class="comment">/*                                                                            */</span>
<a name="l01200"></a>01200   <span class="comment">/*                                                                            */</span>
<a name="l01201"></a>01201   <span class="comment">/*                                                                            */</span>
<a name="l01202"></a>01202   <span class="comment">/******************************************************************************/</span>
<a name="l01203"></a><a class="code" href="classCALICE_1_1AngleTrackFinder.html#ae2aa960da701d5e62b15e21c1df40691">01203</a>   <span class="keywordtype">void</span> <a class="code" href="classCALICE_1_1AngleTrackFinder.html#ae2aa960da701d5e62b15e21c1df40691" title="Create output collection of track clusters.">AngleTrackFinder::createOutputCollection</a>(LCEvent *evt, EVENT::ClusterVec finalVec) 
<a name="l01204"></a>01204   {
<a name="l01205"></a>01205     LCCollection *muonHcalCol  = <span class="keyword">new</span> LCCollectionVec(LCIO::CALORIMETERHIT);
<a name="l01206"></a>01206     <span class="comment">/*we want to save the position, and this can only be done if the CHBIT_LONG bit is set*/</span>
<a name="l01207"></a>01207     muonHcalCol-&gt;setFlag(muonHcalCol-&gt;getFlag() | 1 &lt;&lt; LCIO::CHBIT_LONG );
<a name="l01208"></a>01208     
<a name="l01209"></a>01209     LCCollection *muonTcmtCol  = <span class="keyword">new</span> LCCollectionVec(LCIO::CALORIMETERHIT);
<a name="l01210"></a>01210     <span class="comment">/*we want to save the position, and this can only be done if the CHBIT_LONG bit is set*/</span>
<a name="l01211"></a>01211     muonTcmtCol-&gt;setFlag(muonTcmtCol-&gt;getFlag() | 1 &lt;&lt; LCIO::CHBIT_LONG );
<a name="l01212"></a>01212     
<a name="l01213"></a>01213     <span class="comment">/*--------------------------------------------------------------------------*/</span>
<a name="l01214"></a>01214     CellIDDecoder&lt;CalorimeterHit&gt;* tcmtDecoder = 0;
<a name="l01215"></a>01215     <span class="keywordflow">if</span> (_useTCMT) 
<a name="l01216"></a>01216       {
<a name="l01217"></a>01217         tcmtDecoder = <span class="keyword">new</span> CellIDDecoder&lt;CalorimeterHit&gt; (<a class="code" href="classCALICE_1_1AngleTrackFinder.html#a961a3ce5cad59157ae7cc350da27017b" title="TCMT input collection.">_tcmtInputCol</a>);
<a name="l01218"></a>01218       }
<a name="l01219"></a>01219     <span class="keywordtype">float</span> energyArr[MAXTCMTSTRIPS][MAXTCMTLAYERS] = {{0}, {0}};
<a name="l01220"></a>01220     <span class="keywordtype">int</span>   countArr[MAXTCMTSTRIPS][MAXTCMTLAYERS]  = {{0}, {0}};
<a name="l01221"></a>01221     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cellID0Arr[MAXTCMTSTRIPS][MAXTCMTLAYERS] = {{0}, {0}};
<a name="l01222"></a>01222     <span class="keywordtype">float</span> xArr[MAXTCMTSTRIPS][MAXTCMTLAYERS] = {{0}, {0}};
<a name="l01223"></a>01223     <span class="keywordtype">float</span> yArr[MAXTCMTSTRIPS][MAXTCMTLAYERS] = {{0}, {0}};
<a name="l01224"></a>01224     <span class="keywordtype">float</span> zArr[MAXTCMTSTRIPS][MAXTCMTLAYERS] = {{0}, {0}};
<a name="l01225"></a>01225 
<a name="l01226"></a>01226     <span class="comment">/*--------------------------------------------------------------------------*/</span>
<a name="l01227"></a>01227     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size = finalVec.size();
<a name="l01228"></a>01228     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iCluster = 0; iCluster &lt; size; iCluster++) 
<a name="l01229"></a>01229       {
<a name="l01230"></a>01230         Cluster *trackCluster = finalVec[iCluster];
<a name="l01231"></a>01231         <span class="keyword">const</span> CalorimeterHitVec hitVec = trackCluster-&gt;getCalorimeterHits();
<a name="l01232"></a>01232         
<a name="l01233"></a>01233         <span class="comment">/* loop over the Hits in the cluster*/</span>
<a name="l01234"></a>01234         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iHit = 0; iHit &lt; hitVec.size(); ++iHit) 
<a name="l01235"></a>01235           {
<a name="l01236"></a>01236             CalorimeterHit *Hit = hitVec[iHit];
<a name="l01237"></a>01237             <span class="comment">/* Now we have getCellID0 and we need a Mapper*/</span>
<a name="l01238"></a>01238             <span class="keyword">const</span> <span class="keywordtype">int</span> cellID0 = Hit-&gt;getCellID0();
<a name="l01239"></a>01239             <span class="keyword">const</span> <span class="keywordtype">int</span> cellID1 = Hit-&gt;getCellID1();
<a name="l01240"></a>01240             
<a name="l01241"></a>01241             CalorimeterHitImpl *newHit = <span class="keyword">new</span> CalorimeterHitImpl();
<a name="l01242"></a>01242             newHit-&gt;setEnergy(Hit-&gt;getEnergy());
<a name="l01243"></a>01243             newHit-&gt;setCellID0(cellID0);
<a name="l01244"></a>01244             newHit-&gt;setCellID1(cellID1);
<a name="l01245"></a>01245             newHit-&gt;setPosition(Hit-&gt;getPosition());
<a name="l01246"></a>01246             
<a name="l01247"></a>01247             <span class="comment">/* check if the hit is coming from tcmt*/</span>
<a name="l01248"></a>01248             <span class="keywordflow">if</span> (cellID1 == 1 &amp;&amp; _useTCMT == <span class="keyword">true</span>) 
<a name="l01249"></a>01249               {
<a name="l01250"></a>01250                 <span class="comment">// muonTcmtCol-&gt;addElement(newHit);           </span>
<a name="l01251"></a>01251                 <span class="keyword">const</span> <span class="keywordtype">int</span> I = (*tcmtDecoder)(Hit)[<span class="stringliteral">&quot;I&quot;</span>];
<a name="l01252"></a>01252                 <span class="keyword">const</span> <span class="keywordtype">int</span> J = (*tcmtDecoder)(Hit)[<span class="stringliteral">&quot;J&quot;</span>];
<a name="l01253"></a>01253                 <span class="keyword">const</span> <span class="keywordtype">int</span> K = (*tcmtDecoder)(Hit)[<span class="stringliteral">&quot;K-1&quot;</span>];
<a name="l01254"></a>01254                 <span class="keyword">const</span> <span class="keywordtype">int</span> layer = K;
<a name="l01255"></a>01255                 <span class="keywordtype">int</span> strip = 0;
<a name="l01256"></a>01256                 <span class="keywordflow">if</span> (I != 0)
<a name="l01257"></a>01257                   strip = I - 1;
<a name="l01258"></a>01258                 <span class="keywordflow">if</span> (J != 0)
<a name="l01259"></a>01259                   strip = J - 1;
<a name="l01260"></a>01260                 streamlog_out(DEBUG0) &lt;&lt; <span class="stringliteral">&quot;Found a TCMT hit. Layer: &quot;</span> &lt;&lt; layer &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
<a name="l01261"></a>01261                               &lt;&lt; <span class="stringliteral">&quot; Strip: &quot;</span> &lt;&lt; strip &lt;&lt; endl;
<a name="l01262"></a>01262                 
<a name="l01263"></a>01263                 <span class="keywordtype">float</span> energy = Hit-&gt;getEnergy();
<a name="l01264"></a>01264                 energyArr[strip][layer-1] = energy;
<a name="l01265"></a>01265                 countArr[strip][layer-1] += 1;
<a name="l01266"></a>01266                 
<a name="l01267"></a>01267                 cellID0Arr[strip][layer-1] = cellID0;
<a name="l01268"></a>01268                 xArr[strip][layer-1] = Hit-&gt;getPosition()[0];
<a name="l01269"></a>01269                 yArr[strip][layer-1] = Hit-&gt;getPosition()[1];
<a name="l01270"></a>01270                 zArr[strip][layer-1] = Hit-&gt;getPosition()[2];
<a name="l01271"></a>01271                 
<a name="l01272"></a>01272               }
<a name="l01273"></a>01273             <span class="keywordflow">else</span><span class="comment">/*hit is from HCAL*/</span>
<a name="l01274"></a>01274               {
<a name="l01275"></a>01275                 muonHcalCol-&gt;addElement(newHit);
<a name="l01276"></a>01276               }
<a name="l01277"></a>01277           }<span class="comment">/*end loop over iHit*/</span>
<a name="l01278"></a>01278       }<span class="comment">/*end loop over iCluster*/</span>
<a name="l01279"></a>01279     
<a name="l01280"></a>01280     <span class="comment">/*----------------------------------------------------------------</span>
<a name="l01281"></a>01281 <span class="comment">      HCAL muon hits*/</span>    
<a name="l01282"></a>01282     <span class="keywordflow">if</span> (muonHcalCol-&gt;getNumberOfElements() &gt; 0)
<a name="l01283"></a>01283       {
<a name="l01284"></a>01284         LCParameters &amp;param = muonHcalCol-&gt;parameters();
<a name="l01285"></a>01285         param.setValue(LCIO::CellIDEncoding, _encodingString);
<a name="l01286"></a>01286 
<a name="l01287"></a>01287         evt-&gt;addCollection(muonHcalCol, _ahcalOutputTrackColName.c_str());
<a name="l01288"></a>01288 
<a name="l01289"></a>01289         streamlog_out(DEBUG)&lt;&lt;<span class="stringliteral">&quot;\nFound &quot;</span>&lt;&lt;muonHcalCol-&gt;getNumberOfElements()&lt;&lt;<span class="stringliteral">&quot; muon hits in HCAL, saved in col &quot;</span>
<a name="l01290"></a>01290                     &lt;&lt;_ahcalOutputTrackColName&lt;&lt;<span class="stringliteral">&quot; in event &quot;</span>&lt;&lt;evt-&gt;getEventNumber()
<a name="l01291"></a>01291                     &lt;&lt;endl;
<a name="l01292"></a>01292 
<a name="l01293"></a>01293         <span class="comment">/*for debug</span>
<a name="l01294"></a>01294 <span class="comment">          CellIDDecoder&lt;CalorimeterHit&gt;* decoder = new CellIDDecoder&lt;CalorimeterHit&gt; (muonHcalCol);     </span>
<a name="l01295"></a>01295 <span class="comment">          for (int i = 0; i &lt; muonHcalCol-&gt;getNumberOfElements(); ++i)</span>
<a name="l01296"></a>01296 <span class="comment">          {</span>
<a name="l01297"></a>01297 <span class="comment">          CalorimeterHit *hit = dynamic_cast&lt;CalorimeterHit*&gt;(muonHcalCol-&gt;getElementAt(i));</span>
<a name="l01298"></a>01298 <span class="comment">          const int I = (*decoder)(hit)[&quot;I&quot;];</span>
<a name="l01299"></a>01299 <span class="comment">          const int J = (*decoder)(hit)[&quot;J&quot;];</span>
<a name="l01300"></a>01300 <span class="comment">          const int K = (*decoder)(hit)[&quot;K-1&quot;] + 1;</span>
<a name="l01301"></a>01301 <span class="comment">          </span>
<a name="l01302"></a>01302 <span class="comment">          cout&lt;&lt;&quot; I/J/K=&quot;&lt;&lt;I&lt;&lt;&quot;/&quot;&lt;&lt;J&lt;&lt;&quot;/&quot;&lt;&lt;K&lt;&lt;endl;</span>
<a name="l01303"></a>01303 <span class="comment">          }</span>
<a name="l01304"></a>01304 <span class="comment">        */</span>
<a name="l01305"></a>01305 
<a name="l01306"></a>01306       }
<a name="l01307"></a>01307   
<a name="l01308"></a>01308 
<a name="l01309"></a>01309     <span class="comment">/*----------------------------------------------------------------</span>
<a name="l01310"></a>01310 <span class="comment">      TCMT muon hits*/</span>
<a name="l01311"></a>01311     <span class="keywordflow">if</span> (_useTCMT == <span class="keyword">false</span>) <span class="keywordflow">return</span>; 
<a name="l01312"></a>01312     
<a name="l01313"></a>01313      <span class="comment">/*Now keep only the  TCMT hits which belong to a muon, i.e. for a given strip only if there are at least _minActiveTCMTParallelStrips  </span>
<a name="l01314"></a>01314 <span class="comment">      parallel strips active*/</span>
<a name="l01315"></a>01315 
<a name="l01316"></a>01316     <span class="keywordtype">int</span> minActiveParallelStrips  = _minActiveTCMTParallelStrips;
<a name="l01317"></a>01317     
<a name="l01318"></a>01318     <span class="keywordtype">int</span> evenAr[MAXTCMTLAYERS/2] = {0, 2, 4, 6, 8, 10, 12, 14};
<a name="l01319"></a>01319     <span class="keywordtype">int</span> oddAr[MAXTCMTLAYERS/2]  = {1, 3, 5, 7, 9, 11, 13, 15};
<a name="l01320"></a>01320     
<a name="l01321"></a>01321     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iStrip = 0; iStrip &lt; MAXTCMTSTRIPS; ++iStrip)
<a name="l01322"></a>01322       {
<a name="l01323"></a>01323         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iLayer = 0; iLayer &lt; MAXTCMTLAYERS; ++iLayer)
<a name="l01324"></a>01324           {
<a name="l01325"></a>01325             <span class="keywordtype">int</span> counts = 0;
<a name="l01326"></a>01326             
<a name="l01327"></a>01327             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; MAXTCMTLAYERS/2; ++i)
<a name="l01328"></a>01328               {
<a name="l01329"></a>01329                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> temp = 0;
<a name="l01330"></a>01330                 <span class="keywordflow">if</span> (iLayer % 2 == 0) <span class="comment">/*even layer*/</span>
<a name="l01331"></a>01331                   temp = evenAr[i];
<a name="l01332"></a>01332                 <span class="keywordflow">else</span>
<a name="l01333"></a>01333                   temp = oddAr[i];
<a name="l01334"></a>01334                 
<a name="l01335"></a>01335                 streamlog_out(DEBUG)&lt;&lt;<span class="stringliteral">&quot; iStrip=&quot;</span>&lt;&lt;iStrip&lt;&lt;<span class="stringliteral">&quot; iLayer=&quot;</span>&lt;&lt;iLayer&lt;&lt;<span class="stringliteral">&quot; i=&quot;</span>&lt;&lt;i
<a name="l01336"></a>01336                     &lt;&lt;<span class="stringliteral">&quot; temp=&quot;</span>&lt;&lt;temp
<a name="l01337"></a>01337                     &lt;&lt;<span class="stringliteral">&quot; countArr[iStrip][temp]=&quot;</span>&lt;&lt;countArr[iStrip][temp]
<a name="l01338"></a>01338                     &lt;&lt;endl;
<a name="l01339"></a>01339                 
<a name="l01340"></a>01340               counts += countArr[iStrip][temp];
<a name="l01341"></a>01341               
<a name="l01342"></a>01342               }
<a name="l01343"></a>01343             
<a name="l01344"></a>01344             streamlog_out(DEBUG)&lt;&lt;<span class="stringliteral">&quot;  counts=&quot;</span>&lt;&lt;counts&lt;&lt;endl;
<a name="l01345"></a>01345             
<a name="l01346"></a>01346             <span class="keywordflow">if</span> (counts &gt;= minActiveParallelStrips &amp;&amp; energyArr[iStrip][iLayer] &gt; 0)
<a name="l01347"></a>01347               {
<a name="l01348"></a>01348                 streamlog_out(DEBUG)&lt;&lt;<span class="stringliteral">&quot;------&gt; found a muon hit in strip=&quot;</span>&lt;&lt;iStrip&lt;&lt;<span class="stringliteral">&quot; layer=&quot;</span>&lt;&lt;iLayer&lt;&lt;endl;
<a name="l01349"></a>01349                 
<a name="l01350"></a>01350                 CalorimeterHitImpl *newHit = <span class="keyword">new</span> CalorimeterHitImpl();
<a name="l01351"></a>01351                 newHit-&gt;setEnergy(energyArr[iStrip][iLayer]);
<a name="l01352"></a>01352                 newHit-&gt;setCellID0(cellID0Arr[iStrip][iLayer]);
<a name="l01353"></a>01353                 <span class="keywordtype">float</span> position[3] = {xArr[iStrip][iLayer], yArr[iStrip][iLayer], zArr[iStrip][iLayer]};
<a name="l01354"></a>01354                 newHit-&gt;setPosition(position);
<a name="l01355"></a>01355                 muonTcmtCol-&gt;addElement(newHit);         
<a name="l01356"></a>01356               }
<a name="l01357"></a>01357             
<a name="l01358"></a>01358           }<span class="comment">/*end loop over iLayer*/</span>
<a name="l01359"></a>01359       }<span class="comment">/*end loop over iStrip*/</span>
<a name="l01360"></a>01360     
<a name="l01361"></a>01361     <span class="comment">/*------------------------------------------------------------------------------------*/</span>
<a name="l01362"></a>01362     
<a name="l01363"></a>01363     <span class="keywordflow">if</span> (muonTcmtCol-&gt;getNumberOfElements() &gt; 0)
<a name="l01364"></a>01364       {
<a name="l01365"></a>01365         LCParameters &amp;param = muonTcmtCol-&gt;parameters();
<a name="l01366"></a>01366         param.setValue(LCIO::CellIDEncoding, _encodingString);
<a name="l01367"></a>01367 
<a name="l01368"></a>01368         evt-&gt;addCollection(muonTcmtCol, _tcmtOutputTrackColName.c_str());
<a name="l01369"></a>01369 
<a name="l01370"></a>01370         streamlog_out(DEBUG)&lt;&lt;<span class="stringliteral">&quot;\nFound &quot;</span>&lt;&lt;muonTcmtCol-&gt;getNumberOfElements()&lt;&lt;<span class="stringliteral">&quot; muon hits in TCMT, saved in col &quot;</span>
<a name="l01371"></a>01371                     &lt;&lt; _tcmtOutputTrackColName
<a name="l01372"></a>01372                     &lt;&lt;endl;
<a name="l01373"></a>01373       }
<a name="l01374"></a>01374   }
<a name="l01375"></a>01375   
<a name="l01376"></a>01376   <span class="comment">/******************************************************************************/</span>
<a name="l01377"></a>01377   <span class="comment">/*                                                                            */</span>
<a name="l01378"></a>01378   <span class="comment">/*                                                                            */</span>
<a name="l01379"></a>01379   <span class="comment">/*                                                                            */</span>
<a name="l01380"></a>01380   <span class="comment">/******************************************************************************/</span>
<a name="l01381"></a>01381   EVENT::ClusterVec AngleTrackFinder::obtainSubClusters(EVENT::Cluster *clusterA)
<a name="l01382"></a>01382   {
<a name="l01383"></a>01383     <span class="comment">// Get the calorimeter Hits of the initial cluster</span>
<a name="l01384"></a>01384     EVENT::CalorimeterHitVec hitVecA = clusterA-&gt;getCalorimeterHits();
<a name="l01385"></a>01385     
<a name="l01386"></a>01386     std::sort(hitVecA.begin(), hitVecA.end(), ClusterOrdering::compareHitByLayer);
<a name="l01387"></a>01387     <span class="keyword">const</span> <span class="keywordtype">int</span> numOfHitsInCluster = hitVecA.size();
<a name="l01388"></a>01388  
<a name="l01389"></a>01389     <span class="comment">// first elemement</span>
<a name="l01390"></a>01390     <span class="keyword">const</span> <span class="keywordtype">int</span> cellIDA0 = hitVecA[0]-&gt;getCellID0();
<a name="l01391"></a>01391     HcalCellIndex geomIndexA(cellIDA0);
<a name="l01392"></a>01392     <span class="keywordtype">int</span> iniVal = geomIndexA.getLayerIndex();
<a name="l01393"></a>01393     
<a name="l01394"></a>01394     <span class="keywordtype">int</span> iNext;
<a name="l01395"></a>01395     <span class="keywordtype">int</span> iloop     = 1;
<a name="l01396"></a>01396     <span class="keywordtype">int</span> numOfGaps = 0;
<a name="l01397"></a>01397         
<a name="l01398"></a>01398     EVENT::ClusterVec allVecSubsample;
<a name="l01399"></a>01399     ClusterImpl *aVecSubsample = <span class="keyword">new</span> ClusterImpl;
<a name="l01400"></a>01400     
<a name="l01401"></a>01401     <span class="comment">// Fill the first element!</span>
<a name="l01402"></a>01402     aVecSubsample-&gt;addHit(hitVecA[0], 1.);
<a name="l01403"></a>01403       
<a name="l01404"></a>01404     <span class="keywordflow">while</span>(iloop &lt; numOfHitsInCluster)
<a name="l01405"></a>01405         {
<a name="l01406"></a>01406           <span class="keyword">const</span> <span class="keywordtype">int</span> cellIDA = hitVecA[iloop]-&gt;getCellID0();
<a name="l01407"></a>01407           HcalCellIndex geomIndex(cellIDA);
<a name="l01408"></a>01408           iNext = geomIndex.getLayerIndex();      
<a name="l01409"></a>01409           <span class="keywordtype">int</span> deltaElement = iNext - iniVal;
<a name="l01410"></a>01410           
<a name="l01411"></a>01411           <span class="comment">// allow gaps with maximum 2 elements missing</span>
<a name="l01412"></a>01412           
<a name="l01413"></a>01413           <span class="keywordflow">if</span>(deltaElement &lt; 4)
<a name="l01414"></a>01414             {
<a name="l01415"></a>01415               aVecSubsample-&gt;addHit(hitVecA[iloop], 1.);          
<a name="l01416"></a>01416             }
<a name="l01417"></a>01417           <span class="keywordflow">else</span>
<a name="l01418"></a>01418             {         
<a name="l01419"></a>01419               numOfGaps++;
<a name="l01420"></a>01420               allVecSubsample.push_back(aVecSubsample);
<a name="l01421"></a>01421               aVecSubsample = <span class="keyword">new</span> ClusterImpl;
<a name="l01422"></a>01422               aVecSubsample-&gt;addHit(hitVecA[iloop], 1.);
<a name="l01423"></a>01423             }
<a name="l01424"></a>01424           
<a name="l01425"></a>01425           iniVal = iNext;
<a name="l01426"></a>01426           iloop++;   
<a name="l01427"></a>01427           
<a name="l01428"></a>01428         }
<a name="l01429"></a>01429       
<a name="l01430"></a>01430       <span class="comment">/*Fill the last track segment*/</span>
<a name="l01431"></a>01431       allVecSubsample.push_back(aVecSubsample);
<a name="l01432"></a>01432       
<a name="l01433"></a>01433       <span class="keywordflow">return</span> allVecSubsample;
<a name="l01434"></a>01434       
<a name="l01435"></a>01435   }
<a name="l01436"></a>01436 
<a name="l01437"></a>01437 
<a name="l01438"></a>01438   <span class="comment">/******************************************************************************/</span>
<a name="l01439"></a>01439   <span class="comment">/*                                                                            */</span>
<a name="l01440"></a>01440   <span class="comment">/*                                                                            */</span>
<a name="l01441"></a>01441   <span class="comment">/*                                                                            */</span>
<a name="l01442"></a>01442   <span class="comment">/******************************************************************************/</span>
<a name="l01443"></a>01443   EVENT::ClusterVec AngleTrackFinder::removeIsolatedHits(EVENT::ClusterVec subCluster)
<a name="l01444"></a>01444   {
<a name="l01445"></a>01445     EVENT::ClusterVec goodClusters;
<a name="l01446"></a>01446     
<a name="l01447"></a>01447     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> isubCl = 0; isubCl &lt; subCluster.size(); isubCl++)
<a name="l01448"></a>01448       {
<a name="l01449"></a>01449         EVENT::CalorimeterHitVec hitVecA = subCluster[isubCl]-&gt;getCalorimeterHits();
<a name="l01450"></a>01450         <span class="comment">/* at least 2 hits in the subcluster*/</span>
<a name="l01451"></a>01451         <span class="keywordflow">if</span> (hitVecA.size() &gt; 1)
<a name="l01452"></a>01452           {
<a name="l01453"></a>01453             goodClusters.push_back(subCluster[isubCl]);
<a name="l01454"></a>01454           }
<a name="l01455"></a>01455       }
<a name="l01456"></a>01456     
<a name="l01457"></a>01457     <span class="keywordflow">return</span> goodClusters;
<a name="l01458"></a>01458   }
<a name="l01459"></a>01459 
<a name="l01460"></a>01460   <span class="comment">/******************************************************************************/</span>
<a name="l01461"></a>01461   <span class="comment">/*                                                                            */</span>
<a name="l01462"></a>01462   <span class="comment">/*                                                                            */</span>
<a name="l01463"></a>01463   <span class="comment">/*                                                                            */</span>
<a name="l01464"></a>01464   <span class="comment">/******************************************************************************/</span>
<a name="l01465"></a>01465   <span class="keywordtype">bool</span> AngleTrackFinder::checkXYAdjacentClusters(Cluster *clusterA,Cluster *clusterB, <span class="keywordtype">int</span> numOfAdjacentCells)
<a name="l01466"></a>01466   {
<a name="l01467"></a>01467     <span class="keywordflow">if</span> (clusterA == NULL || clusterB == NULL) 
<a name="l01468"></a>01468       {
<a name="l01469"></a>01469         cout&lt;&lt;<span class="stringliteral">&quot;\n checkXYAdyacentClusters: NULL pointers, exiting&quot;</span>&lt;&lt;endl;
<a name="l01470"></a>01470         exit(1);
<a name="l01471"></a>01471       }
<a name="l01472"></a>01472 
<a name="l01473"></a>01473     <span class="keyword">const</span> EVENT::CalorimeterHitVec hitVecA = clusterA-&gt;getCalorimeterHits();
<a name="l01474"></a>01474     <span class="keyword">const</span> EVENT::CalorimeterHitVec hitVecB = clusterB-&gt;getCalorimeterHits();
<a name="l01475"></a>01475 
<a name="l01476"></a>01476     <span class="comment">/* each cluster have same x,y*/</span>
<a name="l01477"></a>01477     <span class="keywordtype">float</span> Delta_x = fabs(hitVecA[0]-&gt;getPosition()[0] - hitVecB[0]-&gt;getPosition()[0]);
<a name="l01478"></a>01478     <span class="keywordtype">float</span> Delta_y = fabs(hitVecA[0]-&gt;getPosition()[1] - hitVecB[0]-&gt;getPosition()[1]);
<a name="l01479"></a>01479     
<a name="l01480"></a>01480     <span class="keywordtype">float</span> distanceInXY = (numOfAdjacentCells * 30) + 1;
<a name="l01481"></a>01481     
<a name="l01482"></a>01482     <span class="keywordflow">return</span> (Delta_x &lt; distanceInXY &amp;&amp; Delta_y &lt; distanceInXY);
<a name="l01483"></a>01483   }
<a name="l01484"></a>01484   
<a name="l01485"></a>01485 
<a name="l01486"></a>01486 
<a name="l01487"></a>01487 
<a name="l01488"></a>01488 
<a name="l01489"></a>01489 
<a name="l01490"></a>01490 
<a name="l01491"></a>01491 
<a name="l01492"></a>01492   <span class="comment">/******************************************************************************/</span>
<a name="l01493"></a>01493 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Dec 2017 for CALIB by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
