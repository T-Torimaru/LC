<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>RAW2CALOHIT: CalibrateAndApplyThreshold.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_f98b43a53f5533225f05987ae358305b.html">calice_reco</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_8656c002b32f5afd83fbcb1fc9f618b8.html">raw2calohit</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_4ccc65e3147d3d4ef3c56822860bbd3e.html">src</a>
  </div>
</div>
<div class="contents">
<h1>CalibrateAndApplyThreshold.cc</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;cmath&gt;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;iomanip&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;sstream&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;cassert&gt;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#include &quot;TH1F.h&quot;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;EVENT/LCCollection.h&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;EVENT/LCEvent.h&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;EVENT/RawCalorimeterHit.h&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;EVENT/SimCalorimeterHit.h&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;EVENT/LCObject.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;EVENT/LCParameters.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;EVENT/LCFloatVec.h&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;IMPL/CalorimeterHitImpl.h&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;IMPL/LCCollectionVec.h&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;EVENT/LCRelation.h&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;IMPL/LCFlagImpl.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;UTIL/LCRelationNavigator.h&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;lccd/LCConditionsMgr.hh&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;ErrorBits.hh&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;CalibrationFactory.hh&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;NoOpCalibration.hh&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;Calibration.hh&gt;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;marlin/ConditionsProcessor.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;marlin/Global.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;CalibrateAndApplyThreshold.hh&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;CellIndex.hh&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;NoiseParameter.hh&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;LCPayload.hh&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;SimpleHitSearch.hh&quot;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="keyword">using namespace </span>lcio;
<a name="l00040"></a>00040 <span class="keyword">using namespace </span>marlin;
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="keyword">namespace </span>CALICE {<span class="comment">//namespace CALICE</span>
<a name="l00043"></a>00043    CalibrateAndApplyThreshold b;
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 
<a name="l00046"></a><a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#ae2d615ca7797434d642f1ae6d6950974">00046</a>   <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#ae2d615ca7797434d642f1ae6d6950974" title="default constructor.">CalibrateAndApplyThreshold::CalibrateAndApplyThreshold</a>()
<a name="l00047"></a>00047     : <a class="code" href="classCALICE_1_1VRawADCValueProcessor.html" title="Abstract class which implements the minimal functionality to access raw ADC values...">VRawADCValueProcessor</a>(<span class="stringliteral">&quot;CalibrateAndApplyThreshold&quot;</span>),
<a name="l00048"></a>00048       _calibration(new <a class="code" href="classNoOpCalibration.html" title="Lazy calibration class.">NoOpCalibration</a>),
<a name="l00049"></a>00049       _cellCol(0),
<a name="l00050"></a>00050       _nEventsWithoutRAWHITS(0),
<a name="l00051"></a>00051       _nEventsWithoutSIMHITS(0),
<a name="l00052"></a>00052       _nEvt(0),
<a name="l00053"></a>00053       _hfile(0),
<a name="l00054"></a>00054       _detectorTransformationChange(this,&amp;<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html" title="Marlin Processor to go from RawCalorimeterHit to calibrated CalorimeterHits.">CalibrateAndApplyThreshold</a>::detectorTransformationChanged),
<a name="l00055"></a>00055       _referenceTransformationChange(this,&amp;<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html" title="Marlin Processor to go from RawCalorimeterHit to calibrated CalorimeterHits.">CalibrateAndApplyThreshold</a>::referenceTransformationChanged)
<a name="l00056"></a>00056    {
<a name="l00057"></a>00057 
<a name="l00058"></a>00058     registerProcessorParameter( <span class="stringliteral">&quot;SaveHistograms&quot;</span> ,
<a name="l00059"></a>00059                                <span class="stringliteral">&quot;Create a rootfile with control histograms&quot;</span> ,
<a name="l00060"></a>00060                                _saveHistograms ,
<a name="l00061"></a>00061                                 static_cast&lt;int&gt;(0));
<a name="l00062"></a>00062 
<a name="l00063"></a>00063     <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a3a6f0a6d75fa972ac6303604bb515fc7" title="Name of the hit collection (INPUT).">_rawhitColName</a>=COL_RAWHITS;
<a name="l00064"></a>00064     registerProcessorParameter( <span class="stringliteral">&quot;RawHitCollectionName&quot;</span> ,
<a name="l00065"></a>00065                                <span class="stringliteral">&quot;The name of the Rawcalorimeter hit collection (input) to be used&quot;</span> ,
<a name="l00066"></a>00066                                <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a3a6f0a6d75fa972ac6303604bb515fc7" title="Name of the hit collection (INPUT).">_rawhitColName</a> ,
<a name="l00067"></a>00067                                <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a3a6f0a6d75fa972ac6303604bb515fc7" title="Name of the hit collection (INPUT).">_rawhitColName</a>);
<a name="l00068"></a>00068 
<a name="l00069"></a>00069     registerProcessorParameter( <span class="stringliteral">&quot;InputRelCollections&quot;</span>,
<a name="l00070"></a>00070                                 <span class="stringliteral">&quot;Names of relation collections with simhits&quot;</span>,
<a name="l00071"></a>00071                                 <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a75f2b80baf0f8691c9d921d70bafb649" title="Name of the relation collection between Sim and Raw hits (INPUT).">_RawToSimColName</a>,
<a name="l00072"></a>00072                                 std::string(<span class="stringliteral">&quot;EcalProtoRaw2sim&quot;</span>) );
<a name="l00073"></a>00073 
<a name="l00074"></a>00074     <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a10dd53b4f7d1514791ec6c60329aaea4" title="Name of the hit collection (OUTPUT).">_hitColName</a>=COL_HITS;
<a name="l00075"></a>00075     registerProcessorParameter( <span class="stringliteral">&quot;HitCollectionName&quot;</span> ,
<a name="l00076"></a>00076                                <span class="stringliteral">&quot;The name of the calorimeter hit collection (output) to be used&quot;</span> ,
<a name="l00077"></a>00077                                <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a10dd53b4f7d1514791ec6c60329aaea4" title="Name of the hit collection (OUTPUT).">_hitColName</a> ,
<a name="l00078"></a>00078                                <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a10dd53b4f7d1514791ec6c60329aaea4" title="Name of the hit collection (OUTPUT).">_hitColName</a>);
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 
<a name="l00081"></a>00081     _cellParameterCollectionName=<span class="stringliteral">&quot;EmcCellParameters&quot;</span>;
<a name="l00082"></a>00082     registerProcessorParameter( <span class="stringliteral">&quot;CellParameterCollectionName&quot;</span> ,
<a name="l00083"></a>00083                                <span class="stringliteral">&quot;The name of the collection which contains the pedestals, the noise, etc. of all the cells.&quot;</span> ,
<a name="l00084"></a>00084                                _cellParameterCollectionName ,
<a name="l00085"></a>00085                                _cellParameterCollectionName);
<a name="l00086"></a>00086 
<a name="l00087"></a>00087     <span class="comment">// ---- collection name of calibration constants and name of calibration object</span>
<a name="l00088"></a>00088     registerProcessorParameter( <span class="stringliteral">&quot;Calibration&quot;</span> ,
<a name="l00089"></a>00089                                 <span class="stringliteral">&quot;Name of object to be used for the calibration&quot;</span>  ,
<a name="l00090"></a>00090                                 <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a36efa661235242659c74a49235164662" title="Name of the Calibration object to be used (will be created using the CalibrationFactory)...">_calibrationObjectName</a> ,
<a name="l00091"></a>00091                                 std::string(<span class="stringliteral">&quot;NoOpCalibration&quot;</span>) ) ;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093     registerOptionalParameter( <span class="stringliteral">&quot;CalibrationConstants&quot;</span> ,
<a name="l00094"></a>00094                                <span class="stringliteral">&quot;Name of the conditions data collection which contains the calibration constants&quot;</span>  ,
<a name="l00095"></a>00095                                <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a79e5cf6fc879e14cdd3c68f88b1ff7c1" title="Name of the conditions data collection containing the calibration constants.">_calibrationConstantColName</a> ,
<a name="l00096"></a>00096                                std::string(<span class="stringliteral">&quot;&quot;</span>) );
<a name="l00097"></a>00097 
<a name="l00098"></a>00098     <span class="comment">// --- detector position</span>
<a name="l00099"></a>00099     registerOptionalParameter( <span class="stringliteral">&quot;DetectorTransformationCollectionName&quot;</span> ,
<a name="l00100"></a>00100                                 <span class="stringliteral">&quot;Name of the conditions data collection which describes the detector position and rotation (folder e.g. /Calice/ECAL/Transformation)&quot;</span>  ,
<a name="l00101"></a>00101                                 <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a4a6e48e29b530ac9b80375776cd4af31" title="Name of the conditions data collection which describes the position and the rotation...">_colNameDetectorTransformation</a> ,
<a name="l00102"></a>00102                                 std::string(<span class="stringliteral">&quot;DetectorTransformation&quot;</span>) ) ;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     registerOptionalParameter( <span class="stringliteral">&quot;ReferenceTransformationCollectionName&quot;</span> ,
<a name="l00105"></a>00105                                 <span class="stringliteral">&quot;Name of the conditions data collection which describes the position and rotation of the reference coordinate system (folder e.g. /Calice/ECAL/Transformation)&quot;</span>  ,
<a name="l00106"></a>00106                                 <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a3e6c0435de64d50ae08374cf145c8c8b" title="Name of the conditions data collection which describes the reference position and...">_colNameReferenceTransformation</a> ,
<a name="l00107"></a>00107                                 std::string(<span class="stringliteral">&quot;ReferenceTransformation&quot;</span>) ) ;
<a name="l00108"></a>00108     <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a3e6c0435de64d50ae08374cf145c8c8b" title="Name of the conditions data collection which describes the reference position and...">_colNameReferenceTransformation</a>=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00109"></a>00109     <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a4a6e48e29b530ac9b80375776cd4af31" title="Name of the conditions data collection which describes the position and the rotation...">_colNameDetectorTransformation</a>=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a7c318b024c59652ac1989c8c1486aa49" title="Signals above the signal threshold and .">_signalThreshold</a> = .5;
<a name="l00112"></a>00112     registerProcessorParameter( <span class="stringliteral">&quot;SignalThreshold&quot;</span> ,
<a name="l00113"></a>00113                                <span class="stringliteral">&quot;Cells with a signal (after calibration) larger than this threshold are considered to have a hit. &quot;</span> ,
<a name="l00114"></a>00114                                <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a7c318b024c59652ac1989c8c1486aa49" title="Signals above the signal threshold and .">_signalThreshold</a> ,
<a name="l00115"></a>00115                                <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a7c318b024c59652ac1989c8c1486aa49" title="Signals above the signal threshold and .">_signalThreshold</a> ) ;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#adfacf11438d8b5f863f6e77722dc5e20" title="above the noise cut are considered to be hits.">_noiseCutVec</a>.clear();
<a name="l00118"></a>00118     <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#adfacf11438d8b5f863f6e77722dc5e20" title="above the noise cut are considered to be hits.">_noiseCutVec</a>.push_back( 5.);
<a name="l00119"></a>00119     registerProcessorParameter( <span class="stringliteral">&quot;NoiseCut&quot;</span> ,
<a name="l00120"></a>00120                                <span class="stringliteral">&quot;Cells with a signal-to-noise ratio larger than this value are considered to have a hit. The first element is used for hit search the second for hit rejection during noise calculation.&quot;</span> ,
<a name="l00121"></a>00121                                <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#adfacf11438d8b5f863f6e77722dc5e20" title="above the noise cut are considered to be hits.">_noiseCutVec</a> ,
<a name="l00122"></a>00122                                <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#adfacf11438d8b5f863f6e77722dc5e20" title="above the noise cut are considered to be hits.">_noiseCutVec</a>) ;
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 
<a name="l00125"></a>00125     registerProcessorParameter( <span class="stringliteral">&quot;LinkRecToSim&quot;</span>, <span class="stringliteral">&quot;Create link reconstricted -&gt; simulated hit&quot;</span>, <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#aba8a11b61c43b9339e3140839fc5b213" title="kkk flag to disable/enable the creation of an LCRelation to simulated hit">_linkRecToSim</a>, <span class="keyword">true</span>);
<a name="l00126"></a>00126     registerProcessorParameter( <span class="stringliteral">&quot;LinkRecToSimCollectionName&quot;</span>, <span class="stringliteral">&quot;Name of the link reconstructed -&gt; simulated hit collection&quot;</span>, <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a6ba0e8c707c10c6ace7b034293d34035" title="kkk: Name of the relation collection hit -&amp;gt; simhit (OUTPUT).">_RecToSimColName</a>, std::string(<span class="stringliteral">&quot;EmcRecToSim&quot;</span>));
<a name="l00127"></a>00127 
<a name="l00128"></a>00128     <span class="comment">//CRP 26/11/15 </span>
<a name="l00129"></a>00129     _fallbackShift = 10000.;
<a name="l00130"></a>00130     registerProcessorParameter( <span class="stringliteral">&quot;FallBackShift&quot;</span> ,
<a name="l00131"></a>00131                                <span class="stringliteral">&quot; Define a shift for cells which cannot be properly handled since they were present in the simulation but not in the data (e.g. DESY 2005, CERN 2006/2007&quot;</span> ,
<a name="l00132"></a>00132                                _fallbackShift ,
<a name="l00133"></a>00133                                _fallbackShift ) ;
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 
<a name="l00136"></a>00136    }
<a name="l00137"></a>00137 
<a name="l00138"></a><a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a1318d9f3f1a695b1996c30c63c47d085">00138</a>   <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a1318d9f3f1a695b1996c30c63c47d085" title="destructor.">CalibrateAndApplyThreshold::~CalibrateAndApplyThreshold</a>() {
<a name="l00139"></a>00139     <span class="keyword">delete</span> _calibration;
<a name="l00140"></a>00140   }
<a name="l00141"></a>00141 
<a name="l00142"></a><a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a69d43c0be2a238e99828c918003bde74">00142</a>   <span class="keywordtype">void</span> <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a69d43c0be2a238e99828c918003bde74" title="Called at the begin of the job before anything is read.">CalibrateAndApplyThreshold::init</a>()
<a name="l00143"></a>00143   {<span class="comment">//init</span>
<a name="l00144"></a>00144     std::stringstream message;
<a name="l00145"></a>00145     <span class="keywordtype">bool</span> error=<span class="keyword">false</span>;
<a name="l00146"></a>00146     <span class="keywordflow">try</span> {
<a name="l00147"></a>00147       <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a69d43c0be2a238e99828c918003bde74" title="Called at the begin of the job before anything is read.">VRawADCValueProcessor::init</a>();
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149     <span class="keywordflow">catch</span> (<a class="code" href="classCALICE_1_1ErrorMissingConditionsDataHandler.html">ErrorMissingConditionsDataHandler</a> &amp;conddata_error) {
<a name="l00150"></a>00150       <span class="comment">// --- catch conditions data handler registration errors</span>
<a name="l00151"></a>00151       <span class="comment">//   ... and build a combined error message.</span>
<a name="l00152"></a>00152       std::string a(conddata_error.what());
<a name="l00153"></a>00153       error=<span class="keyword">true</span>;
<a name="l00154"></a>00154       <span class="keywordflow">if</span> (a.size()&gt;0) {
<a name="l00155"></a>00155         a.erase(a.size()-1);
<a name="l00156"></a>00156         message &lt;&lt; a;
<a name="l00157"></a>00157       }
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="comment">// --- register conditions data handler</span>
<a name="l00161"></a>00161 
<a name="l00162"></a>00162     <span class="keywordflow">if</span> (!error) {
<a name="l00163"></a>00163       message &lt;&lt; <span class="stringliteral">&quot;CalibrateAndApplyThreshold::init&gt; no conditions data handler for the collections:&quot;</span>;
<a name="l00164"></a>00164     }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <span class="keywordflow">if</span> (!<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a4a6e48e29b530ac9b80375776cd4af31" title="Name of the conditions data collection which describes the position and the rotation...">_colNameDetectorTransformation</a>.empty()) {
<a name="l00167"></a>00167       <span class="keywordflow">if</span> (!marlin::ConditionsProcessor::registerChangeListener( &amp;<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a9f46c5087b5975ec06c36e9da4f33378" title="helper class to listen for changes of the detector position or rotation.">_detectorTransformationChange</a> ,<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a4a6e48e29b530ac9b80375776cd4af31" title="Name of the conditions data collection which describes the position and the rotation...">_colNameDetectorTransformation</a>) ) {
<a name="l00168"></a>00168         message &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a4a6e48e29b530ac9b80375776cd4af31" title="Name of the conditions data collection which describes the position and the rotation...">_colNameDetectorTransformation</a>;
<a name="l00169"></a>00169         error=<span class="keyword">true</span>;
<a name="l00170"></a>00170       }
<a name="l00171"></a>00171     }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     <span class="keywordflow">if</span> (!<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a3e6c0435de64d50ae08374cf145c8c8b" title="Name of the conditions data collection which describes the reference position and...">_colNameReferenceTransformation</a>.empty()) {
<a name="l00174"></a>00174       <span class="keywordflow">if</span> (!marlin::ConditionsProcessor::registerChangeListener( &amp;<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a1e6bdda0ecedd7a21053f54f178478b1" title="helper class to listen for changes of the reference position or rotation.">_referenceTransformationChange</a> ,<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a3e6c0435de64d50ae08374cf145c8c8b" title="Name of the conditions data collection which describes the reference position and...">_colNameReferenceTransformation</a>) ) {
<a name="l00175"></a>00175         message &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a3e6c0435de64d50ae08374cf145c8c8b" title="Name of the conditions data collection which describes the reference position and...">_colNameReferenceTransformation</a>;
<a name="l00176"></a>00176         error=<span class="keyword">true</span>;
<a name="l00177"></a>00177       }
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <span class="keywordflow">if</span> (error) {
<a name="l00181"></a>00181       <span class="comment">// also throw an exception if the registration of conditions data handlers failed in VRawADCValueProcessor::init</span>
<a name="l00182"></a>00182       message &lt;&lt;  <span class="stringliteral">&quot;.&quot;</span>;
<a name="l00183"></a>00183       <span class="keywordflow">throw</span> <a class="code" href="classCALICE_1_1ErrorMissingConditionsDataHandler.html">ErrorMissingConditionsDataHandler</a>(message.str());
<a name="l00184"></a>00184     }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="comment">//_cellParameter.clear();</span>
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     printParameters();
<a name="l00189"></a>00189     <span class="comment">//_nEventsWithoutRAWHITS = 0;</span>
<a name="l00190"></a>00190     <span class="comment">//_nEvt = 0;</span>
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <span class="comment">// --- Calibration object</span>
<a name="l00193"></a>00193     <span class="keyword">delete</span> _calibration;
<a name="l00194"></a>00194     <a class="code" href="classCalibrationFactory.html#a5efb95a0d951b8da5a8bdb5832a9831d" title="Get the global instance of the Calibration Object Factory.">CalibrationFactory::getInstance</a>()-&gt;<a class="code" href="classCalibrationFactory.html#a8ec8e4dacbc4b38c7fd760b7b00857d3" title="Show all registered kits.">listKits</a>();
<a name="l00195"></a>00195     _calibration=<a class="code" href="classCalibrationFactory.html#a5efb95a0d951b8da5a8bdb5832a9831d" title="Get the global instance of the Calibration Object Factory.">CalibrationFactory::getInstance</a>()-&gt;<a class="code" href="classCalibrationFactory.html#a8f74cdd3b9dffc44752f211743f6a74c" title="Get an object for the calibration.">createCalibrationObject</a>(<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a36efa661235242659c74a49235164662" title="Name of the Calibration object to be used (will be created using the CalibrationFactory)...">_calibrationObjectName</a>, <a class="code" href="classCALICE_1_1VRawADCValueProcessor.html#a7c7446a4e691d62dbeaaf09d64122af0" title="Name of the conditions data collection containing module descriptions.">_colNameModuleDescription</a>, <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a79e5cf6fc879e14cdd3c68f88b1ff7c1" title="Name of the conditions data collection containing the calibration constants.">_calibrationConstantColName</a>);
<a name="l00196"></a>00196 
<a name="l00197"></a>00197     <span class="keywordflow">if</span> (!_calibration) {
<a name="l00198"></a>00198       std::stringstream message;
<a name="l00199"></a>00199       message &lt;&lt; <span class="stringliteral">&quot;SimpleHitSearch::init&gt; Failed to create calibration object \&quot;&quot;</span> &lt;&lt; <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a36efa661235242659c74a49235164662" title="Name of the Calibration object to be used (will be created using the CalibrationFactory)...">_calibrationObjectName</a> &lt;&lt; <span class="stringliteral">&quot;\&quot;.&quot;</span>;
<a name="l00200"></a>00200       <span class="keywordflow">throw</span> std::runtime_error(message.str());
<a name="l00201"></a>00201     }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     <span class="comment">// --- initialise the analysis</span>
<a name="l00204"></a>00204     <span class="keywordflow">if</span> (<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#adfacf11438d8b5f863f6e77722dc5e20" title="above the noise cut are considered to be hits.">_noiseCutVec</a>.size()&lt;1) {
<a name="l00205"></a>00205       <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a457ab672e3467ed409a58e42e4aa6229" title="will be set by the first element of the _noiseCutVec">_noiseCut</a>=5;
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207     <span class="keywordflow">else</span> {
<a name="l00208"></a>00208       <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a457ab672e3467ed409a58e42e4aa6229" title="will be set by the first element of the _noiseCutVec">_noiseCut</a>=<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#adfacf11438d8b5f863f6e77722dc5e20" title="above the noise cut are considered to be hits.">_noiseCutVec</a>[0];
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     std::cout &lt;&lt; <span class="stringliteral">&quot;NoiseCut = &quot;</span> &lt;&lt; <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a457ab672e3467ed409a58e42e4aa6229" title="will be set by the first element of the _noiseCutVec">_noiseCut</a> &lt;&lt; std::endl;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 
<a name="l00214"></a>00214   }<span class="comment">//init</span>
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 
<a name="l00217"></a><a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a3bd3d21d979363fa105e7cea54148502">00217</a>   <span class="keywordtype">void</span> <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a3bd3d21d979363fa105e7cea54148502" title="Called for every run (does nothing.">CalibrateAndApplyThreshold::processRunHeader</a>( LCRunHeader* run){
<a name="l00218"></a>00218 
<a name="l00219"></a>00219     std::cout &lt;&lt; <span class="stringliteral">&quot;CalibrateAndApplyThreshold::processRu()  &quot;</span> &lt;&lt; name()
<a name="l00220"></a>00220          &lt;&lt; <span class="stringliteral">&quot; in run &quot;</span> &lt;&lt; run-&gt;getRunNumber()
<a name="l00221"></a>00221               &lt;&lt; std::endl ;
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     _runInfo.get(run);
<a name="l00224"></a>00224     _runInfo.print();
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="comment">//fill an LCParameter with the list of cellIDs of the dead cells</span>
<a name="l00227"></a>00227     <span class="comment">//dead = not connected (in connected PCBs) or calibration constant is not valid</span>
<a name="l00228"></a>00228     <span class="comment">//obtained from the Calice database</span>
<a name="l00229"></a>00229     EVENT::IntVec Vec;
<a name="l00230"></a>00230     <span class="keywordflow">if</span> (_mapping.isModuleConditionsDataComplete()) {
<a name="l00231"></a>00231       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_modules = _mapping.getNModules();
<a name="l00232"></a>00232       <span class="keywordflow">for</span> (UInt_t module_i=0; module_i&lt;n_modules; module_i++) {
<a name="l00233"></a>00233         UInt_t cells_per_module=_mapping.getNCellsPerModule(module_i);
<a name="l00234"></a>00234         <span class="keywordflow">for</span> (UInt_t cell_i=0; cell_i&lt;cells_per_module; cell_i++) {
<a name="l00235"></a>00235           <span class="keywordflow">if</span> (_mapping.isCellDead(module_i,cell_i) || !_calibration-&gt;<a class="code" href="classCalibration.html#a7d516d7b66b1f20640829d12adfd64d6" title="Return true if a the calibration constants for the given cell are in the allowed...">isValid</a>(_mapping.getModuleID(module_i),_mapping.getModuleType(module_i),cell_i)){
<a name="l00236"></a>00236             Vec.push_back(_mapping.getGeometricalCellIndex(module_i,cell_i));
<a name="l00237"></a>00237           }
<a name="l00238"></a>00238         }
<a name="l00239"></a>00239       }
<a name="l00240"></a>00240     }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     (run-&gt;parameters()).setValues(<span class="stringliteral">&quot;DeadCells&quot;</span>,Vec);
<a name="l00243"></a>00243 
<a name="l00244"></a>00244   }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 
<a name="l00247"></a><a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a2c3e34db11fe08fab2b184cc87f4d7b5">00247</a>   <span class="keywordtype">void</span> <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a2c3e34db11fe08fab2b184cc87f4d7b5" title="Reconstruct calorimeter hits.">CalibrateAndApplyThreshold::processEvent</a>( LCEvent * evtP )
<a name="l00248"></a>00248   {<span class="comment">//processEvt</span>
<a name="l00249"></a>00249     <span class="comment">//static bool firstEvent = true;</span>
<a name="l00250"></a>00250     <span class="keywordflow">try</span> {<span class="comment">//try</span>
<a name="l00251"></a>00251       <span class="comment">//FIXME: check there is rawhits in the collection, else, do nothing, a mssing raw collection might indicate a  serious</span>
<a name="l00252"></a>00252       <span class="comment">//problem, error catching to be updated.</span>
<a name="l00253"></a>00253       LCCollection* col_rawhits = evtP-&gt;getCollection( <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a3a6f0a6d75fa972ac6303604bb515fc7" title="Name of the hit collection (INPUT).">_rawhitColName</a> ) ;
<a name="l00254"></a>00254       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_modules = _mapping.getNModules();
<a name="l00255"></a>00255       <span class="comment">//then, access the cell parameters. For data, it will be the ones saved in SimpleHitSearch or in the cellParam collection, but for MC it will be created for the first event only from the database collection.</span>
<a name="l00256"></a>00256       <a class="code" href="classSimpleArray__t.html" title="Wrapper around std::vector which adds optional boundary check (at compile time).">NoiseParameterArray_t</a> &amp;noiseArray = SimpleHitSearch::getCellParameters();
<a name="l00257"></a>00257 
<a name="l00258"></a>00258       <span class="keywordflow">if</span> (!_runInfo.isMC() &amp;&amp; noiseArray.size() == 0) {<span class="comment">//data when SimpleHitSearch is not run before</span>
<a name="l00259"></a>00259         _cellCol = evtP-&gt;getCollection( _cellParameterCollectionName );
<a name="l00260"></a>00260         noiseArray.clear();
<a name="l00261"></a>00261         <span class="keywordflow">if</span> (noiseArray.size()!=n_modules) noiseArray.resize(n_modules);
<a name="l00262"></a>00262         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nHits = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span><span class="keyword">&gt;</span>(_cellCol-&gt;getNumberOfElements());
<a name="l00263"></a>00263         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> element = 0;
<a name="l00264"></a>00264         <span class="keywordflow">for</span> (UInt_t mod = 0; mod &lt; n_modules; mod++){<span class="comment">//loop on modules</span>
<a name="l00265"></a>00265           <span class="keywordflow">for</span> (UInt_t cell = 0; cell &lt; _mapping.getNCellsPerModule(mod); cell++){
<a name="l00266"></a>00266 
<a name="l00267"></a>00267             <span class="keywordflow">if</span> (element &gt;= nHits) {
<a name="l00268"></a>00268               std::stringstream message;
<a name="l00269"></a>00269               message &lt;&lt; <span class="stringliteral">&quot;CalibrateAndApplyThreshold::ProcessEvent&gt; ERROR: found more elements than saved in the cell parameter collection ! n_modules = &quot;</span> &lt;&lt; n_modules &lt;&lt; <span class="stringliteral">&quot;, and number of elements in collection &quot;</span> &lt;&lt; _cellParameterCollectionName &lt;&lt; <span class="stringliteral">&quot; is &quot;</span> &lt;&lt; nHits &lt;&lt; std::endl;
<a name="l00270"></a>00270               <span class="keywordflow">throw</span> runtime_error(message.str());
<a name="l00271"></a>00271             }
<a name="l00272"></a>00272             <span class="keyword">const</span> <a class="code" href="classLCPayload.html" title="Specific LCIO implementation of the interface to store generic user data.">LCPayload&lt;NoiseParameter&gt;</a> p(dynamic_cast&lt;LCGenericObject*&gt;(_cellCol-&gt;getElementAt(element)));
<a name="l00273"></a>00273             <a class="code" href="classCALICE_1_1NoiseParameter.html" title="Information about a pad: Pedestal, noise, etc.">NoiseParameter</a> noisePar = p.payload();
<a name="l00274"></a>00274             noiseArray[mod].push_back(noisePar);
<a name="l00275"></a>00275             element++;
<a name="l00276"></a>00276           }
<a name="l00277"></a>00277         }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279       }<span class="comment">//data</span>
<a name="l00280"></a>00280       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_runInfo.isMC()) {<span class="comment">//isMC</span>
<a name="l00281"></a>00281         <span class="comment">//need to copy the parameters from the collection saved with digi step. takeCollection allows the same parameters to be read for each events, as the collection will exist only in the first event.</span>
<a name="l00282"></a>00282         <span class="comment">//if (firstEvent) _cellCol = evtP-&gt;takeCollection( _cellParameterCollectionName );</span>
<a name="l00283"></a>00283 
<a name="l00284"></a>00284         noiseArray.clear();
<a name="l00285"></a>00285         <span class="keywordflow">if</span> (noiseArray.size()!=30) noiseArray.resize(30);
<a name="l00286"></a>00286 
<a name="l00287"></a>00287         <span class="comment">//CRP 25/11/15 Take out the try block as a missing handler in the following is not correctly caught by lccd </span>
<a name="l00288"></a>00288         <span class="comment">//try {</span>
<a name="l00289"></a>00289           <span class="comment">//Protect against missing handler (happens if you don&apos;t use existing tools!!!!!)</span>
<a name="l00290"></a>00290           <span class="keywordflow">if</span>(lccd::LCConditionsMgr::instance()-&gt;getHandler(_cellParameterCollectionName)){
<a name="l00291"></a>00291             _cellCol = (lccd::LCConditionsMgr::instance()-&gt;getHandler(_cellParameterCollectionName))-&gt;currentCollection();
<a name="l00292"></a>00292            <span class="comment">//CRP 25/11/15 Remark no further check for non null pointer needed since LCCD either returns a collection or</span>
<a name="l00293"></a>00293            <span class="comment">//throws and exception, see e.g. DBCondHandler.cc in LCCD </span>
<a name="l00294"></a>00294            <span class="comment">//Hardcoded and ugly!!!!!!</span>
<a name="l00295"></a>00295             assert (_cellCol-&gt;getNumberOfElements() == 30*324);
<a name="l00296"></a>00296             <span class="keywordflow">for</span> (UInt_t element_i=0; element_i &lt; static_cast&lt;UInt_t&gt;(_cellCol-&gt;getNumberOfElements()); element_i++) {
<a name="l00297"></a>00297               <span class="keyword">const</span> <a class="code" href="classLCPayload.html" title="Specific LCIO implementation of the interface to store generic user data.">LCPayload&lt;NoiseParameter&gt;</a> p(dynamic_cast&lt;LCGenericObject*&gt;(_cellCol-&gt;getElementAt(element_i)));
<a name="l00298"></a>00298               <a class="code" href="classCALICE_1_1NoiseParameter.html" title="Information about a pad: Pedestal, noise, etc.">NoiseParameter</a> noisePar = p.payload();
<a name="l00299"></a>00299               CellIndex dec(noisePar.getGeomCellIndex());
<a name="l00300"></a>00300               assert (dec.getLayerIndex() &gt; 0 &amp;&amp; dec.getLayerIndex() &lt; 31);
<a name="l00301"></a>00301               noiseArray[dec.getLayerIndex()-1].push_back(noisePar);
<a name="l00302"></a>00302             }
<a name="l00303"></a>00303             <span class="comment">//CRP 25/11/15 Not very nice to throw an exception that normally lccd should throw (in LCConditionsMgr::getHandler) </span>
<a name="l00304"></a>00304             <span class="comment">//but it&apos;s the cleanest way here </span>
<a name="l00305"></a>00305             <span class="comment">//since after all a request for a conditions data collection has failed</span>
<a name="l00306"></a>00306           } <span class="keywordflow">else</span> {<span class="keywordflow">throw</span> lccd::LCCDException(<span class="stringliteral">&quot; CALICE::CalibrateAndApplyThreshold: no handler &quot;</span>
<a name="l00307"></a>00307                             <span class="stringliteral">&quot; for name: &quot;</span> + _cellParameterCollectionName) ; }
<a name="l00308"></a>00308           <span class="comment">//Leave the catch block in for future correction of lccd</span>
<a name="l00309"></a>00309           <span class="comment">//} catch ( DataNotAvailableException &amp;err ){</span>
<a name="l00310"></a>00310           <span class="comment">//std::cout &lt;&lt; &quot;No cell parameter collection for event&quot; &lt;&lt; std::endl;</span>
<a name="l00311"></a>00311           <span class="comment">//}</span>
<a name="l00312"></a>00312 
<a name="l00313"></a>00313       }<span class="comment">//isMC</span>
<a name="l00314"></a>00314       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (noiseArray.size() &lt; n_modules ) {
<a name="l00315"></a>00315         std::stringstream message;
<a name="l00316"></a>00316         message &lt;&lt; <span class="stringliteral">&quot; ERROR : wrong access to the cell parameters in data ! Size of the array should be at least &quot;</span> &lt;&lt; _mapping.getNModules() &lt;&lt; <span class="stringliteral">&quot; and is : &quot;</span> &lt;&lt; noiseArray.size() &lt;&lt; <span class="stringliteral">&quot;. Exiting....&quot;</span>;
<a name="l00317"></a>00317         <span class="keywordflow">throw</span> std::runtime_error(message.str());
<a name="l00318"></a>00318       }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320       <span class="comment">//next step, loop over rawHits, calibrate and copy the ones above threshold in the output collection.</span>
<a name="l00321"></a>00321 
<a name="l00322"></a>00322       <span class="comment">//the relation collection is needed for MC events, to copy the position from the simhits for not connected layers where the mapping doesn&apos;t exist.</span>
<a name="l00323"></a>00323       LCCollection* col_RawToSim = 0;
<a name="l00324"></a>00324       <span class="keywordflow">if</span> (_runInfo.isMC()) {
<a name="l00325"></a>00325         <span class="keywordflow">try</span> {col_RawToSim = evtP-&gt;getCollection(<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a75f2b80baf0f8691c9d921d70bafb649" title="Name of the relation collection between Sim and Raw hits (INPUT).">_RawToSimColName</a>); }
<a name="l00326"></a>00326         <span class="keywordflow">catch</span> ( DataNotAvailableException &amp;err ){
<a name="l00327"></a>00327           streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;CalibrateAndApplyThreshold&gt;&gt;processEvent: No relation rawhits &lt;-&gt; Simhits. Missing SimHits?&quot;</span> &lt;&lt; endl;
<a name="l00328"></a>00328           _nEventsWithoutSIMHITS++;
<a name="l00329"></a>00329         }
<a name="l00330"></a>00330       }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332       LCCollection* col_hit=<span class="keyword">new</span> LCCollectionVec( LCIO::CALORIMETERHIT );
<a name="l00333"></a>00333       EVENT::LCParameters &amp; theParam = col_hit-&gt;parameters();
<a name="l00334"></a>00334       <span class="comment">//Set the cell decoder which might be useful in event displays</span>
<a name="l00335"></a>00335       <span class="comment">//suggested by Allister</span>
<a name="l00336"></a>00336       <span class="comment">//hardcoded, no good, should be created somehow automatically</span>
<a name="l00337"></a>00337       <span class="comment">//theParam.setValue(LCIO::CellIDEncoding,&quot;M:3,S-1:3,I:9,J:9,K-1:6&quot;);</span>
<a name="l00338"></a>00338       theParam.setValue(LCIO::CellIDEncoding,_mapping.getCellIDEncoding());
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 <span class="preprocessor">#ifdef EXPORT_SIGNAL_TO_NOISE_RATIO</span>
<a name="l00341"></a>00341 <span class="preprocessor"></span>      LCFloatVec signal_over_noise_ratio;
<a name="l00342"></a>00342       signal_over_noise_ratio.clear();
<a name="l00343"></a>00343 <span class="preprocessor">#endif</span>
<a name="l00344"></a>00344 <span class="preprocessor"></span>      <span class="comment">// write 3d coordinates</span>
<a name="l00345"></a>00345       LCFlagImpl hitFlag(col_hit-&gt;getFlag()) ;
<a name="l00346"></a>00346       hitFlag.setBit( LCIO::RCHBIT_LONG) ;
<a name="l00347"></a>00347       hitFlag.setBit( LCIO::RCHBIT_ID1) ;
<a name="l00348"></a>00348       col_hit-&gt;setFlag( hitFlag.getFlag()  ) ;
<a name="l00349"></a>00349 
<a name="l00350"></a>00350       Int_t minAdcSignalThreshold = _calibration-&gt;<a class="code" href="classCalibration.html#a4e45f1eca0d4fdf19ad76b8f581aee12" title="Get the minimum adc value mips will have for the given energy fraction on all pads...">getMiniumADCForMipThreshold</a>(<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a7c318b024c59652ac1989c8c1486aa49" title="Signals above the signal threshold and .">_signalThreshold</a>);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352       <span class="keywordflow">if</span> (col_rawhits &amp;&amp; col_rawhits-&gt;getNumberOfElements()&gt;0) {<span class="comment">//if input col</span>
<a name="l00353"></a>00353 
<a name="l00354"></a>00354         LCRelationNavigator nav_RecToSim(LCIO::CALORIMETERHIT, LCIO::SIMCALORIMETERHIT);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ele = 0; ele &lt; col_rawhits-&gt;getNumberOfElements(); ele++)
<a name="l00357"></a>00357           {<span class="comment">//loop on raw hits</span>
<a name="l00358"></a>00358             RawCalorimeterHit *hit_raw = <span class="keyword">dynamic_cast&lt;</span>RawCalorimeterHit*<span class="keyword">&gt;</span>(col_rawhits-&gt;getElementAt(ele));
<a name="l00359"></a>00359             CellIndex mydec(hit_raw-&gt;getCellID0(),hit_raw-&gt;getCellID1());
<a name="l00360"></a>00360             UInt_t K = mydec.getLayerIndex();
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 <span class="preprocessor">#ifdef BOUNDARY_CHECK</span>
<a name="l00363"></a>00363 <span class="preprocessor"></span>              <span class="keywordflow">if</span> ( !(mydec.getLayerIndex() &gt;= 1 &amp;&amp; mydec.getLayerIndex() &lt;= 30) ||
<a name="l00364"></a>00364                    !(mydec.getWaferRow() &gt;= 1 &amp;&amp; mydec.getWaferRow() &lt;= 3) ||
<a name="l00365"></a>00365                    !(mydec.getWaferColumn() &gt;= 1 &amp;&amp; mydec.getWaferColumn() &lt;= 3)||
<a name="l00366"></a>00366                    !(mydec.getPadRow() &gt;= 1 &amp;&amp; mydec.getPadRow() &lt;= 6)||
<a name="l00367"></a>00367                    !(mydec.getPadColumn() &gt;= 1 &amp;&amp; mydec.getPadColumn() &lt;= 6))
<a name="l00368"></a>00368                 {
<a name="l00369"></a>00369                   std::cout &lt;&lt; <span class="stringliteral">&quot; CalibrateAndApplyThreshold::WRONG decoding of indices ! &quot;</span> &lt;&lt; std::endl &lt;&lt;
<a name="l00370"></a>00370                     <span class="stringliteral">&quot; CellID0 = &quot;</span> &lt;&lt; hit_raw-&gt;getCellID0() &lt;&lt; std::endl &lt;&lt;
<a name="l00371"></a>00371                     <span class="stringliteral">&quot; CellID1 = &quot;</span> &lt;&lt; hit_raw-&gt;getCellID1() &lt;&lt; std::endl &lt;&lt;
<a name="l00372"></a>00372                     <span class="stringliteral">&quot; Layer = &quot;</span> &lt;&lt; mydec.getLayerIndex() &lt;&lt; std::endl &lt;&lt;
<a name="l00373"></a>00373                     <span class="stringliteral">&quot; Wafer Row (M) = &quot;</span> &lt;&lt; mydec.getWaferRow() &lt;&lt; std::endl &lt;&lt;
<a name="l00374"></a>00374                     <span class="stringliteral">&quot; Wafer Column (S) = &quot;</span> &lt;&lt; mydec.getWaferColumn() &lt;&lt; std::endl &lt;&lt;
<a name="l00375"></a>00375                     <span class="stringliteral">&quot; Pad Row (I) = &quot;</span> &lt;&lt; mydec.getPadRow() &lt;&lt; std::endl &lt;&lt;
<a name="l00376"></a>00376                     <span class="stringliteral">&quot; Pad Column (J) = &quot;</span> &lt;&lt; mydec.getPadColumn() &lt;&lt;  std::endl &lt;&lt;
<a name="l00377"></a>00377                     <span class="stringliteral">&quot; ...........Exiting.........&quot;</span> &lt;&lt; std::endl;
<a name="l00378"></a>00378                   exit(0);
<a name="l00379"></a>00379                 }
<a name="l00380"></a>00380 <span class="preprocessor">#endif</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span>
<a name="l00382"></a>00382             assert (K &gt; 0 &amp;&amp; K &lt; 31);
<a name="l00383"></a>00383             UInt_t cell_i = mydec.getCellID();
<a name="l00384"></a>00384             <span class="comment">//FIXME: What happens if we simulate a different number of</span>
<a name="l00385"></a>00385             <span class="comment">//Modules than were actually connected</span>
<a name="l00386"></a>00386             <span class="comment">//I think than we find nothing in the lookup table</span>
<a name="l00387"></a>00387             <span class="comment">//I believe that a simple modif of the following function can remedy the</span>
<a name="l00388"></a>00388             <span class="comment">//situation. At the moment it is ok that it throws a run time error</span>
<a name="l00389"></a>00389             <span class="comment">//To be verified !!!!!!!!</span>
<a name="l00390"></a>00390             <span class="comment">//CAMM: it&apos;s much faster to use already the value saved instead of recalculating it from scratch... the method _mapping.getModuleIndexFromCellIndex() is quite time consuming.</span>
<a name="l00391"></a>00391             UInt_t module_index = mydec.getModuleIndex();<span class="comment">//_mapping.getModuleIndexFromCellIndex(hit_raw-&gt;getCellID0());</span>
<a name="l00392"></a>00392 <span class="preprocessor">#ifdef RECO_DEBUG</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span>            std::cout &lt;&lt; <span class="stringliteral">&quot;Found module index: &quot;</span> &lt;&lt; module_index &lt;&lt; <span class="stringliteral">&quot; from cell: &quot;</span> &lt;&lt; std::hex &lt;&lt; hit_raw-&gt;getCellID0() &lt;&lt; std::dec &lt;&lt; std::endl;
<a name="l00394"></a>00394 <span class="preprocessor">#endif</span>
<a name="l00395"></a>00395 <span class="preprocessor"></span>            <span class="comment">//CRP The check on a valid module index has to be revised</span>
<a name="l00396"></a>00396             <span class="comment">//assert (module_index &gt;= _mapping.getNModules());</span>
<a name="l00397"></a>00397             UInt_t module_id = mydec.getModuleID();
<a name="l00398"></a>00398             UInt_t module_type = mydec.getModuleType();
<a name="l00399"></a>00399             UInt_t isBad = mydec.isBad();
<a name="l00400"></a>00400             assert (cell_i &lt; 324);
<a name="l00401"></a>00401 
<a name="l00402"></a>00402             UInt_t layer = 0;
<a name="l00403"></a>00403             UInt_t cell=0;
<a name="l00404"></a>00404             <span class="comment">//CRP Rearrange for the tme being to be save for</span>
<a name="l00405"></a>00405             <span class="comment">//data -&gt; to be verified for MC!!!!!</span>
<a name="l00406"></a>00406             <span class="comment">//CAMM: OK for MC!</span>
<a name="l00407"></a>00407             UInt_t access_parameter;
<a name="l00408"></a>00408             <span class="keywordflow">if</span> (!_runInfo.isMC()) {
<a name="l00409"></a>00409               access_parameter = module_index;
<a name="l00410"></a>00410               cell = cell_i;
<a name="l00411"></a>00411             }
<a name="l00412"></a>00412             <span class="keywordflow">else</span> {
<a name="l00413"></a>00413               layer = K-1;
<a name="l00414"></a>00414               access_parameter = layer;
<a name="l00415"></a>00415               cell = 36*(3*(mydec.getWaferColumn()-1)+mydec.getWaferRow()-1)+6*(mydec.getPadColumn()-1)+mydec.getPadRow()-1;
<a name="l00416"></a>00416               assert (layer &gt;= 0);
<a name="l00417"></a>00417               assert (layer &lt; 30);
<a name="l00418"></a>00418               assert (cell &gt;= 0);
<a name="l00419"></a>00419               assert (cell &lt; 324);
<a name="l00420"></a>00420             }
<a name="l00421"></a>00421 
<a name="l00422"></a>00422             <span class="comment">//If at all</span>
<a name="l00423"></a>00423             <a class="code" href="classCALICE_1_1NoiseParameter.html" title="Information about a pad: Pedestal, noise, etc.">NoiseParameter</a> &amp;cell_parameter=noiseArray[access_parameter][cell];
<a name="l00424"></a>00424             Float_t noise = cell_parameter.<a class="code" href="classCALICE_1_1NoiseParameter.html#a25c5efb36b96a6d55f475d7721585d87" title="Get the noise.">getNoise</a>();
<a name="l00425"></a>00425 
<a name="l00426"></a>00426             <span class="comment">// buffer the calibrated value, to avoid a recalculation</span>
<a name="l00427"></a>00427             Float_t raw_value = 0;
<a name="l00428"></a>00428             <span class="keywordflow">if</span> (!_runInfo.isMC()) raw_value = static_cast&lt;float&gt;(hit_raw-&gt;getAmplitude())/10000.;
<a name="l00429"></a>00429             <span class="keywordflow">else</span> raw_value = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(hit_raw-&gt;getAmplitude());
<a name="l00430"></a>00430 
<a name="l00431"></a>00431             <span class="comment">//std::cout &lt;&lt; &quot; Hit : &quot; &lt;&lt; ele &lt;&lt; &quot;, module_id = &quot; &lt;&lt; module_id &lt;&lt; &quot;, module_type = &quot; &lt;&lt; module_type &lt;&lt; &quot;, cell_i = &quot; &lt;&lt; cell_i &lt;&lt; &quot;, layer &quot; &lt;&lt; K &lt;&lt; &quot; S,M,I,J : &quot; &lt;&lt; mydec.getWaferRow()&lt;&lt;&quot;,&quot;&lt;&lt;mydec.getWaferColumn()&lt;&lt;&quot;,&quot;&lt;&lt;mydec.getPadRow()&lt;&lt;&quot;,&quot;&lt;&lt;mydec.getPadColumn() &lt;&lt; &quot; ==&gt; raw value = &quot; &lt;&lt; raw_value &lt;&lt; std::endl;</span>
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 
<a name="l00434"></a>00434             Float_t calibrated_value = 0;
<a name="l00435"></a>00435             <span class="keywordflow">if</span> (((_runInfo.isMC() &amp;&amp; !cell_parameter.<a class="code" href="classCALICE_1_1NoiseParameter.html#aaad737204e2573e3fb934bb9ef373107" title="Return kTRUE if the pad is considered to be dead.">isDead</a>()) || !_runInfo.isMC()) &amp;&amp; isBad == 0) {
<a name="l00436"></a>00436               calibrated_value = _calibration-&gt;<a class="code" href="classCalibration.html#aca88d93a445ba3021c05dd61b293568c" title="Determine from a pedestal subtracted ADC value a calibrated value.">getCalibratedValue</a>(module_id,module_type,cell_i,raw_value);
<a name="l00437"></a>00437             }
<a name="l00438"></a>00438             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_runInfo.isMC()) calibrated_value = 1./50*raw_value; <span class="comment">//dummy value for the MC layers.</span>
<a name="l00439"></a>00439 
<a name="l00440"></a>00440             <span class="keywordflow">if</span> (raw_value&gt;minAdcSignalThreshold &amp;&amp; raw_value&gt;noise*<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a457ab672e3467ed409a58e42e4aa6229" title="will be set by the first element of the _noiseCutVec">_noiseCut</a> &amp;&amp; calibrated_value&gt;<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a7c318b024c59652ac1989c8c1486aa49" title="Signals above the signal threshold and .">_signalThreshold</a>)
<a name="l00441"></a>00441               {<span class="comment">// -- signal</span>
<a name="l00442"></a>00442 
<a name="l00443"></a>00443                 
<a name="l00444"></a>00444 <span class="preprocessor">#ifdef RECO_DEBUG</span>
<a name="l00445"></a>00445 <span class="preprocessor"></span>                <span class="comment">//CRP 25/11/15 some sanity checks</span>
<a name="l00446"></a>00446                 <span class="keywordflow">if</span>(cell_parameter.<a class="code" href="classCALICE_1_1NoiseParameter.html#aaad737204e2573e3fb934bb9ef373107" title="Return kTRUE if the pad is considered to be dead.">isDead</a>()) { 
<a name="l00447"></a>00447                   std::cout &lt;&lt; <span class="stringliteral">&quot;is dead: ?&quot;</span> &lt;&lt; cell_parameter.<a class="code" href="classCALICE_1_1NoiseParameter.html#aaad737204e2573e3fb934bb9ef373107" title="Return kTRUE if the pad is considered to be dead.">isDead</a>() &lt;&lt; std::endl;
<a name="l00448"></a>00448                   std::cout &lt;&lt; <span class="stringliteral">&quot;is Bad: ?&quot;</span> &lt;&lt; isBad &lt;&lt; std::endl;
<a name="l00449"></a>00449                   std::cout &lt;&lt; <span class="stringliteral">&quot;Noise: &quot;</span> &lt;&lt;  noise&lt;&lt; std::endl; 
<a name="l00450"></a>00450                   std::cout &lt;&lt; <span class="stringliteral">&quot;Raw value: &quot;</span> &lt;&lt; raw_value &lt;&lt; std::endl;
<a name="l00451"></a>00451                   std::cout &lt;&lt; <span class="stringliteral">&quot;Calibrated value: &quot;</span> &lt;&lt; calibrated_value &lt;&lt; std::endl;
<a name="l00452"></a>00452                   std::cout &lt;&lt; <span class="stringliteral">&quot;Check cell: &quot;</span> &lt;&lt; cell_i &lt;&lt; std::endl;
<a name="l00453"></a>00453                   std::cout &lt;&lt; <span class="stringliteral">&quot;CellID0 = &quot;</span> &lt;&lt; std::hex &lt;&lt; hit_raw-&gt;getCellID0() &lt;&lt; std::endl &lt;&lt;<span class="stringliteral">&quot; CellID1 = &quot;</span> &lt;&lt; hit_raw-&gt;getCellID1() &lt;&lt; std::dec &lt;&lt; std::endl;
<a name="l00454"></a>00454                   std::cout &lt;&lt; <span class="stringliteral">&quot;Check dead cells: &quot;</span> &lt;&lt; mydec.getLayerIndex() &lt;&lt; <span class="stringliteral">&quot;, M=&quot;</span> &lt;&lt; mydec.getWaferRow() &lt;&lt; <span class="stringliteral">&quot;, S=&quot;</span> &lt;&lt; mydec.getWaferColumn() &lt;&lt; <span class="stringliteral">&quot;, I=&quot;</span> &lt;&lt; mydec.getPadRow() &lt;&lt; <span class="stringliteral">&quot;, J=&quot;</span> &lt;&lt; mydec.getPadColumn() &lt;&lt; <span class="stringliteral">&quot;, type=&quot;</span> &lt;&lt; mydec.getModuleType() &lt;&lt; <span class="stringliteral">&quot;, ID=&quot;</span> &lt;&lt; mydec.getModuleID() &lt;&lt; <span class="stringliteral">&quot;, index=&quot;</span> &lt;&lt; mydec.getModuleIndex() &lt;&lt; <span class="stringliteral">&quot;, cell=&quot;</span> &lt;&lt; mydec.getCellID() &lt;&lt; <span class="stringliteral">&quot;, isBad=&quot;</span> &lt;&lt; mydec.isBad() &lt;&lt; std::endl;
<a name="l00455"></a>00455                 } 
<a name="l00456"></a>00456 <span class="preprocessor">#endif</span>
<a name="l00457"></a>00457 <span class="preprocessor"></span>                IMPL::CalorimeterHitImpl *hit=<span class="keyword">new</span> IMPL::CalorimeterHitImpl;
<a name="l00458"></a>00458                 hit-&gt;setCellID0(hit_raw-&gt;getCellID0());
<a name="l00459"></a>00459                 hit-&gt;setCellID1(hit_raw-&gt;getCellID1());
<a name="l00460"></a>00460                 hit-&gt;setTime(hit_raw-&gt;getTimeStamp());
<a name="l00461"></a>00461                 hit-&gt;setEnergy( calibrated_value );
<a name="l00462"></a>00462 
<a name="l00463"></a>00463                 <span class="comment">//FIXME: create a table in the database for the MC with the position of ALL cells saved, instead of using the data mapping...</span>
<a name="l00464"></a>00464                 <span class="keywordflow">if</span> (!_runInfo.isMC()){
<a name="l00465"></a>00465                   hit-&gt;setPosition(_mapping.getPosition(module_index,cell_i).data());
<a name="l00466"></a>00466                 }
<a name="l00467"></a>00467                 <span class="keywordflow">else</span> {<span class="comment">//if MC</span>
<a name="l00468"></a>00468                   <span class="comment">//if (!cell_parameter.isDead()) hit-&gt;setPosition(_mapping.getPosition(module_index,cell_i).data());</span>
<a name="l00469"></a>00469                   <span class="keywordtype">float</span> pos[3] = {0,0,0};
<a name="l00470"></a>00470 
<a name="l00471"></a>00471                   <span class="keywordflow">if</span> ((hit_raw-&gt;getCellID0()&amp;0x80000000)  == 0) {<span class="comment">//signal hit</span>
<a name="l00472"></a>00472                     <span class="comment">//set the link to the initial simhit</span>
<a name="l00473"></a>00473                     <span class="keywordflow">if</span>(col_RawToSim) {
<a name="l00474"></a>00474                       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> rela = 0; rela &lt; col_RawToSim-&gt;getNumberOfElements(); rela++){
<a name="l00475"></a>00475                         <span class="keyword">const</span> LCRelation* rel = (<span class="keyword">const</span> LCRelation*)col_RawToSim-&gt;getElementAt(rela) ;
<a name="l00476"></a>00476                         <span class="keywordflow">if</span> (((RawCalorimeterHit*)rel-&gt;getFrom())-&gt;getCellID0() == hit_raw-&gt;getCellID0()){
<a name="l00477"></a>00477                           assert ((SimCalorimeterHit*)rel-&gt;getTo() != NULL);
<a name="l00478"></a>00478                           hit-&gt;setRawHit((SimCalorimeterHit*)rel-&gt;getTo());
<a name="l00479"></a>00479                           pos[0] = ((SimCalorimeterHit*)rel-&gt;getTo())-&gt;getPosition()[0];
<a name="l00480"></a>00480                           pos[1] = ((SimCalorimeterHit*)rel-&gt;getTo())-&gt;getPosition()[1];
<a name="l00481"></a>00481                           pos[2] = ((SimCalorimeterHit*)rel-&gt;getTo())-&gt;getPosition()[2];
<a name="l00482"></a>00482                         }
<a name="l00483"></a>00483                       }
<a name="l00484"></a>00484                     } <span class="keywordflow">else</span> std::cout &lt;&lt; <span class="stringliteral">&quot;Signal hit but no relation to simhit???? &quot;</span> &lt;&lt; std::endl;
<a name="l00485"></a>00485                   }
<a name="l00486"></a>00486                   <span class="keywordflow">if</span> (isBad == 0) hit-&gt;setPosition(_mapping.getPosition(module_index,cell_i).data());
<a name="l00487"></a>00487                   <span class="keywordflow">else</span> { 
<a name="l00488"></a>00488                     <span class="comment">//If this cell has a valid module index then fill the positions from the mapping</span>
<a name="l00489"></a>00489                     <span class="keywordflow">if</span> (_mapping.isValid(module_index)) hit-&gt;setPosition(_mapping.getPosition(module_index,cell_i).data());
<a name="l00490"></a>00490                     <span class="keywordflow">else</span> {
<a name="l00491"></a>00491                       <span class="comment">//CRP 26/11/15 We have now here a cell that was flagged bad somewhere upstream,</span>
<a name="l00492"></a>00492                       <span class="comment">//maybe because it was physically not there inthe experimental setup but still</span>
<a name="l00493"></a>00493                       <span class="comment">//got simulated. Early CALICE convention to simulate everything</span>
<a name="l00494"></a>00494                       <span class="comment">//This happens for DESY 2005 and CERN 2006/2007  </span>
<a name="l00495"></a>00495                       <span class="comment">//Since the CellID1 has no more any bit free to signal this we choose to modify the Mokka x,y-positions</span>
<a name="l00496"></a>00496                       <span class="comment">//such that for all God&apos;s sake these cells can be easily spotted by the analyser </span>
<a name="l00497"></a>00497                       <span class="keywordtype">float</span> pos_fallback[3] = {0,0,0};
<a name="l00498"></a>00498                       pos_fallback[0] = pos[0] - _fallbackShift;
<a name="l00499"></a>00499                       pos_fallback[1] = pos[1] - _fallbackShift;
<a name="l00500"></a>00500                       pos_fallback[2] = pos[2] - _fallbackShift;
<a name="l00501"></a>00501                       hit-&gt;setPosition(pos_fallback);
<a name="l00502"></a>00502 <span class="preprocessor">#ifdef RECO_DEBUG</span>
<a name="l00503"></a>00503 <span class="preprocessor"></span>                      std::cout &lt;&lt;<span class="stringliteral">&quot;CALICE::CalibrateAndApplyThreshold: Warning fallback shift needed: &quot;</span> &lt;&lt; std::endl; 
<a name="l00504"></a>00504 <span class="preprocessor">#endif</span>
<a name="l00505"></a>00505 <span class="preprocessor"></span>                    }
<a name="l00506"></a>00506                   }
<a name="l00507"></a>00507                   
<a name="l00508"></a>00508                   
<a name="l00509"></a>00509                   <span class="keywordflow">if</span> (col_RawToSim) {<span class="comment">//kkk links hit to simhit</span>
<a name="l00510"></a>00510 
<a name="l00511"></a>00511                        LCRelationNavigator nav_RawToSim(col_RawToSim);
<a name="l00512"></a>00512                        <span class="keyword">const</span> LCObjectVec &amp; vec_hit_sim = nav_RawToSim.getRelatedToObjects(hit_raw);
<a name="l00513"></a>00513                        <span class="keywordflow">if</span> (vec_hit_sim.size() == 1) {
<a name="l00514"></a>00514                             SimCalorimeterHit * hit_sim = <span class="keyword">dynamic_cast&lt;</span>SimCalorimeterHit*<span class="keyword">&gt;</span>(vec_hit_sim[0]);
<a name="l00515"></a>00515                             nav_RecToSim.addRelation(hit, hit_sim);
<a name="l00516"></a>00516                        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vec_hit_sim.size() &gt; 1) {
<a name="l00517"></a>00517                             cout &lt;&lt; <span class="stringliteral">&quot;ERROR vec_hit_sim.size() = &quot;</span> &lt;&lt; vec_hit_sim.size() &lt;&lt; endl;
<a name="l00518"></a>00518                        } <span class="keywordflow">else</span>
<a name="l00519"></a>00519                             <span class="comment">/* kkk: There is no linked simulated hit.            */</span>
<a name="l00520"></a>00520                             <span class="comment">/* This happens.                                     */</span>
<a name="l00521"></a>00521                             <span class="comment">/* Probably noise hits have been added by digitizer. */</span>
<a name="l00522"></a>00522                             ;
<a name="l00523"></a>00523 
<a name="l00524"></a>00524                   } <span class="keywordflow">else</span> { 
<a name="l00525"></a>00525 <span class="preprocessor">#ifdef RECO_DEBUG</span>
<a name="l00526"></a>00526 <span class="preprocessor"></span>                   std::cout &lt;&lt; <span class="stringliteral">&quot;Missing raw to sim relation &quot;</span> &lt;&lt; std::endl;
<a name="l00527"></a>00527 <span class="preprocessor">#endif</span>
<a name="l00528"></a>00528 <span class="preprocessor"></span>                  } 
<a name="l00529"></a>00529 
<a name="l00530"></a>00530 
<a name="l00531"></a>00531                 }<span class="comment">//if MC</span>
<a name="l00532"></a>00532 
<a name="l00533"></a>00533                 col_hit-&gt;addElement(hit);
<a name="l00534"></a>00534 <span class="preprocessor">#ifdef EXPORT_SIGNAL_TO_NOISE_RATIO</span>
<a name="l00535"></a>00535 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (noise !=0) signal_over_noise_ratio.push_back(raw_value/noise);
<a name="l00536"></a>00536 <span class="preprocessor">#endif</span>
<a name="l00537"></a>00537 <span class="preprocessor"></span>              }<span class="comment">//signal</span>
<a name="l00538"></a>00538 
<a name="l00539"></a>00539             <span class="keywordflow">else</span> {<span class="comment">//noise</span>
<a name="l00540"></a>00540             }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542           }<span class="comment">//loop on raw hits</span>
<a name="l00543"></a>00543 <span class="preprocessor">#ifdef EXPORT_SIGNAL_TO_NOISE_RATIO</span>
<a name="l00544"></a>00544 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (col_hit-&gt;getNumberOfElements()&gt;0) {
<a name="l00545"></a>00545           <span class="keywordflow">if</span> (!signal_over_noise_ratio.empty()) col_hit-&gt;parameters().setValues(std::string(<span class="stringliteral">&quot;SN&quot;</span>),signal_over_noise_ratio);
<a name="l00546"></a>00546         }
<a name="l00547"></a>00547 <span class="preprocessor">#endif</span>
<a name="l00548"></a>00548 <span class="preprocessor"></span>          evtP-&gt;addCollection(col_hit,<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a10dd53b4f7d1514791ec6c60329aaea4" title="Name of the hit collection (OUTPUT).">_hitColName</a>);
<a name="l00549"></a>00549           <span class="comment">//}</span>
<a name="l00550"></a>00550           <span class="comment">//else {</span>
<a name="l00551"></a>00551           <span class="comment">//delete col_hit;</span>
<a name="l00552"></a>00552           <span class="comment">//}</span>
<a name="l00553"></a>00553 
<a name="l00554"></a>00554           <span class="keywordflow">if</span> (<a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#aba8a11b61c43b9339e3140839fc5b213" title="kkk flag to disable/enable the creation of an LCRelation to simulated hit">_linkRecToSim</a>) evtP-&gt;addCollection(nav_RecToSim.createLCCollection(), <a class="code" href="classCALICE_1_1CalibrateAndApplyThreshold.html#a6ba0e8c707c10c6ace7b034293d34035" title="kkk: Name of the relation collection hit -&amp;gt; simhit (OUTPUT).">_RecToSimColName</a>);
<a name="l00555"></a>00555 
<a name="l00556"></a>00556 
<a name="l00557"></a>00557       }<span class="comment">//if input col</span>
<a name="l00558"></a>00558 
<a name="l00559"></a>00559     }<span class="comment">//try</span>
<a name="l00560"></a>00560     <span class="keywordflow">catch</span> ( DataNotAvailableException &amp;err ){
<a name="l00561"></a>00561       streamlog_out(DEBUG) &lt;&lt; <span class="stringliteral">&quot;Counting failing events: &quot;</span> &lt;&lt; endl; 
<a name="l00562"></a>00562       _nEventsWithoutRAWHITS++;
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     <span class="comment">//CRP Suppressed firstEvent variable</span>
<a name="l00566"></a>00566     <span class="comment">//firstEvent = false;</span>
<a name="l00567"></a>00567     _nEvt++;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569   }<span class="comment">//processEvt</span>
<a name="l00570"></a>00570 
<a name="l00571"></a>00571   <span class="keywordtype">void</span> CalibrateAndApplyThreshold::end() {
<a name="l00572"></a>00572     std::cout &lt;&lt; <span class="stringliteral">&quot; Processor &quot;</span> &lt;&lt; name() &lt;&lt; <span class="stringliteral">&quot; summary : &quot;</span> &lt;&lt; endl &lt;&lt;
<a name="l00573"></a>00573       <span class="stringliteral">&quot;---&gt; dropped &quot;</span> &lt;&lt; _nEventsWithoutRAWHITS &lt;&lt; <span class="stringliteral">&quot; events without RAW hits,&quot;</span> &lt;&lt; endl &lt;&lt;
<a name="l00574"></a>00574       <span class="stringliteral">&quot;---&gt; found &quot;</span> &lt;&lt; _nEventsWithoutSIMHITS &lt;&lt; <span class="stringliteral">&quot; events without SIM hits,&quot;</span> &lt;&lt; endl &lt;&lt;
<a name="l00575"></a>00575       <span class="stringliteral">&quot;---&gt; Total events processed : &quot;</span> &lt;&lt; _nEvt &lt;&lt; std::endl;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577   }
<a name="l00578"></a>00578 
<a name="l00579"></a>00579 
<a name="l00580"></a>00580 }<span class="comment">//namespace CALICE</span>
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 
<a name="l00583"></a>00583 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Dec 2017 for RAW2CALOHIT by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
